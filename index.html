<script>
(function(){
  'use strict';

  /* ===== 기존 상단 Core/검색/미리보기 코드는 그대로 두세요 ===== */
  /* 이 블록에는 “추출부”만 새로 넣었습니다. 필요 변수 재사용용 최소 헬퍼만 둡니다. */

  // 공통 정규식 토막
  var D='\\d+';
  var JO='제\\s*('+D+')\\s*조(?:\\s*의\\s*('+D+'))?';
  var HANG='(?:\\s*제?\\s*('+D+')\\s*항)?';
  var HO='(?:\\s*제?\\s*('+D+')\\s*호)?';
  var MOK='(?:\\s*([가-힣])\\s*목)?';

  // ★ 인용부호 유무와 상관없이 한 번에 잡는 “슈퍼 패턴”
  //  - 법명: 한글/영문/숫자/점·· 및 공백 + (법|법률|조례|규칙) [+ (시행령|시행규칙)] 까지
  //  - 앞뒤에 「」『』“”"’' 등 어떤 인용부호가 와도 OK (옵션)
  //  - 조문(제n조의m/항/호/목)은 있어도, 없어도 OK
  var SUPER_RE = new RegExp(
    [
      // 열기 인용부호(옵션)
      '[「『“"\']?\\s*',
      // 법명 본체
      '([가-힣A-Za-z0-9·ㆍ\\s]+?(?:법|법률|조례|규칙)(?:\\s*(?:시행령|시행규칙))?)',
      // 닫기 인용부호(옵션)
      '\\s*[」』”"\']?',
      // 조문(옵션)
      '(?:\\s*', JO, HANG, HO, MOK, ')?'
    ].join(''),
    'gu'
  );

  // “같은 법/동법 …” 참조 배제
  function skipCtx(name){
    var s=(name||'').replace(/\s+/g,'');
    return s==='같은법'||s==='동법'||s==='같은법시행령'||s==='동법시행령'||s==='같은법시행규칙'||s==='동법시행규칙';
  }

  // 법명 타당성 최소 필터
  function isLikelyLawName(name){
    var s=(name||'').trim(); if(!s) return false;
    if(/^(법|법률|조례|규칙)$/u.test(s)) return false;
    if(/방법$/u.test(s)) return false; // 제출방법 등 오탐 방지
    var core = s.replace(/\s*(시행령|시행규칙)$/u,'');
    if(!/(법|법률|조례|규칙)$/u.test(core)) return false;
    return core.replace(/(법|법률|조례|규칙)$/u,'').length>=1;
  }

  // 법명 정제(“… 시행령/시행규칙” 결합, 마지막 접미어까지 깔끔히)
  function refineLawName(name){
    var s=(name||'').trim(); if(!s) return s;
    s=s.replace(/^(?:까지|및|또는|등|관련|관한|따른|에\s*따른|에\s*의한|의)\s+/u,'');
    var toks=s.split(/\s+/);
    var last=-1;
    for(var i=toks.length-1;i>=0;i--){
      if(/(법|법률|조례|규칙)$/u.test(toks[i])){ last=i; break; }
    }
    if(last>=0){
      if(toks[last+1] && /^(시행령|시행규칙)$/u.test(toks[last+1])) return toks.slice(0,last+2).join(' ');
      return toks.slice(0,last+1).join(' ');
    }
    return s;
  }

  // 공개용 이름(인용부호 등 제거)
  function cleanDisplay(s){ return (s||'').replace(/[\"“”'‘’\[\]\(\)「」『』]/g,'').trim(); }

  // 🔧 새 추출기
  function extract(text){
    var src=(text||'')
      .replace(/[\u200B-\u200D\uFEFF]/g,'')
      .replace(/[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g,' ')
      .replace(/\s+/g,' ')
      .trim();

    var out=[], seen=new Set();
    SUPER_RE.lastIndex=0; // g 플래그 초기화

    var m;
    while((m=SUPER_RE.exec(src))){
      var nm = refineLawName(cleanDisplay(m[1]||''));
      if(!nm || skipCtx(nm) || !isLikelyLawName(nm)) continue;

      var jo=m[2]||null, joi=m[3]||null, hang=m[4]||null, ho=m[5]||null, mok=m[6]||null;

      // “제 n 조 법명 …” 형태 오탐 방지: 매치 시작 이전 20자 안쪽이 ‘제 n 조’로 끝나면 스킵
      var prev = src.slice(Math.max(0, SUPER_RE.lastIndex - (m[0]||'').length - 20), SUPER_RE.lastIndex - (m[0]||'').length);
      if(/제\s*\d+\s*조\s*$/u.test(prev)) continue;

      var key=[nm,jo||'',joi||'',hang||'',ho||'',mok||''].join('|');
      if(seen.has(key)) continue;
      seen.add(key);

      out.push({name:nm, jo:jo, joi:joi, hang:hang, ho:ho, mok:mok});
    }

    // 같은 이름의 조문/이름-only 동시 존재시, 조문 있는 쪽을 우선
    var withArticle=new Set(out.filter(x=>!!x.jo).map(x=>x.name));
    out=out.filter(x=> x.jo ? true : !withArticle.has(x.name));

    // 이름-only 최종 중복 제거
    var seenNameOnly=new Set();
    out=out.filter(function(x){
      if(x.jo) return true;
      var k='nameonly|'+x.name;
      if(seenNameOnly.has(k)) return false;
      seenNameOnly.add(k);
      return true;
    });

    return out;
  }

  /* ===== 아래부터는 기존 코드의 run()에 이 추출기를 꽂아줍니다 ===== */

  // 전역으로 노출: 기존 run()이 사용
  window.__LAW_EXTRACT__ = extract;

})();
</script>
