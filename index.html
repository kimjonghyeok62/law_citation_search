<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>법조문 자동 추출·검색 (현행 우선 · 조례 강화 · 경기도교육청 우선)</title>
<style>
  :root{--bg:#0b1020; --panel:#0f152b; --muted:#8ea0c7; --line:#1c2748; --accent:#78a6ff; --accent-2:#9ec1ff; --txt:#eaf1ff; --txt-muted:#aab9dd; --radius:14px; --shadow:0 10px 28px rgba(0,0,0,.32)}
  @media (prefers-color-scheme: light){
    :root{ --bg:#f5f7ff; --panel:#fff; --muted:#596180; --line:#e6eaff; --accent:#2e5cff; --accent-2:#4c78ff; --txt:#0c1330; --txt-muted:#5e6a8a; --shadow:0 8px 20px rgba(15,23,52,.08)}
  }
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
  .wrap{max-width:980px;margin:0 auto;padding:28px}
  header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:18px}
  .title{display:flex;flex-direction:column;gap:6px}
  h1{font-size:1.4rem;margin:0;letter-spacing:.2px}
  .sub{font-size:.92rem;color:var(--txt-muted)}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card.pad{padding:16px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

  textarea{width:100%;min-height:120px;height:140px;padding:12px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--txt);resize:vertical;box-sizing:border-box;line-height:1.45;}
  textarea:focus{outline:none;box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 45%, transparent)}

  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .label{font-weight:600;color:var(--txt-muted);font-size:.92rem}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--txt);min-width:260px}
  input::placeholder{color:var(--muted)}
  .btn{padding:10px 14px;border:1px solid transparent;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer;transition:transform .06s ease,opacity .2s}
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:transparent;color:var(--accent);border-color:color-mix(in oklab, var(--accent) 30%, transparent)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:color-mix(in oklab, var(--accent) 14%, transparent);color:var(--accent-2);border:1px solid var(--line);font-size:.8rem}
  .result{margin-top:18px}
  .result h2{margin:0 0 8px;font-size:1.05rem}

  ol{margin:0;padding-left:20px}
  .item{padding:10px 8px;border-top:1px dashed var(--line)}
  .item-line{display:flex;align-items:center;gap:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .t{font-weight:700;flex:0 0 auto}
  .meta{font-size:.86rem;color:var(--txt-muted);flex:0 0 auto}
  .links{display:flex;gap:10px;flex:0 0 auto}
  .links a,.links button{color:var(--accent-2);text-decoration:none;border:1px dashed color-mix(in oklab, var(--accent) 30%, transparent);background:transparent;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:.86rem;}
  .links a:hover,.links button:hover{text-decoration:underline}

  .mini{font-size:.86rem;color:var(--txt-muted)}
  .right{margin-left:auto}
  .toast{position:fixed;right:18px;bottom:18px;display:none;z-index:50}
  .toast.on{display:block}
  .toast .box{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px 14px;min-width:240px}

  .debug{margin-top:18px}
  .debug .head{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .debug .box{background:var(--panel);border:1px dashed var(--line);border-radius:12px;box-shadow:var(--shadow);padding:10px;max-height:240px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.82rem;white-space:pre-wrap}
  .dbg-ok{color:#9ae89a}
  .dbg-warn{color:#ffd683}
  .dbg-err{color:#ff9f9f}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100}
  .modal.on{display:flex}
  .modal .panel{max-width:840px;max-height:80vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  .modal h3{margin:0 0 8px;font-size:1.05rem}
  .modal .close{position:sticky;top:0;float:right;border:none;background:transparent;color:var(--txt-muted);cursor:pointer;font-size:1rem}
  .article-body{line-height:1.6}
  .article-body .hang{margin-left:12px}
  .article-body .ho{margin-left:24px}
  .article-body .mok{margin-left:36px}
  .article-body b{color:var(--accent-2)}
  .article-body .hang > b,.article-body .ho > b,.article-body .mok > b{display:none !important;}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>법조문 자동 추출·검색</h1>
      <div class="sub">본문에서 <b>법령/자치법규</b>를 찾아 <b>조문 미리보기</b>와 <b>전체 본문</b> 링크를 제공합니다. <span class="mini">현행 우선, 없으면 비현행·공개검색까지 폴백</span></div>
    </div>
    <div class="badge">OC: bro3362 · r7</div>
  </header>

  <div class="grid">
    <section class="card pad">
      <div class="row" style="margin-bottom:8px"><div class="label">본문 입력</div></div>
      <textarea id="input" placeholder="예) 「경기도교육청 행정기구 및 정원 조례」 제5조, 「사립학교법」 제43조 …"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="run" class="btn" type="button">추출·검색</button>
        <button id="clear" class="btn secondary" type="button">지우기</button>
        <span class="mini">Enter(⌥/Alt+Enter는 줄바꿈)</span>
        <span class="right mini">응답이 없을 때 프록시 사용됨</span>
      </div>
    </section>

    <aside class="card pad">
      <div class="row" style="margin-bottom:10px"><div class="label">프록시</div></div>
      <input id="proxy" type="text" value="https://law-proxy.hyok96.workers.dev/?url=" style="width:100%"/>
      <div class="mini" style="margin-top:8px">CORS로 본문을 못 읽을 때 자동으로 프록시를 사용합니다.</div>
    </aside>
  </div>

  <section class="card pad result" id="resBox">
    <h2>검색 결과</h2>
    <ol id="resList"></ol>
  </section>

  <section class="card pad debug">
    <div class="head">
      <div class="label">자가 진단 / 로그</div>
      <button id="checkEnv" class="btn secondary" type="button">환경 점검</button>
      <span class="mini">오류나 단계 로그가 여기 표시됩니다.</span>
    </div>
    <div id="dbgBox" class="box" aria-live="polite"></div>
  </section>
</div>

<div id="toast" class="toast"><div class="box mini" id="toastMsg">안내</div></div>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="panel">
    <button class="close" id="modalClose" title="닫기" type="button">✕</button>
    <h3 id="modalTitle">조문 전문</h3>
    <div id="modalBody" class="article-body mini">로딩 중…</div>
  </div>
</div>

<script>
/* ---------- 로그 유틸 ---------- */
var dbg={el:null,
  line:function(m,c){ this.el=this.el||document.getElementById('dbgBox'); var t=new Date().toLocaleTimeString();
    var d=document.createElement('div'); d.className=c||''; d.textContent='['+t+'] '+m; this.el.appendChild(d); this.el.scrollTop=this.el.scrollHeight; },
  ok:function(m){ this.line('✔ '+m,'dbg-ok') },
  warn:function(m){ this.line('⚠ '+m,'dbg-warn') },
  err:function(m){ this.line('✖ '+m,'dbg-err') }
};
window.addEventListener('error',function(e){ dbg.err('onerror: '+e.message+' @'+e.filename+':'+e.lineno) });
window.addEventListener('unhandledrejection',function(e){ dbg.err('unhandledrejection: '+e.reason) });

/* ---------- 공통 ---------- */
var DRF='https://www.law.go.kr/DRF';
var OC='bro3362';
function $(sel){ return document.querySelector(sel); }
function enc(s){ return encodeURIComponent(s); }
function pad(n,w){ return String(parseInt(n,10)).padStart(w,'0'); }
function proxyBase(){
  var pv=$('#proxy'); var v=pv&&pv.value?pv.value.trim():'https://law-proxy.hyok96.workers.dev/?url=';
  return v;
}
function buildURL(p,params){
  var u=new URL(DRF+p);
  var keys=Object.keys(params||{});
  for(var i=0;i<keys.length;i++){
    var k=keys[i]; var v=params[k];
    if(v!=null && v!=='') u.searchParams.set(k,v);
  }
  return u.toString();
}
function withProxy(url,base){
  var b=(base||'https://law-proxy.hyok96.workers.dev/?url=').trim();
  if(b.indexOf('?')===-1) b+=(b.endsWith('/')?'':'/')+'?';
  if(!/(\?|&)url=/.test(b)) b+=(b.indexOf('?')>-1?'':'?')+'url=';
  return b+encodeURIComponent(url);
}
function isFailPage(html){
  return /페이지\s*접속에\s*실패하였습니다|사용자인증에\s*실패하였습니다|페이지를\s*찾을\s*수\s*없습니다/.test((html||'').replace(/\u00A0/g,' '));
}
function publicLawURL(name){ return 'https://www.law.go.kr/법령/'+enc(name); }
function publicOrdinSearchURL(q){ return 'https://www.law.go.kr/ordinSc.do?menuId=3&subMenuId=27&tabMenuId=139&query='+enc(q); }
function buildLawFullHTMLURL(id){
  return buildURL('/lawService.do',{OC:OC,target:'law',type:'HTML',ID:id});
}
function buildOrdinFullHTMLURL(id,mst){
  var p={}; p.OC=OC; p.target='ordin'; p.type='HTML';
  if(mst){ p.MST=mst; } else if(id){ p.ID=id; }
  return buildURL('/lawService.do',p);
}
function joTo6(jo,joi){
  var h=pad(jo,4);
  return joi? h+pad(joi,2) : h+'00';
}
function buildLawArticleURL(id,obj){
  var JO=joTo6(obj.jo,obj.joi);
  var HANG=(obj.hang?pad(obj.hang,6):(obj.ho?'000000':''));
  var HO=(obj.ho?pad(obj.ho,6):'');
  var MOK=(obj.mok?String(obj.mok).trim().slice(0,1).replace(/[^가-힣]/u,''):'');
  var p={}; p.OC=OC; p.target='lawjosub'; p.type='HTML'; p.ID=id; p.JO=JO;
  if(HANG) p.HANG=HANG; if(HO) p.HO=HO; if(MOK) p.MOK=MOK;
  return buildURL('/lawService.do',p);
}
function buildLawArticleXMLURL(id,obj){
  var JO=joTo6(obj.jo,obj.joi);
  var HANG=(obj.hang?pad(obj.hang,6):(obj.ho?'000000':''));
  var HO=(obj.ho?pad(obj.ho,6):'');
  var MOK=(obj.mok?String(obj.mok).trim().slice(0,1).replace(/[^가-힣]/u,''):'');
  var p={}; p.OC=OC; p.target='lawjosub'; p.type='XML'; p.ID=id; p.JO=JO;
  if(HANG) p.HANG=HANG; if(HO) p.HO=HO; if(MOK) p.MOK=MOK;
  return buildURL('/lawService.do',p);
}

async function fetchTextDirectOrProxy(url,opts){
  opts=opts||{}; var timeoutMs=opts.timeoutMs||9000;
  async function fetchWithTimeout(u){
    var ac=new AbortController(); var id=setTimeout(function(){ ac.abort(); }, timeoutMs);
    try{ return await fetch(u,{signal:ac.signal,credentials:'omit'}); }
    finally{ clearTimeout(id); }
  }
  try{
    var r=await fetchWithTimeout(url);
    if(r && r.ok){
      var t=await r.text(); var ct=(r.headers.get('content-type')||'');
      if(ct.indexOf('json')>-1 || t.length>30) return t;
    }
    throw new Error('direct fail');
  }catch(_){
    try{
      var url2=withProxy(url,proxyBase());
      var r2=await fetchWithTimeout(url2);
      if(r2 && r2.ok){
        var t2=await r2.text(); var ct2=(r2.headers.get('content-type')||'');
        if(ct2.indexOf('json')>-1 || t2.length>30) return t2;
      }
      return '';
    }catch(__){ return ''; }
  }
}

/* ---------- 정규화 ---------- */
function canonName(s){ return (s||'').replace(/[\s"“”'‘’\[\]\(\)「」]/g,'').replace(/[·ㆍ]/g,''); }
function refineLawName(name){
  var s=(name||'').trim(); if(!s) return s;
  s=s.replace(/^(?:까지|및|또는|등|관련|관한|따른|에\s*따른|에\s*의한|의)\s+/, '');
  var m=s.match(/^(.*?법(?:률)?)(?:\s*)?(시행령|시행규칙)$/u);
  if(m) return (m[1]+' '+m[2]).trim();
  var toks=s.split(/\s+/); var cut=-1;
  for(var k=toks.length-1;k>=0;k--){ if(/(법|법률|조례|규칙)$/u.test(toks[k])){ cut=k; break; } }
  if(cut>=0){
    if(toks[cut+1] && /^(시행령|시행규칙)$/u.test(toks[cut+1])) return toks.slice(0, cut+2).join(' ').trim();
    return toks.slice(0, cut+1).join(' ').trim();
  }
  return s;
}
function isCurrent(v){ return /현행/u.test((v||'').trim()); }

/* ---------- 국가법령 검색 ---------- */
async function tryLawSearchAll(qCanon,qRaw){
  dbg.ok('[LAW] 검색 시도: '+qRaw);
  function clean(s){ return canonName(refineLawName(s||'')); }
  function pick(rows,preferCurrent){
    if(!rows||!rows.length) return null;
    var want=clean(qCanon);
    var pool=preferCurrent? rows.filter(function(r){return isCurrent(r.status); }) : rows.slice();
    if(preferCurrent && !pool.length) pool=rows.slice();
    var exact=null;
    for(var i=0;i<pool.length;i++){ if(clean(pool[i].name)===want){ exact=pool[i]; break; } }
    return exact || pool[0] || null;
  }
  async function j(){
    var url=buildURL('/lawSearch.do',{OC:OC,target:'law',type:'JSON',query:qRaw,display:10});
    var t=await fetchTextDirectOrProxy(url);
    try{
      var d=JSON.parse(t); var root=d&&(d.LawSearch||d);
      var arr=[]; if(root&&root.law){ arr=Array.isArray(root.law)?root.law:[root.law]; }
      var out=[];
      for(var i=0;i<arr.length;i++){
        var x=arr[i];
        out.push({kind:'law',name:(x.법령명한글||'').trim(),id:(x.법령ID||'').trim(),lsiSeq:(x.법령일련번호||'').trim(),status:(x.법령상태||x.법령상태명||'').trim()});
      }
      return out;
    }catch(_){ return null; }
  }
  async function x(){
    var url=buildURL('/lawSearch.do',{OC:OC,target:'law',type:'XML',query:qRaw,display:10});
    var t=await fetchTextDirectOrProxy(url);
    try{
      var dom=new DOMParser().parseFromString(t,'text/xml');
      var list=[].slice.call(dom.getElementsByTagName('law'));
      var out=[];
      for(var i=0;i<list.length;i++){
        var n=list[i];
        function g(tag){ var el=n.getElementsByTagName(tag)[0]; return el?(el.textContent||'').trim():''; }
        out.push({kind:'law',name:g('법령명한글'),id:g('법령ID'),lsiSeq:g('법령일련번호'),status:(g('법령상태')||g('법령상태명'))});
      }
      return out;
    }catch(_){ return null; }
  }
  async function hDRF(){
    var url=buildURL('/lawSearch.do',{OC:OC,target:'law',type:'HTML',query:qRaw,display:10});
    var t=await fetchTextDirectOrProxy(url);
    try{
      var dom=new DOMParser().parseFromString(t,'text/html');
      var as=[].slice.call(dom.querySelectorAll('a[href*="ID="]'));
      var out=[];
      for(var i=0;i<as.length;i++){
        var a=as[i]; var href=a.getAttribute('href')||''; var m=href.match(/ID=([^&]+)/);
        if(m){ out.push({kind:'law',name:(a.textContent||'').trim(),id:decodeURIComponent(m[1]),lsiSeq:'',status:''}); }
      }
      return out;
    }catch(_){ return null; }
  }
  async function hPublic(){
    var url='https://www.law.go.kr/lsSc.do?menuId=1&subMenuId=15&tabMenuId=81&query='+enc(qRaw);
    var t=await fetchTextDirectOrProxy(url); dbg.warn('[LAW-PUBLIC] 호출 len='+t.length);
    try{
      var dom=new DOMParser().parseFromString(t,'text/html');
      var as=[].slice.call(dom.querySelectorAll('a[href*="ID="]'));
      var out=[];
      for(var i=0;i<as.length;i++){
        var a=as[i]; var href=a.getAttribute('href')||''; var id=(href.match(/ID=([^&]+)/)||[])[1]||'';
        if(id){ out.push({kind:'law',name:(a.textContent||'').trim(),id:decodeURIComponent(id),lsiSeq:'',status:''}); }
      }
      return out;
    }catch(_){ return null; }
  }

  var arr = await j() || await x();
  var chosen = pick(arr||[], true);
  if(chosen){ dbg.ok('[LAW] 선택: '+chosen.name+' (ID:'+chosen.id+')'); return chosen; }
  var arr2 = arr || await x() || await hDRF() || await hPublic() || [];
  var picked = pick(arr2, false);
  if(picked){ dbg.ok('[LAW] 폴백 선택: '+picked.name+' (ID:'+picked.id+')'); }
  else { dbg.warn('[LAW] 결과 없음: '+qRaw); }
  return picked;
}

/* ---------- 자치법규 검색(강화) ---------- */
async function tryOrdinSearchAll(qCanon,qRaw){
  function makeOrdinQueries(s){
    var base = s.trim();
    var spaced1 = base.replace(/관리조례/u,'관리 조례');
    var spaced2 = spaced1.replace(/특별회계소관/u,'특별회계 소관').replace(/교육비특별회계소관/u,'교육비 특별회계 소관');
    var noSogan = spaced2.replace(/\s*소관\s*/u,' ');
    var merge1  = spaced2.replace(/교육비\s*특별회계\s*/u,'');
    var educheong = base.replace(/^경기도교육비특별회계소관/u,'경기도교육청').replace(/교육비특별회계소관/u,'교육청');
    var focus = '경기도교육청 공유재산 관리 조례';
    var generic = '공유재산 관리 조례';
    var uniq={}; var arr=[base,spaced1,spaced2,noSogan,merge1,educheong,focus,generic];
    var out=[]; for(var i=0;i<arr.length;i++){ if(arr[i]&&!uniq[arr[i]]){ uniq[arr[i]]=1; out.push(arr[i]); } }
    return out;
  }
  function score(row,want){
    var s=0;
    if(row.org && /경기도교육청/u.test(row.org)) s+=8;
    if(row.name && /경기도교육청/u.test(row.name)) s+=4;
    if(/공유재산\s*관리\s*조례/u.test(row.name||'')) s+=3;
    if(isCurrent(row.status)) s+=2;
    function clean(z){ return canonName(refineLawName(z||'')); }
    if(clean(row.name)===clean(want)) s+=5;
    return s;
  }
  function pick(rows,preferCurrent){
    if(!rows||!rows.length) return null;
    var pool=rows.slice();
    if(preferCurrent){
      var cur=pool.filter(function(r){ return isCurrent(r.status); });
      if(cur.length) pool=cur;
    }
    pool.sort(function(a,b){ return score(b,qCanon)-score(a,qCanon); });
    return pool[0]||null;
  }

  async function searchOnce(query){
    async function j(){
      var url=buildURL('/lawSearch.do',{OC:OC,target:'ordin',type:'JSON',query:query,display:10});
      var t=await fetchTextDirectOrProxy(url); dbg.warn('[ORDIN-JSON] len='+t.length);
      try{
        var d=JSON.parse(t); var root=d&&(d.OrdinSearch||d);
        var rows=[]; if(root&&root.ordin){ rows=Array.isArray(root.ordin)?root.ordin:[root.ordin]; }
        var out=[];
        for(var i=0;i<rows.length;i++){
          var x=rows[i];
          var name=(x.자치법규명||x.자치법규명한글||x.자치법규명국문||'').trim();
          var id=(x.자치법규ID||x.ID||'').trim(); var mst=(x.자치법규일련번호||x.MST||'').trim();
          var org=(x.지자체명||x.지자체기관명||'').trim(); var status=(x.자치법규상태||x.자치법규상태명||'').trim();
          out.push({kind:'ordin',name:name,id:id,mst:mst,org:org,status:status});
        }
        return out;
      }catch(_){ return null; }
    }
    async function x(){
      var url=buildURL('/lawSearch.do',{OC:OC,target:'ordin',type:'XML',query:query,display:10});
      var t=await fetchTextDirectOrProxy(url); dbg.warn('[ORDIN-XML] len='+t.length);
      try{
        var dom=new DOMParser().parseFromString(t,'text/xml');
        var list=[].slice.call(dom.getElementsByTagName('ordin'));
        var out=[];
        for(var i=0;i<list.length;i++){
          var n=list[i];
          function g(tag){ var el=n.getElementsByTagName(tag)[0]; return el?(el.textContent||'').trim():''; }
          var name=g('자치법규명')||g('자치법규명한글')||g('자치법규명국문');
          var id=g('자치법규ID')||g('ID'); var mst=g('자치법규일련번호')||g('MST');
          var org=g('지자체명')||g('지자체기관명'); var status=g('자치법규상태')||g('자치법규상태명')||g('상태');
          out.push({kind:'ordin',name:name,id:id,mst:mst,org:org,status:status});
        }
        return out;
      }catch(_){ return null; }
    }
    async function hDRF(){
      var url=buildURL('/lawSearch.do',{OC:OC,target:'ordin',type:'HTML',query:query,display:10});
      var t=await fetchTextDirectOrProxy(url); dbg.warn('[ORDIN-HTML] len='+t.length);
      try{
        var dom=new DOMParser().parseFromString(t,'text/html');
        var rows=[].slice.call(dom.querySelectorAll('a'));
        var out=[];
        for(var i=0;i<rows.length;i++){
          var a=rows[i]; var href=a.getAttribute('href')||''; var on=a.getAttribute('onclick')||'';
          var id=((href.match(/ID=([^&]+)/)||[])[1]) || ((on.match(/ID=([^'")&]+)/)||[])[1] || '';
          var mst=((href.match(/MST=([^&]+)/)||[])[1]) || ((on.match(/MST=([^'")&]+)/)||[])[1] || '';
          if(!(id||mst)) continue;
          var name=(a.textContent||'').trim();
          var org=''; var tr=a.closest('tr'); if(tr){ var c=(tr.querySelector('td:nth-child(2)')||{}).textContent||''; org=c.trim(); }
          out.push({kind:'ordin', name:name, id:decodeURIComponent(id||''), mst:decodeURIComponent(mst||''), org:org, status:''});
        }
        return out;
      }catch(_){ return null; }
    }
    async function hPublic(){
      var url='https://www.law.go.kr/ordinSc.do?menuId=3&subMenuId=27&tabMenuId=139&query='+enc(query);
      var t=await fetchTextDirectOrProxy(url); dbg.warn('[ORDIN-PUBLIC] len='+t.length);
      try{
        var dom=new DOMParser().parseFromString(t,'text/html');
        var rows=[].slice.call(dom.querySelectorAll('a'));
        var out=[];
        for(var i=0;i<rows.length;i++){
          var a=rows[i]; var href=a.getAttribute('href')||''; var on=a.getAttribute('onclick')||'';
          var id=((href.match(/ID=([^&]+)/)||[])[1]) || ((on.match(/ID=([^'")&]+)/)||[])[1] || '';
          var mst=((href.match(/MST=([^&]+)/)||[])[1]) || ((on.match(/MST=([^'")&]+)/)||[])[1] || '';
          if(!(id||mst)) continue;
          var name=(a.textContent||'').trim();
          var org=''; var tr=a.closest('tr'); if(tr){ var c=(tr.querySelector('td:nth-child(2)')||{}).textContent||''; org=c.trim(); }
          out.push({kind:'ordin', name:name, id:decodeURIComponent(id||''), mst:decodeURIComponent(mst||''), org:org, status:''});
        }
        return out;
      }catch(_){ return null; }
    }
    return await j() || await x() || await hDRF() || await hPublic() || [];
  }

  var queries = makeOrdinQueries(qRaw);
  dbg.ok('[ORDIN] 검색 시도(변형 '+queries.length+'개): '+queries.join(' | '));

  var best=null;
  for(var qi=0; qi<queries.length; qi++){
    var q=queries[qi];
    var rows = await searchOnce(q);
    if(rows && rows.length){
      var disp=rows.slice(0,3).map(function(r){ return r.name+'['+(r.org||'-')+'] '+(r.id||r.mst||''); }).join(' | ');
      dbg.ok('[ORDIN] '+q+' → 후보 '+rows.length+'건: '+disp);
      var picked = (function(){ var r=rows.slice(); return ( (function(rows){ var p=null; p=(function(rs){ var cur=rs.filter(function(x){return isCurrent(x.status)}); return cur.length?cur:rs; })(rows); p.sort(function(a,b){ return (a===b)?0:0; }); return p; })(rows), (function(rows){ rows.sort(function(a,b){ return 0; }); return null; }), (function(){ var rr=rows.slice(); rr.sort(function(a,b){ return 0; }); return null; })(), (function(){ return (function(rows,prefer){ var pr=rows.slice(); if(prefer){ var c=rows.filter(function(x){return isCurrent(x.status)}); if(c.length) pr=c; } pr.sort(function(a,b){ return ( (a.org&&/경기도교육청/u.test(a.org)?1:0) - (b.org&&/경기도교육청/u.test(b.org)?1:0) ); }); return pr[0]||null; })(rows,true) || (function(rows){ rows.sort(function(a,b){ return 0; }); return rows[0]||null; })(rows); })(); })();
      if(picked){
        dbg.ok('[ORDIN] 선택: '+picked.name+' ['+(picked.org||'-')+'] (ID='+(picked.id||'-')+', MST='+(picked.mst||'-')+')');
        best = picked; break;
      }
    }else{
      dbg.warn('[ORDIN] '+q+' → 결과 0건');
    }
  }
  if(!best) dbg.warn('[ORDIN] 결과 없음: '+qRaw);
  return best;
}

/* ---------- 추출기 ---------- */
(function(){
  'use strict';
  var D='\\d+'; var JO='제\\s*('+D+')\\s*조(?:\\s*의\\s*('+D+'))?'; var HANG='(?:\\s*제?\\s*('+D+')\\s*항)?';
  var HO='(?:\\s*제?\\s*('+D+')\\s*호)?'; var MOK='(?:\\s*([가-힣])\\s*목)?';
  var SUPER_RE=new RegExp(['[「『“"\']?\\s*','([가-힣A-Za-z0-9·ㆍ\\s]+?(?:법|법률|조례|규칙)(?:\\s*(?:시행령|시행규칙))?)','\\s*[」』”"\']?','(?:\\s*',JO,HANG,HO,MOK,')?'].join(''),'gu');
  function skipCtx(name){var s=(name||'').replace(/\s+/g,''); return s==='같은법'||s==='동법'||s==='같은법시행령'||s==='동법시행령'||s==='같은법시행규칙'||s==='동법시행규칙';}
  function isLikelyLawName(name){
    var s=(name||'').trim(); if(!s) return false;
    if(/^(법|법률|조례|규칙)$/u.test(s)) return false; if(/방법$/u.test(s)) return false;
    var core=s.replace(/\s*(시행령|시행규칙)$/u,'');
    if(!/(법|법률|조례|규칙)$/u.test(core)) return false;
    return core.replace(/(법|법률|조례|규칙)$/u,'').length>=1;
  }
  function refineLawName2(name){
    var s=(name||'').trim(); if(!s) return s;
    s=s.replace(/^(?:까지|및|또는|등|관련|관한|따른|에\s*따른|에\s*의한|의)\s+/u,'');
    var toks=s.split(/\s+/); var last=-1;
    for(var i=toks.length-1;i>=0;i--){ if(/(법|법률|조례|규칙)$/u.test(toks[i])){ last=i; break; } }
    if(last>=0){
      if(toks[last+1]&&/^(시행령|시행규칙)$/u.test(toks[last+1])) return toks.slice(0,last+2).join(' ');
      return toks.slice(0,last+1).join(' ');
    }
    return s;
  }
  function cleanDisplay(s){ return (s||'').replace(/[\"“”'‘’\[\]\(\)「」『』]/g,'').trim(); }
  window.__LAW_EXTRACT__=function(text){
    var src=(text||'').replace(/[\u200B-\u200D\uFEFF]/g,'').replace(/[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g,' ').replace(/\s+/g,' ').trim();
    var out=[], seen={}; SUPER_RE.lastIndex=0; var m;
    while((m=SUPER_RE.exec(src))){
      var nm=refineLawName2(cleanDisplay(m[1]||'')); if(!nm||skipCtx(nm)||!isLikelyLawName(nm)) continue;
      var jo=m[2]||null, joi=m[3]||null, hang=m[4]||null, ho=m[5]||null, mok=m[6]||null;
      var prev=src.slice(Math.max(0,SUPER_RE.lastIndex-(m[0]||'').length-20), SUPER_RE.lastIndex-(m[0]||'').length); if(/제\s*\d+\s*조\s*$/u.test(prev)) continue;
      var key=[nm,jo||'',joi||'',hang||'',ho||'',mok||''].join('|'); if(seen[key]) continue; seen[key]=1;
      out.push({name:nm, jo:jo, joi:joi, hang:hang, ho:ho, mok:mok});
    }
    var withArticle={}; for(var i=0;i<out.length;i++){ if(out[i].jo){ withArticle[out[i].name]=1; } }
    var filtered=[]; var seenNameOnly={};
    for(var j=0;j<out.length;j++){
      var x=out[j];
      if(x.jo){ filtered.push(x); continue; }
      if(withArticle[x.name]) continue;
      var k='nameonly|'+x.name; if(seenNameOnly[k]) continue; seenNameOnly[k]=1; filtered.push(x);
    }
    dbg.ok('[EXTRACT] 후보 '+filtered.length+'건: '+ filtered.map(function(o){return o.name+(o.jo?(' 제'+o.jo+'조'+(o.joi?('의'+o.joi):'')):'');}).join(' · '));
    return filtered;
  };
})();

/* ---------- 라우팅 ---------- */
function classifyKind(name){
  var s=(name||'').trim();
  if (/(조례|규칙)\s*(시행규칙)?$/u.test(s)) return 'ordin';
  if (/(법|법률)\s*(시행령|시행규칙)?$/u.test(s)) return 'law';
  if (/교육청|시청|군청|구청|도의회|시의회|구의회/u.test(s)) return 'ordin';
  return 'law';
}
function hasOrdinHint(name){ return /(조례|규칙)/u.test(name||''); }

async function searchOneCitation(it){
  var firstKind = classifyKind(it.name);
  dbg.ok('[ROUTE] '+it.name+' → '+firstKind.toUpperCase());
  var row=null;
  if(firstKind==='ordin'){ row=await tryOrdinSearchAll(it.name,it.name); if(!row) row=await tryLawSearchAll(it.name,it.name); }
  else { row=await tryLawSearchAll(it.name,it.name); if(!row && hasOrdinHint(it.name)) row=await tryOrdinSearchAll(it.name,it.name); }
  var kind = row ? row.kind : (firstKind==='ordin'?'ordin':'law');
  return {row:row, kind:kind, cite:it};
}

/* ---------- 미리보기 / 조례 조문 선택 & 새 탭 열기 ---------- */
function sanitize(html){return (html||'').replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,'');}

function extractJoKey(raw){
  var s=(raw||'').replace(/\s+/g,'').replace(/^제/,'');
  var m=s.match(/(\d+)\s*조(?:의(\d+))?/);
  if(!m) return '';
  return m[1]+(m[2] ? '의'+m[2] : '');
}
function wantKeyFrom(jo,joi){
  return String(parseInt(jo,10)) + (joi? ('의'+String(parseInt(joi,10))) : '');
}

async function fetchOrdinAndPickTry(id, mst, jo, joi){
  function buildXMLUrl(key,val){
    var p={}; p.OC=OC; p.target='ordin'; p.type='XML'; p[key]=val;
    return buildURL('/lawService.do', p);
  }
  var targets=[]; if(id) targets.push({k:'ID',v:id}); if(mst) targets.push({k:'MST',v:mst});
  var lastErr=null; var wantKey=wantKeyFrom(jo, joi);
  for(var ti=0; ti<targets.length; ti++){
    var t=targets[ti];
    try{
      dbg.ok('[ORDIN-XML] 요청: '+t.k+'='+t.v+' / 조문='+jo+(joi?('의'+joi):''));
      var xmlText=await fetchTextDirectOrProxy(buildXMLUrl(t.k, t.v));
      dbg.warn('[ORDIN-XML] 응답 길이: '+xmlText.length);
      if(!xmlText){ lastErr = new Error('empty xml'); continue; }
      var dom=new DOMParser().parseFromString(xmlText,'text/xml');
      var nodes=[].slice.call(dom.getElementsByTagName('조문'));
      dbg.warn('[ORDIN-XML] 조문 노드 수: '+nodes.length);
      if(!nodes.length){ lastErr = new Error('no articles'); continue; }

      var picked=null;
      for(var i=0;i<nodes.length;i++){
        var n=nodes[i];
        var raw=(n.getElementsByTagName('조문번호')[0]||{}).textContent||'';
        var key=extractJoKey(raw);
        if(key===wantKey){ picked=n; break; }
      }
      if(!picked){
        for(var j=0;j<nodes.length;j++){
          var n2=nodes[j]; var raw2=(n2.getElementsByTagName('조문번호')[0]||{}).textContent||'';
          var key2=extractJoKey(raw2);
          if(key2===String(parseInt(jo,10))){ picked=n2; break; }
        }
      }
      if(!picked){ lastErr=new Error('target article not found'); dbg.warn('[ORDIN-XML] 매칭 실패 want='+wantKey); continue; }

      function get(tag,node){ node=node||picked; var el=node.getElementsByTagName(tag)[0]; return el? (el.textContent||'').trim() : ''; }
      var body=get('조내용'); var title=get('조제목')||get('조문번호')||'';
      var parts=[];
      var hangs=[].slice.call(picked.getElementsByTagName('항'));
      for(var h=0; h<hangs.length; h++){
        var ht=(hangs[h].getElementsByTagName('항내용')[0]||{}).textContent||''; if(ht) parts.push('<div class="hang">'+sanitize(ht.trim())+'</div>');
        var hos=[].slice.call(hangs[h].getElementsByTagName('호'));
        for(var ho=0; ho<hos.length; ho++){
          var hot=(hos[ho].getElementsByTagName('호내용')[0]||{}).textContent||''; if(hot) parts.push('<div class="ho">'+sanitize(hot.trim())+'</div>');
          var moks=[].slice.call(hos[ho].getElementsByTagName('목'));
          for(var mk=0; mk<moks.length; mk++){ var mkTxt=(moks[mk].textContent||'').trim(); if(mkTxt) parts.push('<div class="mok">'+sanitize(mkTxt)+'</div>'); }
        }
      }
      var articleBodyRaw = body ? ('<div>'+sanitize(body)+'</div>') : '';
      return { ok:true, data:{ title:title, articleBodyRaw:articleBodyRaw+parts.join(''), hangs:[] } };
    }catch(err){ lastErr = err; dbg.warn('[ORDIN-XML] 실패: '+err); continue; }
  }
  return { ok:false, error:lastErr||new Error('ordin xml fetch failed') };
}

function openOrdinArticleInNewTab(lawName, fullHTMLUrl, jo, joi){
  fetchTextDirectOrProxy(fullHTMLUrl).then(function(html){
    var key = joi ? (String(parseInt(jo,10))+'의'+String(parseInt(joi,10))) : String(parseInt(jo,10));
    var innerScript =
      'var key="'+key+'";'
      +'(function(){'
      +'  var body=document.getElementById("content"); if(!body) return; '
      +'  var txts=[ "제"+key+"조", "제'+String(parseInt(jo,10))+'조" ];'
      +'  var found=null;'
      +'  var walker,node;'
      +'  for(var i=0;i<txts.length;i++){'
      +'    walker=document.createTreeWalker(body, NodeFilter.SHOW_TEXT,null);'
      +'    while(node=walker.nextNode()){ if(node.nodeValue.indexOf(txts[i])>-1){ found=node; break; } }'
      +'    if(found) break;'
      +'  }'
      +'  if(found){'
      +'    var mark = (found.nodeValue.indexOf(txts[0])>-1)?txts[0]:txts[1];'
      +'    var idx=found.nodeValue.indexOf(mark);'
      +'    var span=document.createElement("span"); span.className="hit"; span.textContent=found.nodeValue.slice(idx, idx+mark.length);'
      +'    var before=document.createTextNode(found.nodeValue.slice(0,idx));'
      +'    var after=document.createTextNode(found.nodeValue.slice(idx+mark.length));'
      +'    var parent=found.parentNode; parent.insertBefore(before,found); parent.insertBefore(span,found); parent.insertBefore(after,found); parent.removeChild(found);'
      +'    span.scrollIntoView({behavior:"smooth",block:"center"});'
      +'  }'
      +'})();';

    var doc = '<!doctype html><html><head><meta charset="utf-8"><title>'+lawName+' - 조문 보기</title>'
      +'<style>body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;line-height:1.6;padding:20px} .hit{background:rgba(120,166,255,.2);padding:2px 4px;border-radius:6px}</style></head><body>'
      +'<div style="margin-bottom:14px"><a href="'+fullHTMLUrl+'" target="_blank" rel="noopener">원문 전체 열기 ↗</a> · '
      +'<b>'+lawName+' 제'+jo+(joi?('의'+joi):'')+'조</b></div>'
      +'<div id="content">'+sanitize(html)+'</div>'
      +'<script>'+innerScript+'</scr'+'ipt></body></html>';

    var blob=new Blob([doc],{type:'text/html'});
    var win=window.open(URL.createObjectURL(blob),'_blank','noopener');
    if(!win){ alert('팝업이 차단되었습니다. 새 탭 허용을 확인해 주세요.'); }
  });
}

async function fetchArticleXML(urlXML){
  try{
    dbg.ok('[LAW-XML] 요청: '+urlXML);
    var xmlText=await fetchTextDirectOrProxy(urlXML);
    dbg.warn('[LAW-XML] 응답 길이: '+xmlText.length);
    if(!xmlText){ dbg.warn('[LAW-XML] 빈 응답'); return null; }
    var dom=new DOMParser().parseFromString(xmlText,'text/xml');
    function get(tag,node){ node=node||dom; var el=node.getElementsByTagName(tag)[0]; return el? (el.textContent||'').trim() : ''; }
    var title=get('조문제목')||'';
    var body=get('조문내용')||'';
    var hasHang = dom.getElementsByTagName('항').length;
    dbg.ok('[LAW-XML] 제목존재='+(!!title)+' 본문존재='+(!!body)+' 항개수='+hasHang);
    if(!title && !body){
      var htmlUrl = urlXML.replace(/type=XML/i,'type=HTML');
      dbg.warn('[LAW-HTML] 폴백 요청: '+htmlUrl);
      var html = await fetchTextDirectOrProxy(htmlUrl);
      dbg.warn('[LAW-HTML] 응답 길이: '+html.length);
      if(html){
        var clean = html.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,'');
        return {title:'', articleBodyRaw:clean, hangs:[]};
      }
      return null;
    }
    var hangsNodes=[].slice.call(dom.getElementsByTagName('항'));
    var hangs=[];
    for(var i=0;i<hangsNodes.length;i++){
      var h=hangsNodes[i];
      var ht=(h.getElementsByTagName('항내용')[0]||{}).textContent; ht=ht? ht.trim():'';
      var hoNodes=[].slice.call(h.getElementsByTagName('호'));
      var hos=[];
      for(var j=0;j<hoNodes.length;j++){
        var ho=hoNodes[j];
        var hot=(ho.getElementsByTagName('호내용')[0]||{}).textContent; hot=hot? hot.trim():'';
        var mokNodes=[].slice.call(ho.getElementsByTagName('목'));
        var moks=[]; for(var k=0;k<mokNodes.length;k++){ moks.push((mokNodes[k].textContent||'').trim()); }
        hos.push({hoText:hot, moks:moks});
      }
      hangs.push({hTitle:ht, hos:hos});
    }
    return {title:title, articleBodyRaw:body, hangs:hangs};
  }catch(err){ dbg.warn('[LAW-XML] 파싱 실패: '+err); return null; }
}

/* ---------- 렌더 ---------- */
function toast(msg,ms){ ms=ms||2200; var el=$('#toast'); var t=$('#toastMsg'); if(t) t.textContent=msg; if(el){ el.classList.add('on'); setTimeout(function(){el.classList.remove('on')},ms); } }
function skeleton(n){ n=n||2; var arr=[]; for(var i=0;i<n;i++){ arr.push('<li class="item"><div class="sk-line skeleton" style="width:58%"></div><div class="sk-gap"></div><div class="sk-line skeleton" style="width:32%"></div></li>'); } return arr.join(''); }

function appendResult(listEl, payload){
  var title=payload.title, kind=payload.kind, lawId=payload.lawId, lsiSeq=payload.lsiSeq, mst=payload.mst, articleURL=payload.articleURL, fullURL=payload.fullURL, lawName=payload.lawName, joText=payload.joText;

  var linkHtml='';
  if(joText){
    linkHtml += '① <button type="button" class="preview-btn">'+(kind==='law'?'조문 미리보기':'조문 미리보기(조례)')+'</button> · ';
    if(kind==='law'){
      linkHtml += '② <a class="go-article" href="'+articleURL+'" target="_blank" rel="noopener">조문 바로가기</a> · ';
    }else{
      if(lawId||mst){
        linkHtml += '② <button type="button" class="go-ordin">조문 바로가기(조례 전용)</button> · ';
      }else{
        linkHtml += '② <a class="go-ordin-public" href="'+publicOrdinSearchURL(lawName+' 제'+parseInt(joText.jo,10)+(joText.joi?('의'+parseInt(joText.joi,10)):'')+'조')+'" target="_blank" rel="noopener">공개검색에서 보기</a> · ';
      }
    }
  }
  linkHtml += '③ <a class="go-full" href="'+(lawId||mst?fullURL: (kind==='law'?publicLawURL(lawName):publicOrdinSearchURL(lawName)))+'" target="_blank" rel="noopener">'+(kind==='law'?'법령 전체':'자치법규 전체')+'</a>';

  var li=document.createElement('li'); li.className='item';
  li.innerHTML='<div class="item-line">'
      +'<span class="t">'+title+'</span>'
      +(kind==='law'
        ? (lawId ? '<span class="meta">법령ID: '+lawId+(lsiSeq?(' · 일련번호: '+lsiSeq):'')+'</span>' : '<span class="meta">법령ID 미확인</span>')
        : ((lawId||mst) ? '<span class="meta">자치법규ID: '+(lawId||'-')+(mst?(' · 일련번호: '+mst):'')+'</span>' : '<span class="meta">자치법규ID 미확인</span>')
       )
      +'<span class="links">'+linkHtml+'</span>'
    +'</div>';

  try{
    if(joText){
      if(kind==='law'){
        var a=li.querySelector('.go-article');
        if(a){
          a.addEventListener('click', function(e){
            e.preventDefault();
            var url=a.getAttribute('href');
            fetchTextDirectOrProxy(url).then(function(html){
              if(html && !isFailPage(html)) window.open(url,'_blank','noopener');
              else window.open(publicLawURL(title.split(' 제')[0]),'_blank','noopener');
            });
          });
        }
      }else{
        var go2=li.querySelector('.go-ordin');
        if(go2){
          go2.addEventListener('click', function(){
            if(!(lawId||mst)){ window.open(publicOrdinSearchURL(lawName),'_blank','noopener'); return; }
            var fullHTML = buildOrdinFullHTMLURL(lawId, mst);
            openOrdinArticleInNewTab(lawName, fullHTML, joText.jo, joText.joi);
          });
        }
      }

      var btn=li.querySelector('.preview-btn');
      if(btn){
        btn.addEventListener('click', async function(){
          btn.disabled=true; btn.textContent='불러오는 중…';
          try{
            var data=null;
            if(kind==='law'){
              var xmlURL=buildLawArticleXMLURL(lawId, joText);
              data=await fetchArticleXML(xmlURL);
            }else{
              var pickRes = await fetchOrdinAndPickTry(lawId||'', mst||'', joText.jo || 1, joText.joi||null);
              if (!pickRes.ok){ dbg.warn('[ORDIN-XML] 미리보기 실패: '+pickRes.error); }
              data = pickRes.ok ? pickRes.data : null;
            }
            if(!data){ toast('조문 전문을 불러오지 못했습니다. (로그 참조)'); }
            else{
              var joLabel=title.replace(lawName,'').trim();
              renderArticlePreview({lawName:lawName, joLabel:joLabel, data:data});
            }
          }catch(e){ console.error(e); toast('미리보기 중 오류'); }
          finally { btn.disabled=false; btn.textContent=(kind==='law'?'조문 미리보기':'조문 미리보기(조례)'); }
        });
      }
    }
  }catch(e){ console.error('bind error:', e); }

  listEl.appendChild(li);
}

function renderArticlePreview(opts){
  var lawName=opts.lawName, joLabel=opts.joLabel, data=opts.data;
  var modal=$('#modal'), body=$('#modalBody'), titleEl=$('#modalTitle');
  if(titleEl) titleEl.textContent = lawName+' '+joLabel+' (전문)';
  var html='';
  if(data.articleBodyRaw){ html+= data.articleBodyRaw; }
  if(data.hangs && data.hangs.length){
    var parts=[];
    for(var i=0;i<data.hangs.length;i++){
      var h=data.hangs[i];
      if(h.hTitle) parts.push('<div class="hang">'+ sanitize(h.hTitle)+'</div>');
      if(h.hos && h.hos.length){
        for(var j=0;j<h.hos.length;j++){
          var ho=h.hos[j];
          if(ho.hoText) parts.push('<div class="ho">'+ sanitize(ho.hoText)+'</div>');
          if(ho.moks && ho.moks.length){
            for(var k=0;k<ho.moks.length;k++){ parts.push('<div class="mok">'+ sanitize(ho.moks[k])+'</div>'); }
          }
        }
      }
    }
    html+=parts.join('');
  }
  if(!html) html='<div class="mini">조문 본문을 불러오지 못했습니다.</div>';
  if(body) body.innerHTML=html;
  if(modal) modal.classList.add('on');
}

/* ---------- 실행 ---------- */
async function run(){
  var input=$('#input'); var resUl=$('#resList');
  if(resUl) resUl.innerHTML='';
  var text=input? (input.value||'') : '';
  if(!text.trim()){ toast('본문을 입력해 주세요'); return; }
  if(resUl) resUl.innerHTML=skeleton(2);

  try{
    var cites=window.__LAW_EXTRACT__(text);
    if(!cites.length){
      if(resUl) resUl.innerHTML='<li class="item mini">인식 가능한 법령/자치법규명 또는 조문을 찾지 못했습니다. · 예: 「사립학교법」 제43조, 「경기도교육청 행정기구 및 정원 조례」 제5조</li>';
      return;
    }

    var promises=[]; for(var i=0;i<cites.length;i++){ promises.push(searchOneCitation(cites[i])); }
    var results = await Promise.allSettled(promises);
    if(resUl) resUl.innerHTML='';

    for(var r=0;r<results.length;r++){
      try{
        var st=results[r]; if(st.status!=='fulfilled') continue;
        var value=st.value; var row=value.row; var kind=value.kind; var it=value.cite;
        var lawName=it.name;
        var title= it.jo ? (lawName+' 제'+parseInt(it.jo,10)+(it.joi?('의'+parseInt(it.joi,10)):'')+'조') : lawName;

        if(row){
          if(row.kind==='law'){
            var fullURL=buildLawFullHTMLURL(row.id);
            var articleURL=it.jo ? buildLawArticleURL(row.id,it) : '';
            appendResult(resUl,{kind:'law',title:title,lawId:row.id,lsiSeq:row.lsiSeq,mst:'',articleURL:articleURL,fullURL:fullURL,lawName:lawName,joText:it.jo?it:null});
          }else{
            var fullURL2=buildOrdinFullHTMLURL(row.id,row.mst)||publicOrdinSearchURL(lawName);
            appendResult(resUl,{kind:'ordin',title:title,lawId:row.id,lsiSeq:'',mst:row.mst,articleURL:'',fullURL:fullURL2,lawName:lawName,joText:it.jo?it:null});
          }
        }else{
          var isOrdin=(kind==='ordin')||hasOrdinHint(lawName);
          var fullURL3=isOrdin?publicOrdinSearchURL(lawName):publicLawURL(lawName);
          dbg.warn('[NO-ID] 공개검색 링크로 대체: '+title);
          appendResult(resUl,{kind:isOrdin?'ordin':'law',title:title,lawId:'',lsiSeq:'',mst:'',articleURL:'',fullURL:fullURL3,lawName:lawName,joText:it.jo?it:null});
        }
      }catch(itemErr){ console.error('render item error:', itemErr); }
    }
  }catch(e){
    console.error('run error:', e);
    if(resUl) resUl.innerHTML='<li class="item mini">처리 중 오류가 발생했습니다. 입력을 다시 시도해 주세요.</li>';
    toast('오류가 발생했습니다. 콘솔을 확인해 주세요.');
  }
}

/* ---------- 바인딩 / 점검 ---------- */
function bind(){
  var runBtn=$('#run'); if(runBtn){ runBtn.addEventListener('click', run); }
  var clearBtn=$('#clear'); if(clearBtn){ clearBtn.addEventListener('click', function(){ var resUl = $('#resList'); if(resUl) resUl.innerHTML = ''; var input = $('#input'); if(input){ input.value = ''; input.focus(); } }); }
  var input=$('#input'); if(input){ input.addEventListener('keydown', function(e){ if(e.key==='Enter' && !e.altKey && !e.shiftKey && !e.ctrlKey){ e.preventDefault(); run(); } }); }
  var closeBtn=$('#modalClose'); if(closeBtn){ closeBtn.addEventListener('click', function(){ var m=$('#modal'); if(m) m.classList.remove('on'); }); }
  var modal=$('#modal'); if(modal){ modal.addEventListener('click', function(e){ if(e.target && e.target.id==='modal'){ modal.classList.remove('on'); } }); }

  var checkBtn=$('#checkEnv');
  if(checkBtn){
    checkBtn.addEventListener('click', async function(){
      dbg.ok('—— 환경 점검 시작 (r7) ——');
      try{
        var testText='사립학교법 제2조\n경기도교육청 공유재산 관리 조례 제9조의2';
        var arr=window.__LAW_EXTRACT__(testText);
        dbg.ok('추출기 OK: '+arr.map(function(a){return a.name;}).join(' / '));
      }catch(e){ dbg.err('추출기 오류: '+e); }

      try{
        var url1=buildURL('/lawSearch.do',{OC:OC,target:'law',type:'JSON',query:'사립학교법',display:1});
        var t1=await fetchTextDirectOrProxy(url1); JSON.parse(t1); dbg.ok('DRF(JSON, 법) 통신 OK');
      }catch(e){ dbg.err('DRF(JSON, 법) 오류: '+e); }

      try{
        var url2=buildURL('/lawSearch.do',{OC:OC,target:'ordin',type:'JSON',query:'경기도교육청 공유재산 관리 조례',display:1});
        var t2=await fetchTextDirectOrProxy(url2); JSON.parse(t2); dbg.ok('DRF(JSON, 조례) 통신 OK');
      }catch(e){ dbg.err('DRF(JSON, 조례) 오류: '+e); }

      try{
        var p=withProxy('https://example.com'); if(!/url=/.test(p)) throw new Error('format'); dbg.ok('프록시 포맷 OK');
      }catch(e){ dbg.err('프록시 포맷 오류: '+e); }

      dbg.ok('—— 환경 점검 종료 ——');
    });
  }

  dbg.ok('바인딩 완료');
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', bind); } else { bind(); }
</script>
</body>
</html>
