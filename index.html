<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>법조문 자동 추출·검색 (자치법규 무공백 · 조문점프 · 한글주소 직링크)</title>
<style>
  :root{--bg:#f5f7ff; --panel:#fff; --muted:#596180; --line:#e6eaff; --accent:#2e5cff; --accent-2:#4c78ff; --txt:#0c1330; --txt-muted:#5e6a8a; --radius:14px; --shadow:0 8px 20px rgba(15,23,52,.08)}
  @media (prefers-color-scheme: dark){ :root{--bg:#0b1020; --panel:#0f152b; --muted:#8ea0c7; --line:#1c2748; --accent:#78a6ff; --accent-2:#9ec1ff; --txt:#eaf1ff; --txt-muted:#aab9dd; --shadow:0 10px 28px rgba(0,0,0,.32)} }
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
  .wrap{max-width:1080px;margin:0 auto;padding:28px}
  header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:18px}
  .title{display:flex;flex-direction:column;gap:6px}
  h1{font-size:1.45rem;margin:0;letter-spacing:.2px}
  .sub{font-size:.92rem;color:var(--txt-muted)}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card.pad{padding:16px}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  textarea{width:100%;min-height:120px;height:150px;padding:12px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--txt);resize:vertical;box-sizing:border-box;line-height:1.5}
  textarea:focus{outline:none;box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 45%, transparent)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .label{font-weight:600;color:var(--txt-muted);font-size:.92rem}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--txt);min-width:260px}
  input::placeholder{color:var(--muted)}
  .btn{padding:10px 14px;border:1px solid transparent;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer;transition:transform .06s ease,opacity .2s}
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:transparent;color:var(--accent);border-color:color-mix(in oklab, var(--accent) 30%, #0000)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:color-mix(in oklab, var(--accent) 14%, transparent);color:var(--accent-2);border:1px solid var(--line);font-size:.8rem}
  .result{margin-top:18px}
  .result h2{margin:0 0 8px;font-size:1.05rem}
  ol{margin:0;padding-left:20px}
  .item{padding:10px 8px;border-top:1px dashed var(--line)}
  .item-line{display:flex;align-items:center;gap:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .t{font-weight:700;flex:0 0 auto}
  .meta{font-size:.86rem;color:var(--txt-muted);flex:0 0 auto}
  .links{display:flex;gap:10px;flex:0 0 auto}
  .links a,.links button{color:var(--accent-2);text-decoration:none;border:1px dashed color-mix(in oklab, var(--accent) 30%, transparent);background:transparent;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:.86rem}
  .links a:hover,.links button:hover{text-decoration:underline}
  .mini{font-size:.86rem;color:var(--txt-muted)}
  .right{margin-left:auto}
  .toast{position:fixed;right:18px;bottom:18px;display:none;z-index:50}
  .toast.on{display:block}
  .toast .box{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px 14px;min-width:240px}
  .skeleton{background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.14), rgba(255,255,255,.06));background-size:200% 100%;animation:shimmer 1.1s infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .sk-line{height:14px;border-radius:6px;opacity:.45}
  .sk-gap{height:10px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100}
  .modal.on{display:flex}
  .modal .panel{max-width:840px;max-height:80vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  .modal h3{margin:0 0 8px;font-size:1.05rem}
  .modal .close{position:sticky;top:0;float:right;border:none;background:transparent;color:var(--txt-muted);cursor:pointer;font-size:1rem}
  .article-body{line-height:1.6;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>법조문 자동 추출·검색</h1>
      <div class="sub">본문에서 <b>법령·자치법규</b>를 찾아 <b>조문 미리보기</b>·<b>바로가기</b>와 <b>전체 본문</b> 링크를 제공합니다. <span class="mini">(같은법/동법 제외)</span></div>
    </div>
    <div class="badge">OC: bro3362</div>
  </header>

  <div class="grid">
    <section class="card pad">
      <div class="row" style="margin-bottom:8px"><div class="label">본문 입력</div></div>
      <textarea id="input" placeholder="예) 조례는 「경기도교육비특별회계 소관 공유재산 관리조례」 제3조에 따라 …"></textarea>
      <div class="row" style="margin-top:10px">
        <!-- 폴백: 바인딩 실패해도 실행되도록 onclick 추가 -->
        <button id="run" class="btn" type="button" onclick="window.__RUN && window.__RUN()">추출·검색</button>
        <button id="clear" class="btn secondary" type="button">지우기</button>
        <span class="mini">Enter(Shift+Enter는 줄바꿈)</span>
        <span class="right mini">응답이 없을 때 프록시 사용됨</span>
      </div>
    </section>

    <aside class="card pad">
      <div class="row" style="margin-bottom:10px"><div class="label">프록시</div></div>
      <input id="proxy" type="text" value="https://law-proxy.hyok96.workers.dev/?url=" style="width:100%"/>
      <div class="mini" style="margin-top:8px">CORS로 본문을 못 읽을 때 자동으로 프록시를 사용합니다.</div>
    </aside>
  </div>

  <section class="card pad result" id="resBox">
    <h2>검색 결과</h2>
    <ol id="resList"></ol>
  </section>
</div>

<div id="toast" class="toast"><div class="box mini" id="toastMsg">안내</div></div>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="panel">
    <button class="close" id="modalClose" title="닫기" type="button">✕</button>
    <h3 id="modalTitle">조문 전문</h3>
    <div id="modalBody" class="article-body mini">로딩 중…</div>
  </div>
</div>

<script>
(function(){
  'use strict';

  /* ===== Core ===== */
  var DRF='https://www.law.go.kr/DRF';
  var OC='bro3362';
  var $=function(sel){return document.querySelector(sel)};
  var enc=function(s){return encodeURIComponent(s)};
  var pad=function(n,w){return String(parseInt(n||0,10)).padStart(w,'0')};

  var proxyBase=function(){
    var pv=$('#proxy');
    var v=pv && pv.value ? pv.value.trim() : 'https://law-proxy.hyok96.workers.dev/?url=';
    return v;
  };
  var buildURL=function(p,params){
    var u=new URL(DRF+p);
    Object.keys(params).forEach(function(k){
      var v=params[k]; if(v!=null&&v!=='') u.searchParams.set(k,v)
    });
    return u.toString();
  };
  var withProxy=function(url,base){
    var b=(base||'https://law-proxy.hyok96.workers.dev/?url=').trim();
    if(b.indexOf('?')===-1) b+=(b.endsWith('/')?'':'/')+'?';
    if(!/\burl=/.test(b)) b+='url=';
    return b+encodeURIComponent(url);
  };

  function fetchTextDirectOrProxy(url,opts){
    opts=opts||{}; var timeoutMs=opts.timeoutMs||9000;
    var fetchWithTimeout=function(u){
      var ac=new AbortController(); var id=setTimeout(function(){ac.abort()},timeoutMs);
      return fetch(u,{signal:ac.signal}).finally(function(){clearTimeout(id)});
    };
    return fetchWithTimeout(url).then(async function(r){
      if(r.ok){
        var t=await r.text(); var ct=(r.headers.get('content-type')||'');
        if(ct.indexOf('json')>-1 || ct.indexOf('xml')>-1 || t.length>30) return t;
      }
      throw new Error('direct fail');
    }).catch(function(){
      return fetchWithTimeout(withProxy(url,proxyBase())).then(async function(r2){
        if(r2.ok){
          var t2=await r2.text(); var ct2=(r2.headers.get('content-type')||'');
          if(ct2.indexOf('json')>-1 || ct2.indexOf('xml')>-1 || t2.length>30) return t2;
        }
        return '';
      }).catch(function(){return ''});
    });
  }

  /* ===== 공개 페이지 링크 ===== */
  var publicLawURL = function(name){ return 'https://www.law.go.kr/법령/'+enc(name) };
  var publicLawArticleKoURL=function(name,obj){
    var jo=parseInt(obj.jo,10); var joi=obj.joi? parseInt(obj.joi,10) : null;
    var label='제'+jo+'조'+(joi?('의'+joi):'');
    return 'https://www.law.go.kr/법령/'+enc(name)+'/'+enc(label);
  };
  var publicOrdinURL=function(name){ return 'https://www.law.go.kr/자치법규/'+enc(name.replace(/\s+/g,'')) };
  var publicOrdinArticleURL=function(name, jo, joi){
    var label='제'+parseInt(jo,10)+(joi?('의'+parseInt(joi,10)):'')+'조';
    return publicOrdinURL(name)+'/'+enc(label);
  };

  /* ===== 유틸 ===== */
  function isFailPage(html){
    return /페이지\s*접속에\s*실패하였습니다|사용자인증에\s*실패하였습니다|페이지를\s*찾을\s*수\s*없습니다/.test((html||'').replace(/\u00A0/g,' '))
  }
  function normalizeText(s){
    return (s||'')
      .replace(/[\u200B-\u200D\uFEFF]/g,'')
      .replace(/[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g,' ')
      .replace(/[“”]/g,'"').replace(/[‘’]/g,"'")
      .replace(/[『「]/g,'«').replace(/[』」]/g,'»')
      .replace(/\s+/g,' ')
      .trim();
  }
  var joTo6=function(jo,joi){var h=pad(jo,4);return joi?h+pad(joi,2):h+'00'};

  /* ===== 이름 정리 ===== */
  function displayName(s){ return (s||'').replace(/["“”'‘’\[\]\(\)「」]/g,'').trim() }
  function refineLawName(name){
    var s=(name||'').trim(); if(!s) return s;
    s=s.replace(/^(?:까지|및|또는|등|관련|관한|따른|에\s*따른|에\s*의한|의)\s+/, '');
    var eoMatch=s.match(/\s*(시행령|시행규칙)\s*$/);
    var eo=eoMatch?eoMatch[1]:'';
    if(eo) s=s.replace(/\s*(시행령|시행규칙)\s*$/,'');
    var suffixes=['법률','조례','규칙','법'];
    var bestIdx=-1, bestSuf='';
    for(var i=0;i<suffixes.length;i++){
      var idx=s.lastIndexOf(suffixes[i]);
      if(idx>bestIdx){ bestIdx=idx; bestSuf=suffixes[i]; }
    }
    if(bestIdx>=0){
      var base=s.slice(0,bestIdx+bestSuf.length).trim();
      return eo?(base+' '+eo):base;
    }
    return s;
  }
  function guessIsLaw(name){
    var r = refineLawName(displayName(name));
    if(/\s*(시행령|시행규칙)$/.test(r)) return true;
    if(/(법|법률)$/.test(r)) return true;
    return false;
  }
  function guessIsOrdinance(name){
    var r = refineLawName(displayName(name));
    return /조례$/.test(r);
  }

  /* ===== 본문 정규식 추출 ===== */
  var LAW_BASE='[가-힣A-Za-z0-9·ㆍ\\s]+?(?:법|법률|조례|규칙)';
  var LAW_EO='(?:시행령|시행규칙)';
  var NAME_GROUP='('+LAW_BASE+'(?:\\s*'+LAW_EO+')?)';
  var BOUND='(?:^|[\\s\\(\\[\\{«「"“\'])';
  var D='\\d+';
  var JO='제\\s*('+D+')\\s*조(?:\\s*의\\s*('+D+'))?';
  var HANG='(?:\\s*제?\\s*('+D+')\\s*항)?';
  var HO='(?:\\s*제?\\s*('+D+')\\s*호)?';
  var MOK='(?:\\s*([가-하])\\s*목)?';
  var QUOTED_ANY=new RegExp('[«"\']\\s*'+NAME_GROUP+'\\s*[»"\']\\s*'+JO+HANG+HO+MOK,'g');
  var EXPL_RE=new RegExp(BOUND+NAME_GROUP+'\\s*'+JO+HANG+HO+MOK,'g');
  var NAME_ONLY_RE=new RegExp(BOUND+NAME_GROUP+'(?!\\s*제\\s*'+D+'\\s*조)(?=$|[\\s\\)\\]\\}»」"”\'.,;:!?])','g');

  function extract(text){
    var src=normalizeText(text);
    var list=[]; var seen=new Set();
    function push(nm,jo,joi,hang,ho,mok){
      var name=displayName(nm); if(!name) return;
      var key=[name,jo||'',joi||'',hang||'',ho||'',mok||''].join('|');
      if(seen.has(key)) return; seen.add(key);
      list.push({name:name, displayName:name, jo:jo, joi:joi, hang:hang, ho:ho, mok:mok});
    }
    var m;
    while((m=QUOTED_ANY.exec(src))){ push(m[1],m[2],m[3],m[4],m[5],m[6]) }
    while((m=EXPL_RE.exec(src))){ push(m[1],m[2],m[3],m[4],m[5],m[6]) }
    while((m=NAME_ONLY_RE.exec(src))){ push(m[1], null, null, null, null, null) }
    var namesWithArticle=new Set(list.filter(function(x){return !!x.jo}).map(function(x){return x.displayName}));
    list=list.filter(function(x){ if(x.jo) return true; return !namesWithArticle.has(x.displayName) });
    var seenNameOnly=new Set();
    list=list.filter(function(x){ if(x.jo) return true; var k='nameonly|'+x.displayName; if(seenNameOnly.has(k)) return false; seenNameOnly.add(k); return true; });
    return list;
  }

  /* ===== DRF 검색 (다중 폴백) ===== */
  async function searchLawRowJSON(name){
    try{
      var url=new URL(DRF + '/lawSearch.do');
      url.searchParams.set('OC',OC);
      url.searchParams.set('target','law');
      url.searchParams.set('type','JSON');
      url.searchParams.set('query', name);
      url.searchParams.set('display','20');
      var t=await fetchTextDirectOrProxy(url.toString());
      if(!t) return null;
      var data=JSON.parse(t); var root=(data&&data.LawSearch)||data;
      var rows=[]; if(root&&root.law){ rows=Array.isArray(root.law)?root.law:[root.law]; }
      if(!rows.length) return null;
      var canon = s => (s||'').replace(/[\s"“”'‘’\[\]\(\)「」]/g,'').replace(/[·ㆍ]/g,'').trim();
      var targetCanon = canon(name);
      var exact = rows.find(x=>canon(x.법령명한글)===targetCanon);
      return exact || rows[0] || null;
    }catch(e){ return null; }
  }
  async function searchLawRowXML(name){
    try{
      var url=new URL(DRF + '/lawSearch.do');
      url.searchParams.set('OC',OC);
      url.searchParams.set('target','law');
      url.searchParams.set('type','XML');
      url.searchParams.set('query', name);
      var t=await fetchTextDirectOrProxy(url.toString());
      if(!t) return null;
      var dom=new DOMParser().parseFromString(t,'text/xml');
      var law = dom.getElementsByTagName('law')[0];
      if(!law) return null;
      var get=function(tag){ var el=law.getElementsByTagName(tag)[0]; return el? (el.textContent||'').trim():'' };
      return { 법령명한글:get('법령명한글'), 법령ID:get('법령ID'), 법령일련번호:get('법령일련번호') };
    }catch(e){ return null; }
  }
  async function searchLawRowFromPublic(name){
    // 공개 페이지에 lawId가 스크립트/링크에 섞여 있는 경우가 있어 그것을 파싱 (r.jina.ai 로 CORS 회피)
    try{
      var url = 'https://r.jina.ai/http://www.law.go.kr/법령/'+enc(name);
      var html = await fetchTextDirectOrProxy(url);
      if(!html || isFailPage(html)) return null;
      // 여러 패턴 시도
      var m = html.match(/lawId\s*[:=]\s*"?([0-9]{5,})"?/i)
           || html.match(/ID=([0-9]{5,})/i)
           || html.match(/var\s+lawId\s*=\s*"([0-9]{5,})"/i);
      if(m){
        return { 법령명한글:name, 법령ID:m[1], 법령일련번호:'' };
      }
      return null;
    }catch(e){ return null; }
  }

  async function searchLawRow(lawQuery){
    var refined = refineLawName(displayName(lawQuery||'')); if(!refined) return null;
    var row = await searchLawRowJSON(refined);
    if(row && row.법령ID) return row;
    row = await searchLawRowXML(refined);
    if(row && row.법령ID) return row;
    row = await searchLawRowFromPublic(refined);
    if(row && row.법령ID) return row;
    return null;
  }

  /* ===== 자치법규/법령: 공개페이지 파싱 미리보기 ===== */
  function stripHTMLToText(html){
    return html.replace(/<script[\s\S]*?<\/script>/gi,'')
      .replace(/<style[\s\S]*?<\/style>/gi,'')
      .replace(/<\/p>|<br\s*\/?>/gi,'\n')
      .replace(/<[^>]+>/g,'')
      .replace(/\u00A0/g,' ')
      .replace(/[ \t]+\n/g,'\n')
      .replace(/\n{3,}/g,'\n\n');
  }
  function extractArticleFromFullText(txt, jo, joi){
    var joLabel='제\\s*'+jo+'\\s*조';
    if(joi) joLabel='제\\s*'+jo+'\\s*의\\s*'+joi+'\\s*조';
    var startRe=new RegExp(joLabel);
    var nextRe=new RegExp('제\\s*\\d+\\s*(?:의\\s*\\d+\\s*)?조');
    var startIdx=txt.search(startRe);
    if(startIdx<0) return '';
    var tail=txt.slice(startIdx);
    var m=tail.slice(1).match(nextRe);
    var endIdx=m?(1+m.index):tail.length;
    return tail.slice(0,endIdx).trim();
  }
  async function previewFromPublicLaw(lawName, joText){
    var articleURL = publicLawArticleKoURL(lawName, joText);
    // 1순위: 조문 개별 URL을 직접 스크랩
    var readerURL = 'https://r.jina.ai/http://' + articleURL.replace(/^https?:\/\//,'');
    var html = await fetchTextDirectOrProxy(readerURL);
    var text = html? stripHTMLToText(html) : '';
    // 개별 조문 페이지가 간혹 빈 경우: 전체법령 페이지에서 재시도
    if(!text || text.length<50){
      var fullURL = 'https://r.jina.ai/http://' + publicLawURL(lawName).replace(/^https?:\/\//,'');
      var html2 = await fetchTextDirectOrProxy(fullURL);
      var text2 = html2? stripHTMLToText(html2) : '';
      text = extractArticleFromFullText(text2, joText.jo, joText.joi);
    }
    var modal=$('#modal'), body=$('#modalBody'), titleEl=$('#modalTitle');
    var joLabel='제'+parseInt(joText.jo,10)+(joText.joi?('의'+parseInt(joText.joi,10)):'')+'조';
    if(titleEl) titleEl.textContent=lawName+' '+joLabel+' (전문)';
    body.textContent = text || '조문 본문을 찾지 못했습니다. 페이지에서 확인해 주세요.';
    if(modal) modal.classList.add('on');
  }
  async function previewFromOrdinance(name, joText){
    var pageURL   = publicOrdinURL(name);
    var readerURL = 'https://r.jina.ai/http://' + pageURL.replace(/^https?:\/\//,'');
    var html      = await fetchTextDirectOrProxy(readerURL);
    if(!html || !html.trim()){
      var articleURL = publicOrdinArticleURL(name, joText.jo, joText.joi);
      var readerURL2 = 'https://r.jina.ai/http://' + articleURL.replace(/^https?:\/\//,'');
      html = await fetchTextDirectOrProxy(readerURL2);
    }
    var txt=html? stripHTMLToText(html) : '';
    if(joText && txt){
      txt = extractArticleFromFullText(txt, joText.jo, joText.joi) || txt;
    }
    var modal=$('#modal'), body=$('#modalBody'), titleEl=$('#modalTitle');
    var joLabel='제'+parseInt(joText.jo,10)+(joText.joi?('의'+parseInt(joText.joi,10)):'')+'조';
    if(titleEl) titleEl.textContent=name.replace(/\s+/g,'')+' '+joLabel+' (자치법규)';
    body.textContent = txt || '조문 본문을 찾지 못했습니다. 전체 자치법규 페이지에서 확인해 주세요.';
    if(modal) modal.classList.add('on');
  }

  /* ===== DRF 조문(XML) 미리보기(법령ID 있을 때) ===== */
  function buildLawFullHTMLURL(id){return buildURL('/lawService.do',{OC:OC,target:'law',type:'HTML',ID:id})}
  function buildLawArticleXMLURL(id,obj){
    var JO=joTo6(obj.jo,obj.joi);
    var HANG=(obj.hang?pad(obj.hang,6):(obj.ho?'000000':''));
    var HO=(obj.ho?pad(obj.ho,6):'');
    var MOK=(obj.mok?String(obj.mok).trim().slice(0,1).replace(/[^가-하]/g,''):'');
    var p={OC:OC,target:'lawjosub',type:'XML',ID:id,JO:JO};
    if(HANG)p.HANG=HANG; if(HO)p.HO=HO; if(MOK)p.MOK=MOK;
    return buildURL('/lawService.do',p);
  }
  async function previewFromDRF(lawName, lawId, joText){
    var xmlURL=buildLawArticleXMLURL(lawId,joText);
    var xmlText=await fetchTextDirectOrProxy(xmlURL);
    if(!xmlText){ await previewFromPublicLaw(lawName, joText); return; }
    var dom=new DOMParser().parseFromString(xmlText,'text/xml');
    var get=function(tag,node){node=node||dom; var el=node.getElementsByTagName(tag)[0]; return el? (el.textContent||'').trim() : ''};
    var htmlPart=get('조문내용')||'';
    var hangs=[].slice.call(dom.getElementsByTagName('항')).map(function(h){
      var hTitle=(h.getElementsByTagName('항내용')[0]||{}).textContent; hTitle=hTitle? hTitle.trim():'';
      var hos=[].slice.call(h.getElementsByTagName('호')).map(function(ho){
        var hoText=(ho.getElementsByTagName('호내용')[0]||{}).textContent; hoText=hoText? hoText.trim():'';
        var moks=[].slice.call(ho.getElementsByTagName('목')).map(function(m){return (m.textContent||'').trim()});
        return {hoText:hoText, moks:moks};
      });
      return {hTitle:hTitle, hos:hos};
    });
    var modal=$('#modal'), body=$('#modalBody'), titleEl=$('#modalTitle');
    var joLabel='제'+parseInt(joText.jo,10)+(joText.joi?('의'+parseInt(joText.joi,10)):'')+'조';
    if(titleEl) titleEl.textContent=lawName+' '+joLabel+' (전문)';
    var html='';
    if(htmlPart) html+='<div>'+htmlPart+'</div>';
    hangs.forEach(function(h){
      if(h.hTitle) html+='<div class="hang">'+h.hTitle+'</div>';
      h.hos.forEach(function(ho){
        if(ho.hoText) html+='<div class="ho">'+ho.hoText+'</div>';
        ho.moks.forEach(function(mk){ html+='<div class="mok">'+mk+'</div>'; });
      });
    });
    if(!html) html='<div class="mini">조문 본문을 불러오지 못했습니다.</div>';
    if(body) body.innerHTML=html;
    if(modal) modal.classList.add('on');
  }

  /* ===== 결과 렌더링 ===== */
  function appendResult(listEl,payload){
    var title=payload.title, lawId=payload.lawId, lsiSeq=payload.lsiSeq, fullURL=payload.fullURL, lawName=payload.lawName, joText=payload.joText, isOrdinance=payload.isOrdinance;

    var linkHtml='';
    if(isOrdinance){
      var ordinArticleURL=joText? publicOrdinArticleURL(lawName,joText.jo,joText.joi) : publicOrdinURL(lawName);
      linkHtml+='① <button type="button" class="preview-btn">조문 미리보기</button> · ';
      linkHtml+='② <a class="go-ordin-article" href="'+ordinArticleURL+'" target="_blank" rel="noopener">자치법규 바로가기</a> · ';
      linkHtml+='③ <a class="go-full" href="'+publicOrdinURL(lawName)+'" target="_blank" rel="noopener">전체 자치법규</a>';
    }else{
      if(joText){
        var koArticleURL = publicLawArticleKoURL(lawName, joText);
        linkHtml+='① <button type="button" class="preview-btn">조문 미리보기</button> · ';
        linkHtml+='② <a class="go-article" href="'+koArticleURL+'" target="_blank" rel="noopener">조문 바로가기</a> · ';
      }
      linkHtml+='③ <a class="go-full" href="'+fullURL+'" target="_blank" rel="noopener">법령 전체</a>';
    }

    var li=document.createElement('li'); li.className='item';
    li.innerHTML='<div class="item-line">'+
      '<span class="t">'+title+'</span>'+
      (isOrdinance? '<span class="meta">자치법규</span>' :
        (lawId? '<span class="meta">법령ID: '+lawId+(lsiSeq?(' · 일련번호: '+lsiSeq):'')+'</span>' :
                 '<span class="meta">법령ID 미확인(공개페이지 파싱)</span>'))+
      '<span class="links">'+linkHtml+'</span>'+
    '</div>';

    var btn=li.querySelector('.preview-btn');
    if(btn){
      btn.addEventListener('click', async function(){
        btn.disabled=true; btn.textContent='불러오는 중…';
        try{
          if(isOrdinance){
            await previewFromOrdinance(lawName, joText || {jo:1});
          }else{
            if(lawId){
              await previewFromDRF(lawName, lawId, joText || {jo:1});
            }else{
              await previewFromPublicLaw(lawName, joText || {jo:1});
            }
          }
        } finally { btn.disabled=false; btn.textContent='조문 미리보기'; }
      });
    }
    listEl.appendChild(li);
  }

  /* ===== 실행 플로우 ===== */
  async function run(){
    var input=$('#input'); var resUl=$('#resList');
    if(resUl) resUl.innerHTML='';
    var text=input? (input.value||'') : '';
    if(!text.trim()){ toast('본문을 입력해 주세요'); return; }
    if(resUl) resUl.innerHTML='<li class="item"><div class="sk-line skeleton" style="width:58%"></div><div class="sk-gap"></div><div class="sk-line skeleton" style="width:32%"></div></li>';

    var cites=extract(text);
    if(!cites.length){
      if(resUl) resUl.innerHTML='<li class="item mini">인식 가능한 법령/자치법규명 또는 조문을 찾지 못했습니다.</li>';
      return;
    }

    // 검색(병렬) + 강건한 분류
    var rows=await Promise.all(cites.map(function(it){ return searchLawRow(it.name) }));
    if(resUl) resUl.innerHTML='';

    for(var i=0;i<cites.length;i++){
      var it=cites[i];
      var row=rows[i]||null;
      var baseName=it.displayName;
      var title=it.jo ? (baseName+' 제'+parseInt(it.jo,10)+(it.joi?('의'+parseInt(it.joi,10)):'')+'조') : baseName;

      var treatAsLaw = !!row || guessIsLaw(it.name);
      var treatAsOrdin = !treatAsLaw && (guessIsOrdinance(it.name) || !treatAsLaw);

      if(treatAsLaw){
        var lawId=row? (row.법령ID||'') : '';
        var lsiSeq=row? (row.법령일련번호||'') : '';
        var fullURL=lawId ? buildLawFullHTMLURL(lawId) : publicLawURL(it.name);
        appendResult(resUl,{
          title:title, lawId:lawId, lsiSeq:lsiSeq,
          fullURL:fullURL,
          lawName:it.name, joText: it.jo? it : null,
          isOrdinance:false
        });
      }else if(treatAsOrdin){
        appendResult(resUl,{
          title:title, lawId:'', lsiSeq:'',
          fullURL:publicOrdinURL(it.name),
          lawName:it.name, joText: it.jo? it : null,
          isOrdinance:true
        });
      }
    }
  }

  /* ===== 바인딩 & 도우미 ===== */
  function bind(){
    var runBtn=$('#run'); if(runBtn){ runBtn.addEventListener('click', run) }
    var clearBtn=$('#clear'); if(clearBtn){ clearBtn.addEventListener('click', function(){ var resUl=$('#resList'); if(resUl) resUl.innerHTML=''; var input=$('#input'); if(input){ input.value=''; input.focus(); } })}
    var input=$('#input');
    if(input){ input.addEventListener('keydown', function(e){ if(e.key==='Enter'&&!e.altKey&&!e.shiftKey&&!e.ctrlKey){ e.preventDefault(); run(); } }) }
    var closeBtn=$('#modalClose'); if(closeBtn){ closeBtn.addEventListener('click', function(){ var m=$('#modal'); if(m) m.classList.remove('on'); }) }
    var modal=$('#modal'); if(modal){ modal.addEventListener('click', function(e){ if(e.target && e.target.id==='modal'){ modal.classList.remove('on'); } }) }
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', bind) } else { bind() }

  window.__RUN = run;

  function toast(msg){
    var t=document.getElementById('toast');
    var m=document.getElementById('toastMsg');
    if(m) m.textContent=msg||'';
    if(t){
      t.classList.add('on');
      setTimeout(function(){ t.classList.remove('on'); }, 1700);
    }
  }
})();
</script>
</body>
</html>
