<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>법조문 자동 추출·검색 · 고급버전 (OC=bro3362)</title>
<style>
  :root{--bg:#0b1020;--panel:#11172c;--muted:#8492b5;--line:#1f2a49;--accent:#5b8cff;--txt:#e6ecff}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  h1{font-size:1.35rem;margin:0 0 8px}
  .hint{color:var(--muted);font-size:.95rem;margin-bottom:16px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  textarea{width:100%;min-height:210px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1731;color:#e6ecff}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1731;color:#e6ecff;min-width:260px}
  button{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
  button.secondary{background:#445b9c}
  button:disabled{opacity:.6;cursor:not-allowed}
  .tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border:1px solid var(--line);background:#0f1731;border-radius:999px;color:#c9d6ff;font-size:.8rem}
  .result h2{margin:0 0 8px}
  ol{margin:0;padding-left:20px}
  .k{color:#9fb4ff}
  .small{font-size:.9rem;color:#9aa8ce}
  .item{padding:10px;border-top:1px dashed var(--line)}
  .monos{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0f1731;border-radius:6px;padding:0 6px}
  .render{margin-top:8px;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .render .hdr{display:flex;justify-content:space-between;align-items:center;background:#0f1731;padding:8px 10px;border-bottom:1px solid var(--line)}
  .render .body{padding:10px;max-height:360px;overflow:auto;background:#0c1330}
  a{color:#9ec1ff}
  .tests{margin-top:18px}
  .pass{color:#22c55e}
  .fail{color:#ef4444}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1731;border:1px solid var(--line);color:#c9d6ff;font-size:.8rem}

  .viewer{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .viewer.on{display:flex}
  .viewer .box{width:min(1100px,96vw);height:min(80vh,900px);background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
  .viewer .hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#0f1731;border-bottom:1px solid var(--line)}
  .viewer .body{flex:1;overflow:auto;background:#0c1330;padding:12px}
  .viewer .close{background:#3b4977}
  mark.hl{background:#fde047;color:#111;padding:0 .2em;border-radius:3px}

  .tooltip{position:fixed;max-width:560px;max-height:360px;overflow:auto;background:#0f1731;color:#e6ecff;border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.45);padding:10px;z-index:60;display:none}
  .tooltip .hdr{font-weight:600;margin-bottom:6px;color:#cfe0ff}
  .tooltip .cnt{font-size:.92rem;line-height:1.45}
  .tooltip .loading{color:#9aa8ce}
  .tooltip .err{color:#ef4444}
</style>
</head>
<body>
<div class="wrap">
  <h1>법조문 자동 추출·검색 · <span class="k">고급버전</span> <span class="small">(OC=bro3362 고정)</span></h1>
  <div class="hint">프록시가 설정되어 있으면 툴팁·로컬 미리보기에서 조문이 바로 표시됩니다. DRF 실패 시 퍼블릭 페이지로 폴백합니다.</div>

  <div class="grid">
    <div>
      <div class="card">
        <label for="input"><b>본문 입력</b></label>
        <textarea id="input" placeholder="예) 건축법 제22조, 같은법 제23조, 동법시행령 제9조의2 제3항 …"></textarea>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="row"><span class="badge">OC: bro3362 (고정)</span></div>
        <!-- 본인 Workers 주소로 바꿔도 됩니다 -->
        <div class="row"><label>프록시</label><input id="proxy" type="text" value="https://law-proxy.hyok96.workers.dev/?url=" /></div>
        <div class="row"><button id="run">추출·검색</button><button class="secondary" id="clear">지우기</button><button class="secondary" id="runTests">테스트 실행</button></div>
        <div class="small">• CORS로 본문을 못 읽을 때 프록시가 자동으로 사용됩니다.</div>
      </div>
    </div>
  </div>

  <div class="card" id="foundBox">
    <h2>추출된 인용</h2>
    <ol id="foundList"></ol>
  </div>

  <div class="card result" id="resBox">
    <h2>검색 결과 (위에서부터 순서대로 표시)</h2>
    <ol id="resList"></ol>
  </div>

  <div class="card tests">
    <h2>내장 테스트</h2>
    <div id="testOutput" class="small">[테스트 대기 중]</div>
  </div>
</div>

<!-- 로컬 전체보기 모달 -->
<div id="viewer" class="viewer" aria-hidden="true">
  <div class="box">
    <div class="hdr">
      <div id="viewerTitle">로컬 전체(스크롤)</div>
      <button class="close" onclick="document.getElementById('viewer').classList.remove('on');document.getElementById('viewer').setAttribute('aria-hidden','true')">닫기</button>
    </div>
    <div id="viewerBody" class="body"></div>
  </div>
</div>

<script>
(function(){
  'use strict';

  /** ========== 설정 ========== **/
  const DRF = 'https://www.law.go.kr/DRF';
  const OC  = 'bro3362';

  const enc = s => encodeURIComponent(s);
  const byId = id => document.getElementById(id);
  const getProxyBase = () => (byId('proxy')?.value?.trim() || 'https://law-proxy.hyok96.workers.dev/?url=');

  /** ========== 유틸 ========== **/
  function buildURL(path, params){
    const u = new URL(DRF + path);
    Object.entries(params).forEach(([k,v])=>{ if(v!=null && v!=='') u.searchParams.set(k,v); });
    return u.toString();
  }
  function withProxy(url){
    let base = getProxyBase();
    if(!base.includes('?')) base += (base.endsWith('/') ? '' : '/') + '?';
    if(!/\burl=/.test(base)) base += 'url=';
    return base + encodeURIComponent(url);
  }
  async function fetchTextDirectOrProxy(url){
    // 1) 직접
    try{
      const r = await fetch(url, { mode:'cors' });
      const t = await r.text();
      if (t && t.length > 20) return t;
    }catch(_){}
    // 2) 프록시
    try{
      const r2 = await fetch(withProxy(url));
      const t2 = await r2.text();
      return t2 || '';
    }catch(_){ return ''; }
  }
  function isFailPage(html){
    const t = (html||'').replace(/\u00A0/g,' ');
    return /페이지\s*접속에\s*실패하였습니다/.test(t)
        || /사용자인증에\s*실패하였습니다/.test(t);
  }
  function publicLawURL(name){ return 'https://www.law.go.kr/법령/' + enc(name); }
  async function fetchPublicLawSnippet(lawName, jo, joi){
    try{
      const url = publicLawURL(lawName);
      const text = await fetchTextDirectOrProxy(url);
      if(!text || text.length<200) return null;
      const clean = (text||'').replace(/\r?\n/g,' ').replace(/\s{2,}/g,' ');
      const key = `제${parseInt(jo,10)}조` + (joi?`의${parseInt(joi,10)}`:'');
      let idx = clean.indexOf(key);
      if(idx<0){
        const noTag = clean.replace(/<[^>]+>/g,' ');
        idx = noTag.indexOf(key);
        if(idx<0) return null;
      }
      const from = Math.max(0, idx - 400);
      const to   = Math.min(clean.length, idx + 1600);
      const snippet = clean.substring(from, to);
      return `<div class="render"><div class="hdr"><div>${lawName} · ${key} (퍼블릭 폴백)</div></div><div class="body">${snippet}</div></div>`;
    }catch(e){ return null; }
  }

  /** ========== 이름 정리/정규식 ========== **/
  function canonName(s){ return (s||'').replace(/[\s"“”'‘’\[\]\(\)「」]/g,'').replace(/[·ㆍ]/g,''); }
  function displayName(s){ return (s||'').replace(/[\"“”'‘’\[\]\(\)「」]/g,'').trim(); }
  function refineLawName(name){
    let s = (name||'').trim();
    if(!s) return s;
    s = s.replace(/^(?:까지|및|또는|등|관련|관한|따른|에\s+따른|에\s+의한|의)\s+/, '');
    const toks = s.split(/\s+/);
    let i = -1;
    for(let k=toks.length-1;k>=0;k--){ if(/[법]$/.test(toks[k])){ i = k; break; } }
    if(i>=0){ if(toks[i+1] && /^(시행령|시행규칙)$/.test(toks[i+1])) return (toks[i]+' '+toks[i+1]).trim(); return toks[i]; }
    return s;
  }
  const _normCtx = s => (s||'').replace(/\s+/g,'');
  const CTX_KEY = {
    BASE: /(같은\s*법|이\s*법|동\s*법)/,
    SL: /(동\s*법\s*시행령|같은\s*법\s*시행령|이\s*영|동\s*시행령)/,
    SK: /(동\s*법\s*시행규칙|같은\s*법\s*시행규칙|이\s*규칙|동\s*규칙)/
  };
  function isContextualName(nameRaw){
    const n = _normCtx(nameRaw);
    return n==='같은법'||n==='이법'||n==='동법'||n==='같은법시행령'||n==='동법시행령'||n==='같은법시행규칙'||n==='동법시행규칙'||n==='이영'||n==='동시행령'||n==='이규칙'||n==='동규칙';
  }

  const LAW_BASE = `[가-힣A-Za-z0-9·ㆍ\\s]+?법`;
  const LAW_EO   = `(?:시행령|시행규칙)`;
  const LAW_FULL = `(${LAW_BASE}(?:\\s*${LAW_EO})?)`;
  const D   = `\\d+`;
  const MOK = `([가-하])목`;
  const JO  = `제\\s*(${D})(?:\\s*조(?:의\\s*(${D}))?)?`;
  const HANG= `(?:\\s*제?\\s*(${D})\\s*항)?`;
  const HO  = `(?:\\s*제?\\s*(${D})\\s*호)?`;
  const MOKRE = `(?:\\s*(${MOK}))?`;
  const EXPL_RE = new RegExp(`${LAW_FULL}\\s*${JO}${HANG}${HO}${MOKRE}`, 'g');
  const QUOTED_RE = /「\s*([가-힣A-Za-z0-9·ㆍ\s]+?법(?:\s*(?:시행령|시행규칙))?)\s*」\s*제\s*(\d+)\s*조(?:\s*의\s*(\d+))?(?:\s*제?\s*(\d+)\s*항)?(?:\s*제?\s*(\d+)\s*호)?(?:\s*([가-하])\s*목)?/g;
  const BYEOLPYO_RE = /(?:별표|[별附]표)\s*(\d+)?/g;
  const BUCHIK_RE   = /부칙\s*(\d+)?/g;
  const CTX_WORD = '(?:같은\\s*법|이\\s*법|동\\s*법|같은\\s*법\\s*시행령|동\\s*법\\s*시행령|이\\s*영|동\\s*시행령|같은\\s*법\\s*시행규칙|동\\s*법\\s*시행규칙|이\\s*규칙|동\\s*규칙)';
  const CTX_RE   = new RegExp(`(${CTX_WORD})\\s*${JO}${HANG}${HO}${MOKRE}`, 'g');

  /** ========== 유사명(오타) 자동 보정 ========== **/
  // 검색 실패 시 아래 변형을 순차 시도
  function generateAlternatives(q){
    const s = displayName(q||'').replace(/\s+/g,'').trim();
    const alts = new Set();

    // 1) "영유아교육법" → "유아교육법", "영유아보육법"
    if (/^영유아교육법$/.test(s)) { alts.add('유아교육법'); alts.add('영유아보육법'); }

    // 2) '법' 중복/공백/오탈자 정리
    alts.add(s.replace(/[^가-힣A-Za-z0-9]/g,''));
    alts.add(s.replace(/교육/g,'보육')); // 교육↔보육 혼동 대비
    alts.add(s.replace(/보육/g,'교육'));

    // 3) "시행령/시행규칙" 붙임·띄어쓰기 교정
    if (/시행령$/.test(s)) alts.add(s.replace(/시행령$/,' 시행령'));
    if (/시행규칙$/.test(s)) alts.add(s.replace(/시행규칙$/,' 시행규칙'));

    // 4) 접두 불용어 제거
    alts.add(refineLawName(q));

    // 원본은 마지막에
    alts.add(q);
    return [...alts].filter(Boolean);
  }

  /** ========== DRF 검색/URL ========== **/
  async function searchLawRow(lawQuery){
    const variants = generateAlternatives(lawQuery);
    const pickBest = (rows, wantCanon)=>{
      if(!rows||!rows.length) return null;
      const clean = s => canonName(refineLawName(s||''));
      let exact = rows.find(x => clean(x.법령명한글) === wantCanon);
      if(exact) return exact;
      let partial = rows.find(x => clean(x.법령명한글).includes(wantCanon) || wantCanon.includes(clean(x.법령명한글)));
      return partial || rows[0];
    };

    const tryJson = async (qCanon,qRaw)=>{
      const url = buildURL('/lawSearch.do', { OC, target:'law', type:'JSON', query:qRaw, display:10 });
      const text = await fetchTextDirectOrProxy(url);
      try{
        const data = JSON.parse(text);
        const root = (data && data.LawSearch) ? data.LawSearch : data;
        let rows = [];
        if(root && root.law){ rows = Array.isArray(root.law) ? root.law : [root.law]; }
        return pickBest(rows, qCanon);
      }catch(e){ return null; }
    };
    const tryXml = async (qCanon,qRaw)=>{
      const url = buildURL('/lawSearch.do', { OC, target:'law', type:'XML', query:qRaw, display:10 });
      const text = await fetchTextDirectOrProxy(url);
      try{
        const dom = new DOMParser().parseFromString(text, 'text/xml');
        const nodes = Array.from(dom.getElementsByTagName('law'));
        const rows = nodes.map(n=>({
          법령명한글: (n.getElementsByTagName('법령명한글')[0]?.textContent||'').trim(),
          법령ID: (n.getElementsByTagName('법령ID')[0]?.textContent||'').trim(),
          법령일련번호: (n.getElementsByTagName('법령일련번호')[0]?.textContent||'').trim(),
          법령상세링크: (n.getElementsByTagName('법령상세링크')[0]?.textContent||'').trim()
        }));
        return pickBest(rows, qCanon);
      }catch(e){ return null; }
    };
    const tryHtml = async (qCanon,qRaw)=>{
      const url = buildURL('/lawSearch.do', { OC, target:'law', type:'HTML', query:qRaw, display:10 });
      const text = await fetchTextDirectOrProxy(url);
      try{
        const dom = new DOMParser().parseFromString(text, 'text/html');
        const links = Array.from(dom.querySelectorAll('a[href*="ID="]'));
        const rows = links.map(a=>{
          const href=a.getAttribute('href')||'';
          const idMatch=href.match(/ID=([^&]+)/);
          const name=(a.textContent||'').trim();
          return { 법령명한글:name, 법령ID:idMatch?decodeURIComponent(idMatch[1]):'' };
        }).filter(x=>x.법령ID);
        return pickBest(rows, qCanon);
      }catch(e){ return null; }
    };

    for(const q of variants){
      const canon = canonName(refineLawName(q));
      let row = await tryJson(canon,q);
      if(!row) row = await tryXml(canon,q);
      if(!row) row = await tryHtml(canon,q);
      if(row) return row;
    }
    return null;
  }

  function buildLawJoSubURLs(id,item){
    const base = { OC, target:'lawjosub', type:'HTML', ID:id };
    const make = (extra) => {
      const u = new URL(DRF + '/lawService.do');
      Object.entries(base).forEach(([k,v])=>u.searchParams.set(k,v));
      Object.entries(extra||{}).forEach(([k,v])=>{ if(v!=null && v!=='') u.searchParams.set(k,v); });
      return u.toString();
    };
    const pad = v => v ? String(parseInt(v,10)).padStart(6,'0') : null;
    const raw = v => v ? String(parseInt(v,10)) : null;

    const hasHang = !!item.hang;
    const hasHo   = !!item.ho;
    const hasJoi  = !!item.joi;

    const common    = hasJoi ? { JOI: pad(item.joi) } : {};
    const rawCommon = hasJoi ? { JOI: raw(item.joi) } : {};

    const joOnly = { pad: make({ JO: pad(item.jo), ...common }), raw: make({ JO: raw(item.jo), ...rawCommon }) };
    const joHo   = hasHo ? { pad: make({ JO: pad(item.jo), HO: pad(item.ho), ...common }), raw: make({ JO: raw(item.jo), HO: raw(item.ho), ...rawCommon }) } : null;
    const joH0   = hasHo ? { pad: make({ JO: pad(item.jo), HANG:'000000', HO: pad(item.ho), ...common }) } : null;
    const jhHo   = hasHang ? { pad: make({ JO: pad(item.jo), HANG: pad(item.hang), ...(hasHo?{HO:pad(item.ho)}:{}), ...common }), raw: make({ JO: raw(item.jo), HANG: raw(item.hang), ...(hasHo?{HO:raw(item.ho)}:{}), ...rawCommon }) } : null;
    return { joOnly, joHo, joH0, jhHo };
  }
  function buildLawFullHTMLURL(id){
    return buildURL('/lawService.do', { OC, target:'law', type:'HTML', ID:id });
  }

  /** ========== 추출/렌더 ========== **/
  let lastExplicitBase = { 법:null, 영:null, 규:null };

  function addFoundItem(el, it){
    const li = document.createElement('li');
    li.innerHTML = `<span class="tag">${it.disp||it.lawName}</span> <span class="monos">${(it.raw||'').trim()}</span>`;
    el.appendChild(li);
  }
  function wrapRender(title, inner){
    return `<div class="render"><div class="hdr"><div>${title}</div></div><div class="body">${inner}</div></div>`;
  }

  function tokenizeForContext(text){
    return text.replace(/[\u00A0\t\r\n]+/g,' ').split(/(?<=[.!?。]|[)\]\}])\s+|\s{2,}/);
  }
  function pad6(n){ return String(parseInt(n,10)).padStart(6,'0'); }

  function updateBaseFromName(dispRaw){
    const disp = refineLawName(displayName(dispRaw));
    if(/시행령$/.test(disp)){ lastExplicitBase.영 = disp; lastExplicitBase.법 = disp.replace(/시행령$/, ''); lastExplicitBase.규 = lastExplicitBase.법 + '시행규칙'; }
    else if(/시행규칙$/.test(disp)){ lastExplicitBase.규 = disp; lastExplicitBase.법 = disp.replace(/시행규칙$/, ''); lastExplicitBase.영 = lastExplicitBase.법 + '시행령'; }
    else { lastExplicitBase.법 = disp; lastExplicitBase.영 = disp + '시행령'; lastExplicitBase.규 = disp + '시행규칙'; }
  }
  function resolveContextualName(token){
    if(CTX_KEY.BASE.test(token)) return lastExplicitBase?.법 || null;
    if(CTX_KEY.SL.test(token))   return lastExplicitBase?.영 || (lastExplicitBase?.법 ? lastExplicitBase.법 + '시행령' : null);
    if(CTX_KEY.SK.test(token))   return lastExplicitBase?.규 || (lastExplicitBase?.법 ? lastExplicitBase.법 + '시행규칙' : null);
    return null;
  }
  function pushUnique(seen, arr, obj){
    const key = [obj.lawName, obj.jo||'', obj.joi||'', obj.hang||'', obj.ho||'', obj.mok||'', obj.kind||''].join('|');
    if(seen.has(key)) return; seen.add(key); arr.push(obj);
  }

  function extractCitationsAdvanced(text){
    const tokens = tokenizeForContext(text);
    const cites = [];
    const seen = new Set();

    for(const t of tokens){
      // (A) 명시적 법명 → 기반 업데이트
      let m0; const LAW_NAME_ONLY_RE = new RegExp(LAW_FULL, 'g');
      while((m0 = LAW_NAME_ONLY_RE.exec(t))){
        const rawName = refineLawName(displayName(m0[1])); if(isContextualName(rawName)) continue;
        updateBaseFromName(rawName);
      }

      // (B) 「…」 표기
      let q; while((q = QUOTED_RE.exec(t))){
        const [raw, rawName, joNum, joUi, hang, ho, mokChar] = q;
        const disp = refineLawName(displayName(rawName));
        pushUnique(seen, cites, { raw, lawName: canonName(disp), disp, jo: pad6(joNum), joi: joUi?pad6(joUi):null, hang: hang?pad6(hang):null, ho: ho?pad6(ho):null, mok: mokChar||null, kind:'article' });
        updateBaseFromName(disp);
      }

      // (C) 일반 인용
      let m; while((m = EXPL_RE.exec(t))){
        const [raw, rawName, joNum, joUi, hang, ho, mokAll] = m;
        const disp = refineLawName(displayName(rawName)); if(isContextualName(disp)) continue;
        pushUnique(seen, cites, { raw, lawName: canonName(disp), disp, jo: joNum?pad6(joNum):null, joi: joUi?pad6(joUi):null, hang: hang?pad6(hang):null, ho: ho?pad6(ho):null, mok: mokAll?mokAll.match(/[가-하]/)?.[0]||null:null, kind:'article' });
        updateBaseFromName(disp);
      }

      // (D) 컨텍스트 인용
      while((m = CTX_RE.exec(t))){
        const [raw, ctxWord, joNum, joUi, hang, ho, mokAll] = m;
        const resolved = resolveContextualName(ctxWord); if(!resolved) continue;
        const disp = refineLawName(displayName(resolved));
        pushUnique(seen, cites, { raw, lawName: canonName(disp), disp, jo: joNum?pad6(joNum):null, joi: joUi?pad6(joUi):null, hang: hang?pad6(hang):null, ho: ho?pad6(ho):null, mok: mokAll?mokAll.match(/[가-하]/)?.[0]||null:null, kind:'article' });
      }

      // (E) 별표/부칙
      let bp; while((bp = BYEOLPYO_RE.exec(t))){
        const target = lastExplicitBase.법 || lastExplicitBase.영 || lastExplicitBase.규; if(!target) continue;
        pushUnique(seen, cites, { raw: bp[0], lawName: canonName(target), disp: refineLawName(displayName(target)), kind:'annex', annexNo: bp[1]||null });
      }
      let bc; while((bc = BUCHIK_RE.exec(t))){
        const target = lastExplicitBase.법 || lastExplicitBase.영 || lastExplicitBase.규; if(!target) continue;
        pushUnique(seen, cites, { raw: bc[0], lawName: canonName(target), disp: refineLawName(displayName(target)), kind:'supplement', suppNo: bc[1]||null });
      }
    }
    return cites;
  }

  /** ========== 실행/렌더링 ========== **/
  function addResultItem(it, lawId, lsiSeq, serviceLink){
    const resUl = byId('resList');
    const li = document.createElement('li'); li.className='item';
    li.innerHTML = `<div><b>${it.raw}</b> <span class="small">(${it.disp||it.lawName})</span></div>
      <div class="small">법령ID: ${lawId}${lsiSeq ? ` · 일련번호(lsiSeq): ${lsiSeq}`:''}</div>`;
    resUl.appendChild(li);
    return li;
  }

  async function handleRun(){
    const text    = byId('input').value;
    const foundUl = byId('foundList');
    const resUl   = byId('resList');
    foundUl.innerHTML = ''; resUl.innerHTML = '';
    lastExplicitBase = { 법:null, 영:null, 규:null };

    if(!text.trim()){ alert('본문을 입력해 주세요.'); return; }

    const items = extractCitationsAdvanced(text)
      .filter(it => it.kind==='article' || it.kind==='annex' || it.kind==='supplement');

    if(!items.length){
      foundUl.innerHTML = '<li>특정 가능한 법조문 인용을 찾지 못했습니다.</li>';
      return;
    }
    items.forEach(it=> addFoundItem(foundUl, it));

    for(const it of items){
      const row = await searchLawRow(it.disp || it.lawName);
      if(!row){
        const publicDirect = publicLawURL(it.disp||it.lawName);
        const drfList = buildURL('/lawSearch.do', { OC, target:'law', type:'HTML', query:it.disp||it.lawName, display:10 });
        const li = document.createElement('li'); li.className='item';
        li.innerHTML = `<div><b>${it.raw||it.disp||it.lawName}</b> <span class="small">(${it.disp||it.lawName})</span></div>
          <div class="small">법령ID 검색 실패. 퍼블릭 링크를 제공합니다.</div>
          <div>• 법령 페이지: <a target="_blank" rel="noopener" href="${publicDirect}">${it.disp||it.lawName}</a></div>
          <div class="small">(참고) DRF 목록: <a target="_blank" rel="noopener" href="${drfList}">lawSearch</a></div>`;
        resUl.appendChild(li);
        continue;
      }

      const lawId = row.법령ID || row.id || '';
      const lsiSeq = row.법령일련번호 || '';
      const serviceLink = row.법령상세링크 ? ('https://www.law.go.kr' + row.법령상세링크) : '';

      const li = addResultItem(it, lawId, lsiSeq, serviceLink);
      li.dataset.kind = it.kind;
      li.dataset.lawid = lawId;
      li.dataset.lawname = (it.disp||it.lawName)||'';
      li.dataset.jo = it.jo||''; li.dataset.joi = it.joi||''; li.dataset.hang = it.hang||''; li.dataset.ho = it.ho||'';

      if(it.kind==='article'){
        const urls = buildLawJoSubURLs(lawId, it);
        const tryList=[];
        const noHangHasHo = (!it.hang && !!it.ho);
        if(noHangHasHo && urls.joH0) tryList.push(urls.joH0.pad);
        if(urls.jhHo){ if(urls.jhHo.pad) tryList.push(urls.jhHo.pad); if(urls.jhHo.raw) tryList.push(urls.jhHo.raw); }
        if(urls.joHo){ if(urls.joHo.pad) tryList.push(urls.joHo.pad); if(urls.joHo.raw) tryList.push(urls.joHo.raw); }
        if(urls.joOnly){ if(urls.joOnly.pad) tryList.push(urls.joOnly.pad); if(urls.joOnly.raw) tryList.push(urls.joOnly.raw); }

        (async ()=>{
          let html='';
          for(const u of tryList.filter(Boolean)){
            const t = await fetchTextDirectOrProxy(u);
            if(t && t.length>20 && !isFailPage(t)){ html = t; break; }
          }
          if(!html){
            const full = await fetchTextDirectOrProxy(buildLawFullHTMLURL(lawId));
            if(full && full.length>200 && !isFailPage(full)){
              const key = `제${parseInt(it.jo||'0',10)}조` + (it.joi?`의${parseInt(it.joi,10)}`:'');
              const idx = full.indexOf(key);
              if(idx>=0){
                const sn = full.substring(Math.max(0, idx-400), Math.min(full.length, idx+1600));
                html = wrapRender(`${it.disp||it.lawName} · ${it.raw}`, sn);
              }
            }
          }
          if(!html){
            const sn = await fetchPublicLawSnippet(it.disp||it.lawName, parseInt(it.jo||'0',10), it.joi?parseInt(it.joi,10):null);
            if(sn) html = sn;
          }
          if(html){
            const box = document.createElement('div'); box.innerHTML = html;
            li.appendChild(box);
          }
        })();
      }else{
        const fullURL = buildLawFullHTMLURL(lawId);
        const a = document.createElement('div');
        a.innerHTML = `• 전체 본문: <a target="_blank" rel="noopener" href="${fullURL}">law(HTML)</a>`;
        li.appendChild(a);
      }
    }
  }

  /** ========== 툴팁(핵심) ========== **/
  const tip = (()=>{ const el=document.createElement('div'); el.className='tooltip'; el.innerHTML='<div class="hdr"></div><div class="cnt"><span class="loading">불러오는 중…</span></div>'; document.body.appendChild(el); return el; })();
  function tipShow(title, html, x, y){
    tip.querySelector('.hdr').textContent=title||''; tip.querySelector('.cnt').innerHTML=html||'';
    tip.style.display='block'; tipPos(x,y);
  }
  function tipPos(x,y){
    const pad=12; const vw=innerWidth, vh=innerHeight; const r=tip.getBoundingClientRect();
    let left=x+pad, top=y+pad; if(left+r.width>vw-8) left=vw-r.width-8; if(top+r.height>vh-8) top=y-r.height-pad; if(top<8) top=8;
    tip.style.left=left+'px'; tip.style.top=top+'px';
  }
  function tipHide(){ tip.style.display='none'; }

  document.addEventListener('mousemove', (e)=>{ if(tip.style.display==='block') tipPos(e.clientX,e.clientY); });
  document.addEventListener('mouseover', (e)=>{ const b=e.target.closest('.item b'); if(!b) return; hoverFetchAndShow(b, e); });
  document.addEventListener('mouseout', (e)=>{ if(e.target.closest('.item b')) tipHide(); });

  const __lawIdCache = Object.create(null);

  async function hoverFetchAndShow(bEl, ev){
    try{
      const host = bEl.closest('.item'); if(!host) return;
      let nameInParen = host.querySelector('.small')?.textContent?.trim() || '';
      let lawName = (nameInParen.match(/\((.+)\)/)||[])[1] || nameInParen || '';
      lawName = refineLawName(lawName); if(!lawName) return;

      const rawB = (bEl.textContent || '').replace(/\u00A0/g,' ').trim();
      let jo=null, joi=null, hang=null, ho=null;

      let m = EXPL_RE.exec(rawB); EXPL_RE.lastIndex = 0;
      if(!m){ const combo2 = `${lawName} ${rawB}`; m = EXPL_RE.exec(combo2); EXPL_RE.lastIndex = 0; }
      if(m){ jo = m[2]||null; joi = m[3]||null; hang = m[4]||null; ho = m[5]||null; }

      if(!jo){ tipShow(`${lawName} · ${rawB}`, `<div class="err">조 번호를 해석하지 못했습니다.</div>`, ev.clientX, ev.clientY); return; }

      tipShow(`${lawName} · ${rawB}`, '<span class="loading">불러오는 중…</span>', ev.clientX, ev.clientY);

      let lawId = __lawIdCache[lawName];
      if(!lawId){ const row = await searchLawRow(lawName); lawId = row && (row.법령ID||row.id); if(lawId) __lawIdCache[lawName]=lawId; }
      if(!lawId){ tipShow(`${lawName} · ${rawB}`, `<div class="err">법령ID를 찾지 못했습니다.</div>`, ev.clientX, ev.clientY); return; }

      const item={ jo:String(jo).padStart(6,'0'), hang:hang?String(hang).padStart(6,'0'):null, ho:ho?String(ho).padStart(6,'0'):null, joi:joi?String(joi).padStart(6,'0'):null };
      const urls=buildLawJoSubURLs(lawId, item);
      const tryList=[];
      const noHangHasHo=(!item.hang && !!item.ho);
      if(noHangHasHo && urls.joH0) tryList.push(urls.joH0.pad);
      if(urls.jhHo){ if(urls.jhHo.pad) tryList.push(urls.jhHo.pad); if(urls.jhHo.raw) tryList.push(urls.jhHo.raw); }
      if(urls.joHo){ if(urls.joHo.pad) tryList.push(urls.joHo.pad); if(urls.joHo.raw) tryList.push(urls.joHo.raw); }
      if(urls.joOnly){ if(urls.joOnly.pad) tryList.push(urls.joOnly.pad); if(urls.joOnly.raw) tryList.push(urls.joOnly.raw); }

      let html=null;
      for(const u of tryList.filter(Boolean)){
        const t = await fetchTextDirectOrProxy(u);
        if(t && t.length>20 && !isFailPage(t)){ html = t; break; }
      }
      if(!html){
        const full = await fetchTextDirectOrProxy(buildLawFullHTMLURL(lawId));
        if(full && full.length>200 && !isFailPage(full)){
          const key = `제${parseInt(jo,10)}조` + (joi?`의${parseInt(joi,10)}`:'');
          const idx = full.indexOf(key);
          if(idx>=0){
            html = full.substring(Math.max(0, idx-400), Math.min(full.length, idx+1600));
          }
        }
      }
      if(!html){
        const sn = await fetchPublicLawSnippet(lawName, parseInt(jo,10), joi?parseInt(joi,10):null);
        if(sn) html = sn;
      }

      tipShow(`${lawName} · ${rawB}`, html || '<div class="err">조문을 불러오지 못했습니다.</div>', ev.clientX, ev.clientY);
    }catch(e){
      tipShow('오류', `<div class="err">${e+''}</div>`, ev.clientX, ev.clientY);
    }
  }

  /** ========== 버튼 바인딩 & 테스트 ========== **/
  document.addEventListener('DOMContentLoaded', function(){
    byId('run')?.addEventListener('click', handleRun);
    byId('clear')?.addEventListener('click', ()=>{ byId('foundList').innerHTML=''; byId('resList').innerHTML=''; });
    byId('runTests')?.addEventListener('click', ()=>{
      const sample = [
        '건축법 제22조, 같은법 제23조, 동법시행령 제9조의2 제3항을 적용한다.',
        '또한 「유아교육법」 제2조제2호, 「초·중등교육법」 제2조 및 「고등교육법」 제2조를 따른다.',
        '같은 법 시행령 제9조의2 제1항을 적용한다.',
        '그리고 별표 1과 부칙 1을 참고한다.',
        '… 2025. 6. 30.까지 유아교육법 제30조를 준용한다.',
        '오타 테스트: 영유아교육법 제1조 (→ 유아교육법/영유아보육법 자동 보정)'
      ].join(' ');
      byId('input').value = sample;
      handleRun();
      byId('testOutput').innerHTML = '샘플 본문으로 실행했습니다. (오타/유사명 자동 보정, 프록시 폴백 포함)';
    });
  });
})();
</script>
</body>
</html>
