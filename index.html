<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>법조문 자동 추출·검색 · 고급버전 (OC=bro3362)</title>
<style>
  :root{--bg:#0b1020;--panel:#11172c;--muted:#8492b5;--line:#1f2a49;--accent:#5b8cff;--txt:#e6ecff}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  h1{font-size:1.35rem;margin:0 0 8px}
  .hint{color:var(--muted);font-size:.95rem;margin-bottom:16px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  textarea{width:100%;min-height:210px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1731;color:#e6ecff}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1731;color:#e6ecff;min-width:260px}
  button{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
  button.secondary{background:#445b9c}
  button:disabled{opacity:.6;cursor:not-allowed}
  .tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border:1px solid var(--line);background:#0f1731;border-radius:999px;color:#c9d6ff;font-size:.8rem}
  .result h2{margin:0 0 8px}
  ol{margin:0;padding-left:20px}
  .k{color:#9fb4ff}
  .small{font-size:.9rem;color:#9aa8ce}
  .item{padding:10px;border-top:1px dashed var(--line)}
  .monos{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0f1731;border-radius:6px;padding:0 6px}
  .render{margin-top:8px;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .render .hdr{display:flex;justify-content:space-between;align-items:center;background:#0f1731;padding:8px 10px;border-bottom:1px solid var(--line)}
  .render .body{padding:10px;max-height:360px;overflow:auto;background:#0c1330}
  a{color:#9ec1ff}
  .tests{margin-top:18px}
  .pass{color:#22c55e}
  .fail{color:#ef4444}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1731;border:1px solid var(--line);color:#c9d6ff;font-size:.8rem}

  /* Modal viewer */
  .viewer{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .viewer.on{display:flex}
  .viewer .box{width:min(1100px,96vw);height:min(80vh,900px);background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
  .viewer .hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#0f1731;border-bottom:1px solid var(--line)}
  .viewer .body{flex:1;overflow:auto;background:#0c1330;padding:12px}
  .viewer .close{background:#3b4977}
  mark.hl{background:#fde047;color:#111;padding:0 .2em;border-radius:3px}

  /* Hover tooltip */
  .tooltip{position:fixed;max-width:560px;max-height:360px;overflow:auto;background:#0f1731;color:#e6ecff;border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.45);padding:10px;z-index:60;display:none}
  .tooltip .hdr{font-weight:600;margin-bottom:6px;color:#cfe0ff}
  .tooltip .cnt{font-size:.92rem;line-height:1.45}
  .tooltip .loading{color:#9aa8ce}
  .tooltip .err{color:#ef4444}
</style>
</head>
<body>
<div class="wrap">
  <h1>법조문 자동 추출·검색 · <span class="k">고급버전</span> <span class="small">(OC=bro3362 고정)</span></h1>
  <div class="hint">본문의 법령 인용을 인식하고, <b>같은 법/같은법/동법</b>, <b>동법 시행령/같은 법 시행령/이 영/동 시행령</b> 맥락 참조까지 해석합니다. <b>제○조의○</b>·<b>부칙</b>·<b>별표</b> 인용도 처리하며, <b>프록시</b>를 제공하면 조문 본문을 화면에 바로 렌더링합니다.</div>

  <div class="grid">
    <div>
      <div class="card">
        <label for="input"><b>본문 입력</b></label>
        <textarea id="input" placeholder="예) 건축법 제22조, 같은법 제23조, 동법시행령 제9조의2 제3항 …"></textarea>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="row"><span class="badge">OC: bro3362 (고정)</span></div>
        <div class="row"><label>프록시(고정)</label><input id="proxy" type="text" value="https://law-proxy.hyok96.workers.dev/?url=" readonly /></div>
        <div class="row"><button id="run">추출·검색</button><button class="secondary" id="clear">지우기</button><button class="secondary" id="runTests">테스트 실행</button></div>
        <div class="small">• 브라우저 CORS 때문에 응답을 읽지 못할 수 있습니다. 이때도 링크는 생성됩니다. 프록시를 지정하면 본문 렌더링이 활성화됩니다.</div>
      </div>
    </div>
  </div>

  <div class="card" id="foundBox">
    <h2>추출된 인용</h2>
    <ol id="foundList"></ol>
  </div>

  <div class="card result" id="resBox">
    <h2>검색 결과 (위에서부터 순서대로 표시)</h2>
    <ol id="resList"></ol>
  </div>

  <div class="card tests">
    <h2>내장 테스트</h2>
    <div id="testOutput" class="small">[테스트 대기 중]</div>
  </div>
</div>

<!-- Modal viewer for full law + scroll/highlight -->
<div id="viewer" class="viewer" aria-hidden="true">
  <div class="box">
    <div class="hdr">
      <div id="viewerTitle">로컬 전체(스크롤)</div>
      <button class="close" onclick="document.getElementById('viewer').classList.remove('on');document.getElementById('viewer').setAttribute('aria-hidden','true')">닫기</button>
    </div>
    <div id="viewerBody" class="body"></div>
  </div>
</div>

<script>
(function(){
  'use strict';

  /** ===================== 상수/도우미 ===================== **/
  const DRF = 'http://www.law.go.kr/DRF';
  const OC  = 'bro3362'; // OC 고정값
  let lastAuthFail = false; // 직전 DRF 호출에서 인증오류 감지 여부

  const enc = s => encodeURIComponent(s);
  const byId = id => document.getElementById(id);

  function buildURL(path, params){
    const u = new URL(DRF + path);
    Object.entries(params).forEach(([k,v])=>{ if(v!=null && v!=='') u.searchParams.set(k,v); });
    return u.toString();
  }
  function withProxy(url){
    // 고정 프록시
    const baseDefault = 'https://law-proxy.hyok96.workers.dev/?url=';
    let base = byId('proxy')?.value?.trim() || baseDefault;
    if(!base.includes('?')) base += (base.endsWith('/') ? '' : '/') + '?';
    if(!/\burl=/.test(base)) base += 'url=';
    return base + enc(url);
  }
  function isAuthFailText(txt){ return /사용자인증에 실패하였습니다/.test(txt||''); }
  function publicSearchURL(name){ return 'https://www.law.go.kr/LSW/lsSc.do?menuId=1&query=' + enc(name); }
  function publicLawURL(name){ return 'https://www.law.go.kr/법령/' + enc(name); }

  async function fetchText(url){
    const r = await fetch(withProxy(url));
    const text = await r.text();
    return { ok: r.ok, status: r.status, text, ct: (r.headers.get('content-type')||'') };
  }

  // 이름 정규화(검색용) & 표시용 가공
  function canonName(s){
    return (s||'')
      .replace(/[\s"“”'‘’\[\]\(\)「」]/g,'')
      .replace(/[·ㆍ]/g,'');
  }
  function displayName(s){
    return (s||'').replace(/[\"“”'‘’\[\]\(\)「」]/g,'').trim();
  }

  /** ===================== 고급 인용 추출 ===================== **/
  const LAW_BASE = `[가-힣A-Za-z0-9·ㆍ\\s]+?법`;
  const LAW_EO   = `(?:시행령|시행규칙)`;
  const LAW_FULL = `(${LAW_BASE}(?:\\s*${LAW_EO})?)`;
  const D   = `\\d+`;
  const MOK = `([가-하])목`;
  const JO  = `제\\s*(${D})(?:\\s*조(?:의\\s*(${D}))?)?`;
  const HANG= `(?:\\s*제?\\s*(${D})\\s*항)?`;
  const HO  = `(?:\\s*제?\\s*(${D})\\s*호)?`;
  const MOKRE = `(?:\\s*(${MOK}))?`;
  const EXPL_RE = new RegExp(`${LAW_FULL}\\s*${JO}${HANG}${HO}${MOKRE}`, 'g');
  const QUOTED_RE = /「\s*([가-힣A-Za-z0-9·ㆍ\s]+?법(?:\s*(?:시행령|시행규칙))?)\s*」\s*제\s*(\d+)\s*조(?:\s*의\s*(\d+))?(?:\s*제?\s*(\d+)\s*항)?(?:\s*제?\s*(\d+)\s*호)?(?:\s*([가-하])\s*목)?/g;

  const CTX_KEY = {
    BASE: /(같은\s*법|이\s*법|동\s*법)/g,
    SL: /(동\s*법\s*시행령|같은\s*법\s*시행령|이\s*영|동\s*시행령)/g,
    SK: /(동\s*법\s*시행규칙|같은\s*법\s*시행규칙|이\s*규칙|동\s*규칙)/g
  };
  const BYEOLPYO_RE = /(?:별표|[별附]표)\\s*(\\d+)?/g;
  const BUCHIK_RE   = /부칙\\s*(\\d+)?/g;

  function tokenizeForContext(text){
    return text.replace(/[\u00A0\t\r\n]+/g,' ').split(/(?<=[.!?。]|[)\]\}])\s+|\s{2,}/);
  }
  function pad6(n){ return String(parseInt(n,10)).padStart(6,'0'); }

  let lastExplicitBase = { 법:null, 영:null, 규:null };

  function updateBaseFromName(disp){
    if(/시행령$/.test(disp)){ lastExplicitBase.영 = disp; lastExplicitBase.법 = disp.replace(/시행령$/, ''); lastExplicitBase.규 = lastExplicitBase.법 + '시행규칙'; }
    else if(/시행규칙$/.test(disp)){ lastExplicitBase.규 = disp; lastExplicitBase.법 = disp.replace(/시행규칙$/, ''); lastExplicitBase.영 = lastExplicitBase.법 + '시행령'; }
    else { lastExplicitBase.법 = disp; lastExplicitBase.영 = disp + '시행령'; lastExplicitBase.규 = disp + '시행규칙'; }
  }

  function resolveContextualName(token){
    if(CTX_KEY.BASE.test(token)) return lastExplicitBase?.법 || null;
    if(CTX_KEY.SL.test(token))   return lastExplicitBase?.영 || (lastExplicitBase?.법 ? lastExplicitBase.법 + '시행령' : null);
    if(CTX_KEY.SK.test(token))   return lastExplicitBase?.규 || (lastExplicitBase?.법 ? lastExplicitBase.법 + '시행규칙' : null);
    return null;
  }

  function pushUnique(seen, arr, obj){
    const key = [obj.lawName, obj.jo||'', obj.joi||'', obj.hang||'', obj.ho||'', obj.mok||'', obj.kind||''].join('|');
    if(seen.has(key)) return; seen.add(key); arr.push(obj);
  }

  function extractCitationsAdvanced(text){
    const tokens = tokenizeForContext(text);
    const cites = [];
    const seen = new Set();

    for(const t of tokens){
      let m0; const LAW_NAME_ONLY_RE = new RegExp(LAW_FULL, 'g');
      while((m0 = LAW_NAME_ONLY_RE.exec(t))){
        const rawName = m0[1];
        const disp = displayName(rawName);
        updateBaseFromName(disp);
      }

      let q; while((q = QUOTED_RE.exec(t))){
        const [raw, rawName, joNum, joUi, hang, ho, mokChar] = q;
        const disp = displayName(rawName);
        pushUnique(seen, cites, { raw, lawName: canonName(disp), disp, jo: pad6(joNum), joi: joUi?pad6(joUi):null, hang: hang?pad6(hang):null, ho: ho?pad6(ho):null, mok: mokChar||null, kind:'article' });
        updateBaseFromName(disp);
      }

      let m; while((m = EXPL_RE.exec(t))){
        const [raw, rawName, joNum, joUi, hang, ho, mokAll] = m;
        const disp = displayName(rawName);
        pushUnique(seen, cites, { raw, lawName: canonName(disp), disp, jo: joNum?pad6(joNum):null, joi: joUi?pad6(joUi):null, hang: hang?pad6(hang):null, ho: ho?pad6(ho):null, mok: mokAll?mokAll.match(/[가-하]/)?.[0]||null:null, kind:'article' });
        updateBaseFromName(disp);
      }

      const CTX_RE = new RegExp(`((?:같은\\s*법|이\\s*법|동\\s*법|동\\s*법\\s*시행령|같은\\s*법\\s*시행령|이\\s*영|동\\s*시행령|동\\s*법\\s*시행규칙|같은\\s*법\\s*시행규칙|이\\s*규칙|동\\s*규칙))\\s*${JO}${HANG}${HO}${MOKRE}`, 'g');
      while((m = CTX_RE.exec(t))){
        const [raw, ctxWord, joNum, joUi, hang, ho, mokAll] = m;
        const resolved = resolveContextualName(ctxWord);
        if(!resolved) continue;
        const disp = displayName(resolved);
        pushUnique(seen, cites, { raw, lawName: canonName(disp), disp, jo: joNum?pad6(joNum):null, joi: joUi?pad6(joUi):null, hang: hang?pad6(hang):null, ho: ho?pad6(ho):null, mok: mokAll?mokAll.match(/[가-하]/)?.[0]||null:null, kind:'article' });
      }

      let bp; while((bp = BYEOLPYO_RE.exec(t))){
        const target = lastExplicitBase.법 || lastExplicitBase.영 || lastExplicitBase.규; if(!target) continue;
        pushUnique(seen, cites, { raw: bp[0], lawName: canonName(target), disp: displayName(target), kind:'annex', annexNo: bp[1]||null });
      }
      let bc; while((bc = BUCHIK_RE.exec(t))){
        const target = lastExplicitBase.법 || lastExplicitBase.영 || lastExplicitBase.규; if(!target) continue;
        pushUnique(seen, cites, { raw: bc[0], lawName: canonName(target), disp: displayName(target), kind:'supplement', suppNo: bc[1]||null });
      }
    }
    return cites;
  }

  /** ===================== DRF API ===================== **/
  async function searchLawRow(oc, lawQuery){
    lastAuthFail = false;
    const url = buildURL('/lawSearch.do', { OC:oc, target:'law', type:'JSON', query:lawQuery, display:10 });
    try{
      const { status, text } = await fetchText(url);
      if(isAuthFailText(text) || status===401 || status===403){ lastAuthFail = true; return null; }

      let data = null; try{ data = JSON.parse(text); }catch(e){ }
      const root = (data && data.LawSearch) ? data.LawSearch : data;

      let rows = [];
      if(root && root.law){
        if(Array.isArray(root.law)) rows = root.law;
        else if(typeof root.law === 'object') rows = [root.law];
      }
      if(!rows.length) return null;

      const clean = s => canonName(s||'');
      const exact = rows.find(x => clean(x.법령명한글) === clean(lawQuery));
      return (exact || rows[0]);
    }catch(e){ console.warn('searchLawRow error', e); }
    return null;
  }

  function buildLawJoSubURLs(oc,id,item){
    const baseParams = { OC: oc, target: 'lawjosub', type: 'HTML', ID: id };
    const makeUrl = (extra) => {
      const u = new URL(DRF + '/lawService.do');
      Object.entries(baseParams).forEach(([k,v])=>u.searchParams.set(k,v));
      Object.entries(extra||{}).forEach(([k,v])=>{ if(v!=null && v!=='') u.searchParams.set(k,v); });
      return u.toString();
    };
    const pad = v => v ? String(parseInt(v,10)).padStart(6,'0') : null;
    const raw = v => v ? String(parseInt(v,10)) : null;

    const hasHang = !!item.hang;
    const hasHo   = !!item.ho;

    const joOnly = { pad: makeUrl({ JO: pad(item.jo) }), raw: makeUrl({ JO: raw(item.jo) }) };
    const joHo = hasHo ? { pad: makeUrl({ JO: pad(item.jo), HO: pad(item.ho) }), raw: makeUrl({ JO: raw(item.jo), HO: raw(item.ho) }) } : null;
    const joHoHangZero = hasHo ? { pad: makeUrl({ JO: pad(item.jo), HANG: '000000', HO: pad(item.ho) }) } : null;
    const joHangHo = hasHang ? { pad: makeUrl({ JO: pad(item.jo), HANG: pad(item.hang), ...(hasHo?{HO:pad(item.ho)}:{}) }), raw: makeUrl({ JO: raw(item.jo), HANG: raw(item.hang), ...(hasHo?{HO:raw(item.ho)}:{}) }) } : null;
    return { joOnly, joHo, joHoHangZero, joHangHo };
  }

  function buildLawFullHTMLURL(oc,id){
    return buildURL('/lawService.do', { OC:oc, target:'law', type:'HTML', ID:id });
  }

  /** ===================== 렌더링 ===================== **/
  function addFoundItem(el, it){
    const li = document.createElement('li');
    li.innerHTML = `<span class="tag">${it.disp||it.lawName}</span> <span class="monos">${(it.raw||'').trim()}</span>`;
    el.appendChild(li);
  }
  function wrapRender(title, inner){
    return `<div class="render"><div class="hdr"><div>${title}</div></div><div class="body">${inner}</div></div>`;
  }

  async function handleRun(){
    const text    = byId('input').value;
    const foundUl = byId('foundList');
    const resUl   = byId('resList');
    foundUl.innerHTML = ''; resUl.innerHTML = '';

    if(!text.trim()){ alert('본문을 입력해 주세요.'); return; }

    lastExplicitBase = { 법:null, 영:null, 규:null };

    const items = extractCitationsAdvanced(text);
    const filtered = items.filter(it => it.kind==='article' || it.kind==='annex' || it.kind==='supplement');
    if(!filtered.length){
      foundUl.innerHTML = '<li>특정 가능한 법조문 인용을 찾지 못했습니다. (예: "○○법 제3조의2 제1항" 또는 "같은법 제5조" 또는 "동법시행령 제9조" 또는 "별표 1")</li>';
      return;
    }
    filtered.forEach(it=> addFoundItem(foundUl, it));

    for(const it of filtered){
      const li = document.createElement('li'); li.className='item';
      li.innerHTML = `<div><b>${it.raw||it.disp||it.lawName}</b> <span class="small">(${it.disp||it.lawName})</span><div class="small">검색 중...</div></div>`;
      resUl.appendChild(li);

      const row = await searchLawRow(OC, it.lawName);
      if(!row){
        const publicSearch = publicSearchURL(it.disp||it.lawName);
        const publicDirect = publicLawURL(it.disp||it.lawName);
        const drfList = buildURL('/lawSearch.do', { OC:OC, target:'law', type:'HTML', query:it.disp||it.lawName, display:10 });
        li.innerHTML = `<div><b>${it.raw||it.disp||it.lawName}</b> <span class="small">(${it.disp||it.lawName})</span></div>
          <div class="small">${ lastAuthFail ? 'API 인증 실패(OC 만료/오입력 가능). 퍼블릭 링크를 제공합니다.' : '법령ID 검색 실패(CORS/무일치). 퍼블릭 링크를 제공합니다.' }</div>
          <div>• 퍼블릭 검색: <a target="_blank" rel="noopener" href="${publicSearch}">국가법령정보(사이트) 검색</a></div>
          <div>• 법령 페이지(추정): <a target="_blank" rel="noopener" href="${publicDirect}">${it.disp||it.lawName}</a></div>
          <div class="small">(참고) DRF 목록: <a target="_blank" rel="noopener" href="${drfList}">lawSearch</a></div>`;
        continue;
      }

      const lawId = row.법령ID || row.id || '';
      const lsiSeq = row.법령일련번호 || '';
      const serviceLink = row.법령상세링크 ? ('https://www.law.go.kr' + row.법령상세링크) : '';
      const humanSite = publicLawURL(it.disp||it.lawName);

      if(it.kind==='article'){
        const urls = buildLawJoSubURLs(OC, lawId, it);
        const tryUrlsArr = [];
        if(urls.joHangHo){ if(urls.joHangHo.pad) tryUrlsArr.push(urls.joHangHo.pad); if(urls.joHangHo.raw) tryUrlsArr.push(urls.joHangHo.raw); }
        if(urls.joHoHangZero){ if(urls.joHoHangZero.pad) tryUrlsArr.push(urls.joHoHangZero.pad); }
        if(urls.joHo){ if(urls.joHo.pad) tryUrlsArr.push(urls.joHo.pad); if(urls.joHo.raw) tryUrlsArr.push(urls.joHo.raw); }
        if(urls.joOnly){ if(urls.joOnly.pad) tryUrlsArr.push(urls.joOnly.pad); if(urls.joOnly.raw) tryUrlsArr.push(urls.joOnly.raw); }
        let rendered = '';
        try{
          if(byId('proxy').value.trim()){
            const tryList = [];
            const noHangHasHo = (!it.hang && !!it.ho);
            if(noHangHasHo && urls.joHoHangZero){ tryList.push(urls.joHoHangZero.pad); }
            if(urls.joHangHo){ tryList.push(urls.joHangHo.pad, urls.joHangHo.raw); }
            if(urls.joHo){ tryList.push(urls.joHo.pad, urls.joHo.raw); }
            if(urls.joOnly){ tryList.push(urls.joOnly.pad, urls.joOnly.raw); }
            for(const u of tryList.filter(Boolean)){
              const html = (await fetchText(u)).text;
              if(html && html.length>60){ rendered = wrapRender(`${it.disp||it.lawName} · ${it.raw}`, html); break; }
            }
          }
        }catch(e){ console.warn('render fail', e); }

        // 링크 세트 출력
        const links = [];
        const noHangHasHo = (!it.hang && !!it.ho);
        if(noHangHasHo && urls.joHoHangZero){ links.push(`• API(권장·조+호+HANG=000000): <a title=\"항이 없는 조문에서 호만 있는 경우 권장\" target=\"_blank\" rel=\"noopener\" href=\"${urls.joHoHangZero.pad}\">HTML</a>`); }
        if(urls.joHo){ links.push(`• API(조+호, 0패딩/RAW): <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joHo.pad}\">HTML</a> | <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joHo.raw}\">RAW</a>`); }
        if(urls.joHangHo){ links.push(`• API(조+항${it.ho?'+호':''}, 0패딩): <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joHangHo.pad}\">lawjosub(HTML)</a>${urls.joHangHo.raw?` | <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joHangHo.raw}\">RAW</a>`:''}`); }
        if(urls.joOnly){ links.push(`• API(조만, 0패딩/RAW): <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joOnly.pad}\">HTML</a> | <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joOnly.raw}\">RAW</a>`); }

        li.innerHTML = `<div><b>${it.raw}</b> <span class=\"small\">(${it.disp||it.lawName})</span></div>
          <div class=\"small\">법령ID: ${lawId}${lsiSeq ? ` · 일련번호(lsiSeq): ${lsiSeq}`:''}</div>
          ${links.map(l=>`<div>${l}</div>`).join('')}
          <div>• 로컬: <a href=\"#\" onclick=\"window.openLocalFullWithScroll({lawId: '${lawId}', title: '${(it.disp||it.lawName)}', tryUrls: ${JSON.stringify(tryUrlsArr)}, jo:'${it.jo||''}', joi:'${it.joi||''}', hang:'${it.hang||''}', ho:'${it.ho||''}'}); return false;\">전체(스크롤/하이라이트)</a> <span class=\"small\">(프록시 필요)</span></div>
          <div>• 원문: <a target=\"_blank\" rel=\"noopener\" href=\"${humanSite}\">사이트 상세(현행)</a>${serviceLink?` · <a target=\"_blank\" rel=\"noopener\" href=\"${serviceLink}\">DRF 상세링크</a>`:''}</div>
          ${rendered||''}`;

        // ★ Hover용 데이터 주입 (이 li 전체에 데이터 저장, b 요소에 마우스 올리면 팝업)
        li.dataset.kind = 'article';
        li.dataset.lawid = lawId;
        li.dataset.lawname = (it.disp||it.lawName);
        li.dataset.jo = it.jo||''; li.dataset.joi = it.joi||''; li.dataset.hang = it.hang||''; li.dataset.ho = it.ho||'';
      } else {
        const fullURL = buildLawFullHTMLURL(OC, lawId);
        const label = it.kind==='annex' ? `별표 ${it.annexNo||''}` : (it.kind==='supplement' ? `부칙 ${it.suppNo||''}` : '전체 본문');
        let rendered = '';
        try{
          if(byId('proxy').value.trim()){
            const html = (await fetchText(fullURL)).text;
            if(html && html.length>120){
              if(it.kind==='annex'){
                const idx = html.indexOf('별표'); if(idx>=0){ rendered = wrapRender(`${it.disp||it.lawName} · ${label}`, html.substring(Math.max(0,idx-400), Math.min(html.length, idx+1200))); }
              }else if(it.kind==='supplement'){
                const idx2 = html.indexOf('부칙'); if(idx2>=0){ rendered = wrapRender(`${it.disp||it.lawName} · ${label}`, html.substring(Math.max(0,idx2-400), Math.min(html.length, idx2+1200))); }
              }else{
                rendered = wrapRender(`${it.disp||it.lawName} · 전체 본문`, html.substring(0,2000));
              }
            }
          }
        }catch(e){ console.warn('render2 fail', e); }

        li.innerHTML = `<div><b>${label||it.disp||it.lawName}</b> <span class="small">(${it.disp||it.lawName})</span></div>
          <div class="small">법령ID: ${lawId}${lsiSeq ? ` · 일련번호(lsiSeq): ${lsiSeq}`:''}</div>
          <div>• 전체 본문: <a target="_blank" rel="noopener" href="${fullURL}">law(HTML)</a> | 원문: <a target="_blank" rel="noopener" href="${humanSite}">사이트 상세(현행)</a>${serviceLink?` · <a target="_blank" rel="noopener" href="${serviceLink}">DRF 상세링크</a>`:''}</div>
          ${rendered||''}`;
      }
    }
  }

  /** ===================== Hover Tooltip 로직 ===================== **/
  const tipEl = (()=>{ const el=document.createElement('div'); el.className='tooltip'; el.innerHTML='<div class="hdr"></div><div class="cnt"><span class="loading">불러오는 중…</span></div>'; document.body.appendChild(el); return el; })();
  function showTip(title, html, x, y){ tipEl.querySelector('.hdr').textContent=title||''; tipEl.querySelector('.cnt').innerHTML=html||''; tipEl.style.display='block'; posTip(x,y); }
  function posTip(x,y){ const pad=12; const vw=window.innerWidth, vh=window.innerHeight; const r=tipEl.getBoundingClientRect(); let left=x+pad, top=y+pad; if(left+r.width>vw-8) left=vw-r.width-8; if(top+r.height>vh-8) top=y-r.height-pad; if(top<8) top=8; tipEl.style.left=left+'px'; tipEl.style.top=top+'px'; }
  function hideTip(){ tipEl.style.display='none'; }
  async function fetchArticleHTML(lawId, jo, hang, ho, joi){ const item={jo,hang,ho,joi}; const urls=buildLawJoSubURLs(OC, lawId, item); const tryList=[]; const noHangHasHo=(!hang && !!ho); if(noHangHasHo && urls.joHoHangZero){ tryList.push(urls.joHoHangZero.pad); } if(urls.joHangHo){ if(urls.joHangHo.pad) tryList.push(urls.joHangHo.pad); if(urls.joHangHo.raw) tryList.push(urls.joHangHo.raw); } if(urls.joHo){ if(urls.joHo.pad) tryList.push(urls.joHo.pad); if(urls.joHo.raw) tryList.push(urls.joHo.raw); } if(urls.joOnly){ if(urls.joOnly.pad) tryList.push(urls.joOnly.pad); if(urls.joOnly.raw) tryList.push(urls.joOnly.raw); } for(const u of tryList.filter(Boolean)){ try{ const html=(await fetchText(u)).text; if(html && html.length>60) return html; }catch(e){} } return '<div class="err">조문을 불러오지 못했습니다.</div>'; }
  document.addEventListener('mousemove', (e)=>{ if(tipEl.style.display==='block') posTip(e.clientX,e.clientY); });
  document.addEventListener('mouseover', async (e)=>{ const b=e.target.closest('.item b'); if(!b) return; const host=b.closest('.item'); if(!host) return; if(host.dataset.kind!=="article") return; const {lawid,lawname,jo,hang,ho,joi}=host.dataset; showTip(`${lawname} · ${b.textContent}`, '<span class="loading">불러오는 중…</span>', e.clientX, e.clientY); const html=await fetchArticleHTML(lawid, jo||'', hang||'', ho||'', joi||''); showTip(`${lawname} · ${b.textContent}`, html, e.clientX, e.clientY); });
  document.addEventListener('mouseout', (e)=>{ if(e.target.closest('.item b')) hideTip(); });

  /** ===================== 바인딩 ===================== **/
  document.addEventListener('DOMContentLoaded', function(){
    const runBtn   = byId('run');
    const clearBtn = byId('clear');
    const testsBtn = byId('runTests');
    if(runBtn)   runBtn.addEventListener('click', handleRun);
    if(clearBtn) clearBtn.addEventListener('click', ()=>{ byId('foundList').innerHTML=''; byId('resList').innerHTML=''; });
    if(testsBtn) testsBtn.addEventListener('click', runBuiltInTests);
  });

  /** ===================== 내장 테스트 ===================== **/
  function expect(name, cond){ return (cond?`✅ <span class="pass">PASS</span>`:`❌ <span class="fail">FAIL</span>`) + ` — ${name}`; }
  function runBuiltInTests(){
    const out = byId('testOutput');
    const sample = [
      '건축법 제22조, 같은법 제23조, 동법시행령 제9조의2 제3항을 적용한다.',
      '또한 「유아교육법」 제2조제2호, 「초·중등교육법」 제2조 및 「고등교육법」 제2조를 따른다.',
      '같은 법 시행령 제9조의2 제1항을 적용한다.',
      '그리고 별표 1과 부칙 1을 참고한다.'
    ].join(' ');
    const citesAll = extractCitationsAdvanced(sample);
    const cites = citesAll.filter(it=> it.kind==='article' || it.kind==='annex' || it.kind==='supplement');
    const nm = s => canonName(s);
    const hasArch = cites.some(c=> nm(c.lawName)==='건축법' && c.jo==='000022');
    const hasSame = cites.some(c=> nm(c.lawName)==='건축법' && c.jo==='000023');
    const hasSLArch = cites.some(c=> nm(c.lawName)==='건축법시행령' && c.jo==='000009' && c.joi==='000002' && c.hang==='000003');
    const hasU = cites.some(c=> nm(c.lawName)==='유아교육법' && c.ho==='000002');
    const hasC = cites.some(c=> nm(c.lawName)==='초중등교육법' && c.jo==='000002');
    const hasH = cites.some(c=> nm(c.lawName)==='고등교육법' && c.jo==='000002');
    const hasAnnex = cites.some(c=> c.kind==='annex');
    const hasSupp = cites.some(c=> c.kind==='supplement');
    out.innerHTML = [
      '<b>기본 테스트</b>',
      expect('건축법 제22조 인식', hasArch),
      expect('같은법 → 건축법 제23조', hasSame),
      expect('동법시행령 → 건축법시행령 제9조의2 제3항', hasSLArch),
      expect('유아교육법 제2조제2호 포함', hasU),
      expect('초·중등교육법 제2조 포함', hasC),
      expect('고등교육법 제2조 포함', hasH),
      expect('별표/부칙 인식', (hasAnnex && hasSupp))
    ].join('<br/>');
    byId('input').value = sample;
  }

  /** ===================== 전역 노출 유틸 (모달 스크롤/하이라이트) ===================== **/
  function collapseSpaces(s){ if(!s) return ''; return s.replace(/[\t\n\r]+/g,' ').replace(/\s{2,}/g,' ').trim(); }
  function stripHtmlToText(html){ const d=document.createElement('div'); d.innerHTML=html||''; return collapseSpaces(d.textContent||''); }
  function findAndMark(container, key){ key = collapseSpaces(key||''); if(!key) return null; if(key.length>80) key=key.slice(0,80); const walker=document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null); let node; while((node=walker.nextNode())){ const t=collapseSpaces(node.nodeValue||''); if(!t) continue; const i=t.indexOf(key); if(i>=0){ const span=document.createElement('mark'); span.className='hl'; span.id='__HIT'; const before=document.createTextNode(t.slice(0,i)); const mid=document.createTextNode(t.slice(i,i+key.length)); const after=document.createTextNode(t.slice(i+key.length)); const p=node.parentNode; if(!p) return null; p.replaceChild(after,node); p.insertBefore(span,after); span.appendChild(mid); p.insertBefore(before,span); return span; } } return null; }

  window.openLocalFullWithScroll = async function(opts){ try{ const proxySet=!!(byId('proxy')&&byId('proxy').value.trim()); if(!proxySet){ alert('프록시를 입력해야 전체본문을 불러올 수 있습니다.'); return; } const lawId=opts.lawId; const title=opts.title||''; const tryUrls=opts.tryUrls||[]; let snippetHtml=''; for(let i=0;i<tryUrls.length;i++){ try{ const t=(await fetchText(tryUrls[i])).text; if(t&&t.length>60){ snippetHtml=t; break; } }catch(e){} } const keyText=stripHtmlToText(snippetHtml); const fullURL=buildLawFullHTMLURL(OC, lawId); const fullHtml=(await fetchText(fullURL)).text||''; const modal=byId('viewer'); const body=byId('viewerBody'); const titleEl=byId('viewerTitle'); titleEl.textContent=(title||'')+' · 로컬 전체(스크롤)'; body.innerHTML=fullHtml; modal.classList.add('on'); modal.setAttribute('aria-hidden','false'); setTimeout(function(){ let hit=findAndMark(body,keyText); if(!hit){ const mk=n=> String(parseInt(n||'0',10)); const jb=(opts.jo?('제'+mk(opts.jo)+'조'):'') + (opts.joi?('의'+mk(opts.joi)):''); hit=findAndMark(body,jb); } if(hit){ hit.scrollIntoView({behavior:'smooth',block:'center'}); } },120); }catch(e){ alert('로컬 뷰어 오류: '+e); } }
})();
</script>
</body>
</html>
