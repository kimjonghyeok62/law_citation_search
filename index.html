<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>법조문 자동 추출·검색 (현행 우선 + 폴백, 조례/규칙 Fix)</title>
<style>
  :root{--bg:#0b1020; --panel:#0f152b; --muted:#8ea0c7; --line:#1c2748; --accent:#78a6ff; --accent-2:#9ec1ff; --txt:#eaf1ff; --txt-muted:#aab9dd; --radius:14px; --shadow:0 10px 28px rgba(0,0,0,.32)}
  @media (prefers-color-scheme: light){ :root{ --bg:#f5f7ff; --panel:#fff; --muted:#596180; --line:#e6eaff; --accent:#2e5cff; --accent-2:#4c78ff; --txt:#0c1330; --txt-muted:#5e6a8a; --shadow:0 8px 20px rgba(15,23,52,.08)} }
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
  .wrap{max-width:980px;margin:0 auto;padding:28px}
  header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:18px}
  .title{display:flex;flex-direction:column;gap:6px}
  h1{font-size:1.4rem;margin:0;letter-spacing:.2px}
  .sub{font-size:.92rem;color:var(--txt-muted)}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card.pad{padding:16px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

  textarea{width:100%;min-height:120px;height:140px;padding:12px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--txt);resize:vertical;box-sizing:border-box;line-height:1.45;}
  textarea:focus{outline:none;box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 45%, transparent)}

  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .label{font-weight:600;color:var(--txt-muted);font-size:.92rem}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--txt);min-width:260px}
  input::placeholder{color:var(--muted)}
  .btn{padding:10px 14px;border:1px solid transparent;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer;transition:transform .06s ease,opacity .2s}
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:transparent;color:var(--accent);border-color:color-mix(in oklab, var(--accent) 30%, #0000)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:color-mix(in oklab, var(--accent) 14%, transparent);color:var(--accent-2);border:1px solid var(--line);font-size:.8rem}
  .result{margin-top:18px}
  .result h2{margin:0 0 8px;font-size:1.05rem}

  ol{margin:0;padding-left:20px}
  .item{padding:10px 8px;border-top:1px dashed var(--line)}
  .item-line{display:flex;align-items:center;gap:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .t{font-weight:700;flex:0 0 auto}
  .meta{font-size:.86rem;color:var(--txt-muted);flex:0 0 auto}
  .links{display:flex;gap:10px;flex:0 0 auto}
  .links a,.links button{color:var(--accent-2);text-decoration:none;border:1px dashed color-mix(in oklab, var(--accent) 30%, transparent);background:transparent;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:.86rem;}
  .links a:hover,.links button:hover{text-decoration:underline}

  .mini{font-size:.86rem;color:var(--txt-muted)}
  .right{margin-left:auto}
  .toast{position:fixed;right:18px;bottom:18px;display:none;z-index:50}
  .toast.on{display:block}
  .toast .box{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px 14px;min-width:240px}
  .skeleton{background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.14), rgba(255,255,255,.06));background-size:200% 100%;animation:shimmer 1.1s infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .sk-line{height:14px;border-radius:6px;opacity:.45}
  .sk-gap{height:10px}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100}
  .modal.on{display:flex}
  .modal .panel{max-width:840px;max-height:80vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  .modal h3{margin:0 0 8px;font-size:1.05rem}
  .modal .close{position:sticky;top:0;float:right;border:none;background:transparent;color:var(--txt-muted);cursor:pointer;font-size:1rem}
  .article-body{line-height:1.6}
  .article-body .hang{margin-left:12px}
  .article-body .ho{margin-left:24px}
  .article-body .mok{margin-left:36px}
  .article-body b{color:var(--accent-2)}
  .article-body .hang > b,.article-body .ho > b,.article-body .mok > b{display:none !important;}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>법조문 자동 추출·검색</h1>
      <div class="sub">본문에서 <b>법령/자치법규</b>를 찾아 <b>조문 미리보기</b>와 <b>전체 본문</b> 링크를 제공합니다. <span class="mini">현행 우선, 없으면 비현행도 폴백</span></div>
    </div>
    <div class="badge">OC: bro3362</div>
  </header>

  <div class="grid">
    <section class="card pad">
      <div class="row" style="margin-bottom:8px"><div class="label">본문 입력</div></div>
      <textarea id="input" placeholder="예) 「경기도교육청 행정기구 및 정원 조례」 제5조, 「사립학교법」 제43조 …"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="run" class="btn" type="button">추출·검색</button>
        <button id="clear" class="btn secondary" type="button">지우기</button>
        <span class="mini">Enter(⌥/Alt+Enter는 줄바꿈)</span>
        <span class="right mini">응답이 없을 때 프록시 사용됨</span>
      </div>
    </section>

    <aside class="card pad">
      <div class="row" style="margin-bottom:10px"><div class="label">프록시</div></div>
      <input id="proxy" type="text" value="https://law-proxy.hyok96.workers.dev/?url=" style="width:100%"/>
      <div class="mini" style="margin-top:8px">CORS로 본문을 못 읽을 때 자동으로 프록시를 사용합니다.</div>
    </aside>
  </div>

  <section class="card pad result" id="resBox">
    <h2>검색 결과</h2>
    <ol id="resList"></ol>
  </section>
</div>

<div id="toast" class="toast"><div class="box mini" id="toastMsg">안내</div></div>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="panel">
    <button class="close" id="modalClose" title="닫기" type="button">✕</button>
    <h3 id="modalTitle">조문 전문</h3>
    <div id="modalBody" class="article-body mini">로딩 중…</div>
  </div>
</div>

<script>
(function(){
  'use strict';
  /* ===== Core ===== */
  var DRF='https://www.law.go.kr/DRF';
  var OC='bro3362';
  var $=function(sel){return document.querySelector(sel)};
  var enc=function(s){return encodeURIComponent(s)};
  var pad=function(n,w){return String(parseInt(n,10)).padStart(w,'0')};
  var proxyBase=function(){var pv=$('#proxy'); var v=pv && pv.value ? pv.value.trim() : 'https://law-proxy.hyok96.workers.dev/?url='; return v};
  var buildURL=function(p,params){var u=new URL(DRF+p); Object.keys(params).forEach(function(k){var v=params[k]; if(v!=null&&v!=='') u.searchParams.set(k,v)}); return u.toString()};
  var withProxy=function(url,base){var b=(base||'https://law-proxy.hyok96.workers.dev/?url=').trim(); if(b.indexOf('?')===-1) b+=(b.endsWith('/')?'':'/')+'?'; if(!/\burl=/.test(b)) b+='url='; return b+encodeURIComponent(url)};
  var lawIdCache=new Map();

  function fetchTextDirectOrProxy(url,opts){
    opts=opts||{}; var timeoutMs=opts.timeoutMs||7000;
    var fetchWithTimeout=function(u){
      var ac=new AbortController(); var id=setTimeout(function(){ac.abort()},timeoutMs);
      return fetch(u,{signal:ac.signal}).finally(function(){clearTimeout(id)});
    };
    return fetchWithTimeout(url).then(async function(r){
      if(r.ok){
        var t=await r.text();
        var ct=(r.headers.get('content-type')||'');
        if(ct.indexOf('json')>-1 || t.length>30) return t;
      }
      throw new Error('direct fail');
    }).catch(function(){
      return fetchWithTimeout(withProxy(url,proxyBase())).then(async function(r2){
        if(r2.ok){
          var t2=await r2.text();
          var ct2=(r2.headers.get('content-type')||'');
          if(ct2.indexOf('json')>-1 || t2.length>30) return t2;
        }
        return '';
      }).catch(function(){return ''});
    });
  }

  var isFailPage=function(html){return /페이지\s*접속에\s*실패하였습니다|사용자인증에\s*실패하였습니다|페이지를\s*찾을\s*수\s*없습니다/.test((html||'').replace(/\u00A0/g,' '))};
  var publicLawURL=function(name){return 'https://www.law.go.kr/법령/'+enc(name)};
  var buildLawFullHTMLURL=function(id){return buildURL('/lawService.do',{OC:OC,target:'law',type:'HTML',ID:id})};
  var buildOrdinFullHTMLURL=function(id,mst){var p={OC:OC,target:'ordin',type:'HTML'}; if(mst) p.MST=mst; else if(id) p.ID=id; return buildURL('/lawService.do',p)};

  var joTo6=function(jo,joi){var h=pad(jo,4);return joi?h+pad(joi,2):h+'00'};
  var buildLawArticleURL=function(id,obj){
    var JO=joTo6(obj.jo,obj.joi);
    var HANG=(obj.hang?pad(obj.hang,6):(obj.ho?'000000':''));
    var HO=(obj.ho?pad(obj.ho,6):'');
    var MOK=(obj.mok?String(obj.mok).trim().slice(0,1).replace(/[^가-하]/g,''):'');
    var p={OC:OC,target:'lawjosub',type:'HTML',ID:id,JO:JO};
    if(HANG)p.HANG=HANG; if(HO)p.HO=HO; if(MOK)p.MOK=MOK;
    return buildURL('/lawService.do',p);
  };
  var buildLawArticleXMLURL=function(id,obj){
    var JO=joTo6(obj.jo,obj.joi);
    var HANG=(obj.hang?pad(obj.hang,6):(obj.ho?'000000':''));
    var HO=(obj.ho?pad(obj.ho,6):'');
    var MOK=(obj.mok?String(obj.mok).trim().slice(0,1).replace(/[^가-하]/g,''):'');
    var p={OC:OC,target:'lawjosub',type:'XML',ID:id,JO:JO};
    if(HANG)p.HANG=HANG; if(HO)p.HO=HO; if(MOK)p.MOK=MOK;
    return buildURL('/lawService.do',p);
  };

  /* ===== Normalize & Search ===== */
  var canonName=function(s){return (s||'').replace(/[\s"“”'‘’\[\]\(\)「」]/g,'').replace(/[·ㆍ]/g,'')};
  var displayName=function(s){return (s||'').replace(/["“”'‘’\[\]\(\)「」]/g,'').trim()};

  // ★ FIX: 종결 토큰 판별 정규식 수정 (문자클래스 -> 그룹)
  function refineLawName(name){
    var s=(name||'').trim(); if(!s) return s;
    s=s.replace(/^(?:까지|및|또는|등|관련|관한|따른|에\s*따른|에\s*의한|의)\s+/, '');
    var m=s.match(/^(.*?법(?:률)?)(?:\s*)?(시행령|시행규칙)$/);
    if(m) return (m[1]+' '+m[2]).trim();
    var toks=s.split(/\s+/); var i=-1;
    for(var k=toks.length-1;k>=0;k--){ if(/(법|법률|조례|규칙)$/.test(toks[k])){ i=k; break; } }
    if(i>=0){
      if(toks[i+1] && /^(시행령|시행규칙)$/.test(toks[i+1])) return (toks[i]+' '+toks[i+1]).trim();
      return toks[i];
    }
    return s;
  }

  function generateAlternatives(q){
    var s=displayName(q||'').replace(/\s+/g,'').trim();
    var alts=new Set();
    if(s) alts.add(s.replace(/[^가-힣A-Za-z0-9]/g,''));
    var refined=refineLawName(q); if(refined) alts.add(refined);
    if(q) alts.add(q);
    return Array.from(alts).filter(Boolean);
  }

  // ===== 상태 헬퍼 =====
  var isCurrent = function(v){ return /현행/.test((v||'').trim()); };

  // ===== 국가법령 검색: 현행 우선 → 없으면 비현행 폴백 → 마지막에 HTML도 폴백 =====
  async function tryLawSearchAll(qCanon,qRaw){
    function pick(rows,preferCurrent){
      if(!rows||!rows.length) return null;
      var clean=function(s){return canonName(refineLawName(s||''))};
      var want = clean(qCanon);
      var pool = preferCurrent ? rows.filter(r=>isCurrent(r.status)) : rows.slice();
      if(preferCurrent && !pool.length) pool = rows.slice(); // 비현행 허용
      var exact=pool.find(x=>clean(x.name)===want);
      return exact || pool[0] || null;
    }
    async function j(){
      var url=buildURL('/lawSearch.do',{OC:OC,target:'law',type:'JSON',query:qRaw,display:10});
      var t=await fetchTextDirectOrProxy(url);
      try{
        var d=JSON.parse(t); var root=d&&(d.LawSearch||d);
        var rows=[]; if(root&&root.law){ rows=Array.isArray(root.law)?root.law:[root.law] }
        return rows.map(x=>({kind:'law', name:(x.법령명한글||'').trim(), id:(x.법령ID||'').trim(), lsiSeq:(x.법령일련번호||'').trim(), status:(x.법령상태||'').trim()}));
      }catch(_){ return null; }
    }
    async function x(){
      var url=buildURL('/lawSearch.do',{OC:OC,target:'law',type:'XML',query:qRaw,display:10});
      var t=await fetchTextDirectOrProxy(url);
      try{
        var dom=new DOMParser().parseFromString(t,'text/xml');
        var list=[].slice.call(dom.getElementsByTagName('law'));
        return list.map(n=>{
          var g=(tag)=>{var el=n.getElementsByTagName(tag)[0]; return el? (el.textContent||'').trim() : ''};
          return {kind:'law', name:g('법령명한글'), id:g('법령ID'), lsiSeq:g('법령일련번호'), status:g('법령상태')};
        });
      }catch(_){ return null; }
    }
    async function h(){
      var url=buildURL('/lawSearch.do',{OC:OC,target:'law',type:'HTML',query:qRaw,display:10});
      var t=await fetchTextDirectOrProxy(url);
      try{
        var dom=new DOMParser().parseFromString(t,'text/html');
        var rows=[].slice.call(dom.querySelectorAll('a[href*="ID="]')).map(a=>{
          var href=a.getAttribute('href')||''; var m=href.match(/ID=([^&]+)/);
          return {kind:'law', name:(a.textContent||'').trim(), id:m?decodeURIComponent(m[1]):'', lsiSeq:'', status:''};
        }).filter(x=>x.id);
        return rows;
      }catch(_){ return null; }
    }

    var arr = await j() || await x();
    var chosen = pick(arr||[], true);
    if(chosen) return chosen;
    // 비현행/HTML 폴백
    var arr2 = arr || await x() || await h() || [];
    return pick(arr2, false);
  }

  // ===== 자치법규 검색: 현행 우선 → 없으면 비현행 폴백 → 마지막에 HTML도 폴백 =====
  async function tryOrdinSearchAll(qCanon,qRaw){
    function pick(rows,preferCurrent){
      if(!rows||!rows.length) return null;
      var clean=function(s){return canonName(refineLawName(s||''))};
      var want=clean(qCanon);
      var pool = preferCurrent ? rows.filter(r=>isCurrent(r.status)) : rows.slice();
      if(preferCurrent && !pool.length) pool = rows.slice();
      var exact=pool.find(x=>clean(x.name)===want);
      return exact || pool[0] || null;
    }
    async function j(){
      var url=buildURL('/lawSearch.do',{OC:OC,target:'ordin',type:'JSON',query:qRaw,display:10});
      var t=await fetchTextDirectOrProxy(url);
      try{
        var d=JSON.parse(t); var root=d&&(d.OrdinSearch||d);
        var rows=[]; if(root&&root.ordin){ rows=Array.isArray(root.ordin)?root.ordin:[root.ordin] }
        return rows.map(x=>({kind:'ordin', name:(x.자치법규명||'').trim(), id:(x.자치법규ID||'').trim(), mst:(x.자치법규일련번호||'').trim(), org:(x.지자체명||x.지자체기관명||'').trim(), status:(x.자치법규상태||'').trim()}));
      }catch(_){ return null; }
    }
    async function x(){
      var url=buildURL('/lawSearch.do',{OC:OC,target:'ordin',type:'XML',query:qRaw,display:10});
      var t=await fetchTextDirectOrProxy(url);
      try{
        var dom=new DOMParser().parseFromString(t,'text/xml');
        var list=[].slice.call(dom.getElementsByTagName('ordin'));
        return list.map(n=>{
          var g=(tag)=>{var el=n.getElementsByTagName(tag)[0]; return el? (el.textContent||'').trim() : ''};
          return {kind:'ordin', name:g('자치법규명'), id:g('자치법규ID'), mst:g('자치법규일련번호'), org:(g('지자체명')||g('지자체기관명')), status:g('자치법규상태')};
        });
      }catch(_){ return null; }
    }
    async function h(){
      var url=buildURL('/lawSearch.do',{OC:OC,target:'ordin',type:'HTML',query:qRaw,display:10});
      var t=await fetchTextDirectOrProxy(url);
      try{
        var dom=new DOMParser().parseFromString(t,'text/html');
        var rows=[].slice.call(dom.querySelectorAll('a[href*="MST="], a[href*="ID="]')).map(a=>{
          var href=a.getAttribute('href')||'';
          var id=(href.match(/ID=([^&]+)/)||[])[1]||'';
          var mst=(href.match(/MST=([^&]+)/)||[])[1]||'';
          return {kind:'ordin', name:(a.textContent||'').trim(), id:decodeURIComponent(id||''), mst:decodeURIComponent(mst||''), org:'', status:''};
        }).filter(x=>x.id||x.mst);
        return rows;
      }catch(_){ return null; }
    }

    var arr = await j() || await x();
    var chosen = pick(arr||[], true);
    if(chosen) return chosen;
    var arr2 = arr || await x() || await h() || [];
    return pick(arr2, false);
  }

  async function searchLawRow(lawQuery){
    var refinedQ=refineLawName(lawQuery||''); if(!refinedQ) return null;
    if(lawIdCache.has(refinedQ)) return lawIdCache.get(refinedQ);

    var variants=generateAlternatives(lawQuery);
    for(var i=0;i<variants.length;i++){
      var q=variants[i];
      // 1) 국가법령 (현행 우선, 폴백 허용)
      var law = await tryLawSearchAll(q, q);
      if(law){ lawIdCache.set(refinedQ,law); return law; }
      // 2) 자치법규 (현행 우선, 폴백 허용)
      var ord = await tryOrdinSearchAll(q, q);
      if(ord){ lawIdCache.set(refinedQ,ord); return ord; }
    }
    return null;
  }

  /* ===== Extraction ===== */
  function normalizeText(s){
    return (s||'')
      .replace(/[\u200B-\u200D\uFEFF]/g,'')
      .replace(/[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g,' ')
      .replace(/[“”]/g,'"').replace(/[‘’]/g,"'")
      .replace(/[『「]/g,'«').replace(/[』」]/g,'»')
      .replace(/\s+/g,' ')
      .trim();
  }

  // 법/법률 + 조례 + 규칙까지 인식
  var LAW_BASE='[가-힣A-Za-z0-9·ㆍ\\s]+?(?:법|법률|조례|규칙)';
  var LAW_EO='(?:시행령|시행규칙)'; // 국가법령 후행 토큰
  var NAME_GROUP='('+LAW_BASE+'(?:\\s*'+LAW_EO+')?)';

  var D='\\d+';
  var JO='제\\s*('+D+')\\s*조(?:\\s*의\\s*('+D+'))?';
  var HANG='(?:\\s*제?\\s*('+D+')\\s*항)?';
  var HO='(?:\\s*제?\\s*('+D+')\\s*호)?';
  var MOK='(?:\\s*([가-하])\\s*목)?';

  var QUOTED_ANY=new RegExp('[«"\']\\s*'+NAME_GROUP+'\\s*[»"\']\\s*'+JO+HANG+HO+MOK,'g');
  var EXPL_RE=new RegExp(NAME_GROUP+'\\s*'+JO+HANG+HO+MOK,'g');
  var NAME_ONLY_RE=new RegExp('(?:^|[\\s\\(\\[\\{«「"“\'])'+NAME_GROUP+'(?!\\s*제\\s*'+D+'\\s*조)(?=$|[\\s\\)\\]\\}»」"”\'.,;:!?])','g');

  var skipCtx=function(n){var s=(n||'').replace(/\s+/g,'');return s==='같은법'||s==='동법'||s==='같은법시행령'||s==='동법시행령'||s==='같은법시행규칙'||s==='동법시행규칙'};

  function isLikelyLawName(name){
    var s=(name||'').trim(); if(!s) return false;
    if(s==='법'||s==='법률'||s==='조례'||s==='규칙') return false;
    if(/방법$/.test(s)) return false;
    if(/^(관련|관계|개정|현행|해당)\s*(법|조례|규칙)$/.test(s)) return false;
    var isEO=/(시행령|시행규칙)$/.test(s);
    var core=isEO? s.replace(/\s*(시행령|시행규칙)$/,'').trim() : s;
    if(!/(법|법률|조례|규칙)$/.test(core)) return false;
    var base=core.replace(/(법|법률|조례|규칙)$/,'');
    if(base.length<1) return false;
    return true;
  }

  function extract(text){
    var src=normalizeText(text);
    var list=[]; var seen=new Set();
    var display=function(s){return (s||'').replace(/[\"“”'‘’\[\]\(\)「」«»]/g,'').trim()};

    function push(nm,jo,joi,hang,ho,mok){
      var name=refineLawName(display(nm));
      if(!name||skipCtx(name)) return;
      if(!isLikelyLawName(name)) return;
      var key=[name,jo||'',joi||'',hang||'',ho||'',mok||''].join('|');
      if(seen.has(key)) return; seen.add(key);
      list.push({name:name,jo:jo,joi:joi,hang:hang,ho:ho,mok:mok});
    }

    var m;
    while((m=QUOTED_ANY.exec(src))){ push(m[1],m[2],m[3],m[4],m[5],m[6]); }
    while((m=EXPL_RE.exec(src))){ push(m[1],m[2],m[3],m[4],m[5],m[6]); }
    while((m=NAME_ONLY_RE.exec(src))){ push(m[1], null, null, null, null, null); }

    var namesWithArticle=new Set(list.filter(function(x){return !!x.jo}).map(function(x){return x.name}));
    list=list.filter(function(x){ if(x.jo) return true; return !namesWithArticle.has(x.name); });

    var seenNameOnly=new Set();
    list=list.filter(function(x){
      if(x.jo) return true;
      var k='nameonly|'+x.name;
      if(seenNameOnly.has(k)) return false;
      seenNameOnly.add(k);
      return true;
    });

    return list;
  }

  /* ===== UI helpers & fetchers ===== */
  function toast(msg,ms){ms=ms||2000; var el=$('#toast'); var t=$('#toastMsg'); if(t) t.textContent=msg; if(el){ el.classList.add('on'); setTimeout(function(){el.classList.remove('on')},ms)}}
  function skeleton(n){n=n||2; var arr=[]; for(var i=0;i<n;i++){arr.push('<li class="item"><div class="sk-line skeleton" style="width:58%"></div><div class="sk-gap"></div><div class="sk-line skeleton" style="width:32%"></div></li>')} return arr.join('')}
  var sanitize=function(html){return (html||'').replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,'')};

  // 국가법령 조문(XML)
  async function fetchArticleXML(urlXML){
    var xmlText=await fetchTextDirectOrProxy(urlXML);
    if(!xmlText) return null;
    var dom;
    try{ dom=new DOMParser().parseFromString(xmlText,'text/xml'); }catch(e){ return null; }
    var get=function(tag,node){node=node||dom; var el=node.getElementsByTagName(tag)[0]; return el? (el.textContent||'').trim() : ''};
    var title=get('조문제목')||'';
    var articleBodyRaw=get('조문내용')||'';
    var hangs=[].slice.call(dom.getElementsByTagName('항')).map(function(h){
      var hTitle=(h.getElementsByTagName('항내용')[0]||{}).textContent; hTitle=hTitle? hTitle.trim():'';
      var hos=[].slice.call(h.getElementsByTagName('호')).map(function(ho){
        var hoText=(ho.getElementsByTagName('호내용')[0]||{}).textContent; hoText=hoText? hoText.trim():'';
        var moks=[].slice.call(ho.getElementsByTagName('목')).map(function(m){return (m.textContent||'').trim()});
        return {hoText:hoText, moks:moks};
      });
      return {hTitle:hTitle, hos:hos};
    });
    return {title:title, articleBodyRaw:articleBodyRaw, hangs:hangs};
  }

  // 자치법규 전체(XML)에서 특정 ‘제X조’만 발췌
  async function fetchOrdinAndPick(ID_or_MST, jo){
    var p={OC:OC,target:'ordin',type:'XML'};
    if(/^\d+$/.test(ID_or_MST)&&ID_or_MST.length>7){ p.ID=ID_or_MST; } else { p.MST=ID_or_MST; }
    var url=buildURL('/lawService.do',p);
    var xmlText=await fetchTextDirectOrProxy(url);
    if(!xmlText) return null;
    var dom;
    try{ dom=new DOMParser().parseFromString(xmlText,'text/xml'); }catch(e){ return null; }

    var nodes=[].slice.call(dom.getElementsByTagName('조문'));
    var target = nodes.find(function(n){
      var no=(n.getElementsByTagName('조문번호')[0]||{}).textContent||'';
      return no.replace(/\s+/g,'')===('제'+parseInt(jo,10)+'조').replace(/\s+/g,'') || no.indexOf('제'+parseInt(jo,10)+'조')===0;
    }) || nodes[0];

    if(!target) return null;

    var get = function(tag,node){ node=node||target; var el=node.getElementsByTagName(tag)[0]; return el? (el.textContent||'').trim() : '' };
    var body = get('조내용');
    var title = get('조제목') || get('조문번호') || '';

    var parts=[];
    var hangs = [].slice.call(target.getElementsByTagName('항'));
    if(hangs.length){
      hangs.forEach(function(h){
        var ht = (h.getElementsByTagName('항내용')[0]||{}).textContent || '';
        if(ht) parts.push('<div class="hang">'+sanitize(ht.trim())+'</div>');
        var hos=[].slice.call(h.getElementsByTagName('호'));
        hos.forEach(function(ho){
          var hot=(ho.getElementsByTagName('호내용')[0]||{}).textContent || '';
          if(hot) parts.push('<div class="ho">'+sanitize(hot.trim())+'</div>');
          var moks=[].slice.call(ho.getElementsByTagName('목'));
          moks.forEach(function(m){
            var mk=(m.textContent||'').trim(); if(mk) parts.push('<div class="mok">'+sanitize(mk)+'</div>');
          });
        });
      });
    }
    var articleBodyRaw = body ? ('<div>'+sanitize(body)+'</div>') : '';
    var html = articleBodyRaw + parts.join('');
    return {title:title, articleBodyRaw:html, hangs:[]};
  }

  function renderArticlePreview(opts){
    var lawName=opts.lawName, joLabel=opts.joLabel, data=opts.data;
    var modal=$('#modal'), body=$('#modalBody'), titleEl=$('#modalTitle');
    if(titleEl) titleEl.textContent = lawName+' '+joLabel+' (전문)';
    var html='';
    if(data.articleBodyRaw){ html+= data.articleBodyRaw; }
    if(data.hangs && data.hangs.length){
      var parts=[];
      data.hangs.forEach(function(h){
        if(h.hTitle) parts.push('<div class="hang">'+ sanitize(h.hTitle)+'</div>');
        if(h.hos && h.hos.length){
          h.hos.forEach(function(ho){
            if(ho.hoText) parts.push('<div class="ho">'+ sanitize(ho.hoText)+'</div>');
            if(ho.moks && ho.moks.length){
              ho.moks.forEach(function(mk){
                parts.push('<div class="mok">'+ sanitize(mk)+'</div>');
              });
            }
          });
        }
      });
      html+=parts.join('');
    }
    if(!html) html='<div class="mini">조문 본문을 불러오지 못했습니다.</div>';
    if(body) body.innerHTML=html;
    if(modal) modal.classList.add('on');
  }

  function bindModal(){
    var closeBtn=$('#modalClose'); if(closeBtn){ closeBtn.addEventListener('click', function(){ var m=$('#modal'); if(m) m.classList.remove('on'); }) }
    var modal=$('#modal');
    if(modal){ modal.addEventListener('click', function(e){ if(e.target && e.target.id==='modal'){ modal.classList.remove('on'); } }); }
  }

  /* ===== Result list ===== */
  function appendResult(listEl, payload){
    var title=payload.title, kind=payload.kind, lawId=payload.lawId, lsiSeq=payload.lsiSeq, mst=payload.mst, articleURL=payload.articleURL, fullURL=payload.fullURL, lawName=payload.lawName, joText=payload.joText;

    var linkHtml='';
    if(joText){
      linkHtml += '① <button type="button" class="preview-btn">조문 미리보기</button> · ';
      if(kind==='law'){
        linkHtml += '② <a class="go-article" href="'+articleURL+'" target="_blank" rel="noopener">조문 바로가기</a> · ';
      }else{
        linkHtml += '② <a class="go-ordin" href="'+fullURL+'" target="_blank" rel="noopener">조문 바로가기(전체 내)</a> · ';
      }
    }
    linkHtml += '③ <a class="go-full" href="'+fullURL+'" target="_blank" rel="noopener">'+(kind==='law'?'법령 전체':'자치법규 전체')+'</a>';

    var li=document.createElement('li'); li.className='item';
    li.innerHTML='' +
      '<div class="item-line">' +
        '<span class="t">'+title+'</span>' +
        (kind==='law'
          ? (lawId ? '<span class="meta">법령ID: '+lawId+(lsiSeq?(' · 일련번호: '+lsiSeq):'')+'</span>' : '<span class="meta">법령ID 미확인</span>')
          : ((lawId||mst) ? '<span class="meta">자치법규ID: '+(lawId||'-')+(mst?(' · 일련번호: '+mst):'')+'</span>' : '<span class="meta">자치법규ID 미확인</span>')
        ) +
        '<span class="links">' + linkHtml + '</span>' +
      '</div>';

    if(joText){
      if(kind==='law'){
        var a=li.querySelector('.go-article');
        if(a){
          a.addEventListener('click', function(e){
            e.preventDefault();
            var url=a.getAttribute('href');
            fetchTextDirectOrProxy(url).then(function(html){
              if(html && !isFailPage(html)) window.open(url,'_blank','noopener');
              else window.open(publicLawURL(title.split(' 제')[0]),'_blank','noopener');
            });
          });
        }
      }
      var btn=li.querySelector('.preview-btn');
      if(btn){
        btn.addEventListener('click', async function(){
          btn.disabled=true; btn.textContent='불러오는 중…';
          try{
            var data;
            if(kind==='law'){
              var xmlURL=buildLawArticleXMLURL(lawId, joText);
              data=await fetchArticleXML(xmlURL);
            }else{
              var idOrMst = lawId || mst;
              data = await fetchOrdinAndPick(idOrMst, joText.jo || 1);
            }
            if(!data){ toast('조문 전문을 불러오지 못했습니다.'); }
            else{
              var joLabel=title.replace(lawName,'').trim();
              renderArticlePreview({lawName:lawName, joLabel:joLabel, data:data});
            }
          } finally {
            btn.disabled=false; btn.textContent='조문 미리보기';
          }
        });
      }
    }

    listEl.appendChild(li);
  }

  /* ===== Run flow ===== */
  async function run(){
    var input=$('#input'); var resUl=$('#resList');
    if(resUl) resUl.innerHTML='';
    var text=input? (input.value||'') : '';
    if(!text.trim()){ toast('본문을 입력해 주세요'); return; }
    if(resUl) resUl.innerHTML=skeleton(2);

    var cites=extract(text);
    if(!cites.length){
      if(resUl) resUl.innerHTML='<li class="item mini">인식 가능한 법령/자치법규명 또는 조문을 찾지 못했습니다. · 예: 「사립학교법」 제43조, 「경기도교육청 행정기구 및 정원 조례」 제5조</li>';
      return;
    }

    var promises=cites.map(function(it){return searchLawRow(it.name)});
    var rows=await Promise.allSettled(promises);
    if(resUl) resUl.innerHTML='';

    for(var i=0;i<cites.length;i++){
      var it=cites[i];
      var st=rows[i];
      var row=(st.status==='fulfilled')?st.value:null;

      var lawName=it.name;
      var title=it.jo ? (lawName+' 제'+parseInt(it.jo,10)+(it.joi?('의'+parseInt(it.joi,10)):'')+'조') : lawName;

      if(row){
        if(row.kind==='law'){
          var fullURL=buildLawFullHTMLURL(row.id);
          var articleURL= it.jo ? buildLawArticleURL(row.id,it) : '';
          appendResult(resUl,{
            kind:'law',
            title:title, lawId:row.id, lsiSeq:row.lsiSeq, mst:'',
            articleURL:articleURL, fullURL:fullURL,
            lawName:lawName, joText: it.jo ? it : null
          });
        }else{ // ordin
          var fullURL=buildOrdinFullHTMLURL(row.id,row.mst);
          appendResult(resUl,{
            kind:'ordin',
            title:title, lawId:row.id, lsiSeq:'', mst:row.mst,
            articleURL:'', fullURL:fullURL,
            lawName:lawName, joText: it.jo ? it : null
          });
        }
      }else{
        // 끝까지 못 찾으면 국가법령 공개페이지로만 폴백(자치법규는 일괄 공개페이지가 달라 안전 폴백 어려움)
        var fullURL=publicLawURL(lawName);
        appendResult(resUl,{
          kind:'law',
          title:title, lawId:'', lsiSeq:'', mst:'',
          articleURL:'', fullURL:fullURL,
          lawName:lawName, joText: null
        });
      }
    }
  }

  function bind(){
    var runBtn=$('#run'); if(runBtn){ runBtn.addEventListener('click', run); }
    var clearBtn=$('#clear');
    if(clearBtn){
      clearBtn.addEventListener('click', function(){
        var resUl = $('#resList');
        if(resUl) resUl.innerHTML = '';
        var input = $('#input');
        if(input){ input.value = ''; input.focus(); }
      });
    }

    var input=$('#input');
    if(input){
      input.addEventListener('keydown', function(e){
        if(e.key==='Enter' && !e.altKey && !e.shiftKey && !e.ctrlKey){
          e.preventDefault(); run();
        }
      });
    }
    bindModal();
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', bind);
  }else{
    bind();
  }
})();
</script>
</body>
</html>
