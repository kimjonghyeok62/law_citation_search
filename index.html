<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>법조문 자동 추출·검색 · 단일파일(정확도 개선 v2)</title>
<style>
  :root{--bg:#0b1020; --panel:#0f152b; --muted:#8ea0c7; --line:#1c2748; --accent:#78a6ff; --accent-2:#9ec1ff; --txt:#eaf1ff; --txt-muted:#aab9dd; --radius:14px; --shadow:0 10px 28px rgba(0,0,0,.32)}
  @media (prefers-color-scheme: light){ :root{ --bg:#f5f7ff; --panel:#fff; --muted:#596180; --line:#e6eaff; --accent:#2e5cff; --accent-2:#4c78ff; --txt:#0c1330; --txt-muted:#5e6a8a; --shadow:0 8px 20px rgba(15,23,52,.08)} }
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
  .wrap{max-width:980px;margin:0 auto;padding:28px}
  header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:18px}
  .title{display:flex;flex-direction:column;gap:6px}
  h1{font-size:1.4rem;margin:0;letter-spacing:.2px}
  .sub{font-size:.92rem;color:var(--txt-muted)}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card.pad{padding:16px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  textarea{width:100%;min-height:170px;padding:14px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--txt);resize:vertical}
  textarea:focus{outline:none;box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 45%, transparent)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .label{font-weight:600;color:var(--txt-muted);font-size:.92rem}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--txt);min-width:260px}
  input::placeholder{color:var(--muted)}
  .btn{padding:10px 14px;border:1px solid transparent;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer;transition:transform .06s ease,opacity .2s}
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:transparent;color:var(--accent);border-color:color-mix(in oklab, var(--accent) 30%, #0000)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:color-mix(in oklab, var(--accent) 14%, transparent);color:var(--accent-2);border:1px solid var(--line);font-size:.8rem}
  .result{margin-top:18px}
  .result h2{margin:0 0 8px;font-size:1.05rem}
  ol{margin:0;padding-left:20px}
  .item{padding:14px;border-top:1px dashed var(--line)}
  .meta{font-size:.86rem;color:var(--txt-muted)}
  .links{margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
  .links a,.links button{color:var(--accent-2);text-decoration:none;border:1px dashed color-mix(in oklab, var(--accent) 30%, transparent);background:transparent;border-radius:8px;padding:4px 8px;cursor:pointer}
  .links a:hover,.links button:hover{text-decoration:underline}
  .mini{font-size:.86rem;color:var(--txt-muted)}
  .right{margin-left:auto}
  .toast{position:fixed;right:18px;bottom:18px;display:none;z-index:50}
  .toast.on{display:block}
  .toast .box{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:12px 14px;min-width:240px}
  .skeleton{background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.14), rgba(255,255,255,.06));background-size:200% 100%;animation:shimmer 1.1s infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .sk-line{height:14px;border-radius:6px;opacity:.45}
  .sk-gap{height:10px}

  /* === Modal for article preview (click) === */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100}
  .modal.on{display:flex}
  .modal .panel{max-width:840px;max-height:80vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  .modal h3{margin:0 0 8px;font-size:1.05rem}
  .modal .close{position:sticky;top:0;float:right;border:none;background:transparent;color:var(--txt-muted);cursor:pointer;font-size:1rem}
  .article-body{line-height:1.6}
  .article-body .hang{margin-left:12px}
  .article-body .ho{margin-left:24px}
  .article-body .mok{margin-left:36px}
  .article-body b{color:var(--accent-2)}

  /* === Hover Tooltip for article preview === */
  .law-tip {
    position: fixed;
    z-index: 120;
    display: none;
    max-width: 520px;
    max-height: 60vh;
    overflow: auto;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--line);
    background: var(--panel);
    box-shadow: var(--shadow);
    color: var(--txt);
  }
  .law-tip .title { font-weight: 600; margin-bottom: 6px; color: var(--accent-2); font-size: .92rem; }
  .law-tip .article-body { line-height: 1.6; font-size: .86rem; }
  .law-tip .hang{margin-left:12px}
  .law-tip .ho{margin-left:24px}
  .law-tip .mok{margin-left:36px}
  .law-tip .article-body b{color: var(--accent-2)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>법조문 자동 추출·검색</h1>
      <div class="sub">본문에서 법령·조문을 찾아 <b>조문 바로가기</b>와 <b>전체 본문</b> 링크만 제공합니다. <span class="mini">(같은법/동법 류는 제외)</span></div>
    </div>
    <div class="badge">OC: bro3362</div>
  </header>

  <div class="grid">
    <section class="card pad">
      <div class="row" style="margin-bottom:8px"><div class="label">본문 입력</div></div>
      <textarea id="input" placeholder="예) 조례는 「사립학교법」 제43조에 따라 …"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="run" class="btn">추출·검색</button>
        <button id="clear" class="btn secondary">지우기</button>
        <span class="mini">Enter(⌥/Alt+Enter는 줄바꿈)</span>
        <span class="right mini">응답이 없을 때 프록시 사용됨</span>
      </div>
    </section>

    <aside class="card pad">
      <div class="row" style="margin-bottom:10px"><div class="label">프록시</div></div>
      <input id="proxy" type="text" value="https://law-proxy.hyok96.workers.dev/?url=" style="width:100%"/>
      <div class="mini" style="margin-top:8px">CORS로 본문을 못 읽을 때 자동으로 프록시를 사용합니다.</div>
    </aside>
  </div>

  <section class="card pad result" id="resBox">
    <h2>검색 결과</h2>
    <ol id="resList"></ol>
  </section>
</div>

<div id="toast" class="toast"><div class="box mini" id="toastMsg">안내</div></div>

<!-- Article preview modal (click) -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="panel">
    <button class="close" id="modalClose" title="닫기">✕</button>
    <h3 id="modalTitle">조문 전문</h3>
    <div id="modalBody" class="article-body mini">로딩 중…</div>
  </div>
</div>

<!-- Global tooltip container -->
<div id="lawTip" class="law-tip" aria-hidden="true">
  <div class="title"></div>
  <div class="article-body mini">불러오는 중…</div>
</div>

<script>
(() => {
  'use strict';
  /* ===== Core ===== */
  const DRF='https://www.law.go.kr/DRF';
  const OC='bro3362';
  const $=sel=>document.querySelector(sel);
  const enc=s=>encodeURIComponent(s);
  const pad=(n,w)=>String(parseInt(n,10)).padStart(w,'0');
  const proxyBase=()=>($('#proxy')?.value?.trim()||'https://law-proxy.hyok96.workers.dev/?url=');
  const buildURL=(p,params)=>{const u=new URL(DRF+p);Object.entries(params).forEach(([k,v])=>{if(v!=null&&v!=='')u.searchParams.set(k,v)});return u.toString();}
  const withProxy=(url,base)=>{let b=(base||'https://law-proxy.hyok96.workers.dev/?url=').trim();if(!b.includes('?'))b+=(b.endsWith('/')?'':'/')+'?';if(!/\burl=/.test(b))b+='url=';return b+encodeURIComponent(url)}
  const lawIdCache=new Map();
  const previewCache = new Map(); // key: `${lawId}|${JO/HANG/HO/MOK}` -> HTML

  async function fetchTextDirectOrProxy(url,{timeoutMs=7000}={}){const fetchWithTimeout=u=>{const ac=new AbortController();const id=setTimeout(()=>ac.abort(),timeoutMs);return fetch(u,{signal:ac.signal}).finally(()=>clearTimeout(id))};try{const r=await fetchWithTimeout(url);if(r.ok){const t=await r.text();if((r.headers.get('content-type')||'').includes('json')||t.length>30)return t}}catch(_){}try{const r2=await fetchWithTimeout(withProxy(url,proxyBase()));if(r2.ok){const t2=await r2.text();if((r2.headers.get('content-type')||'').includes('json')||t2.length>30)return t2}}catch(_){}return ''}
  const isFailPage=html=>/페이지\s*접속에\s*실패하였습니다|사용자인증에\s*실패하였습니다|페이지를\s*찾을\s*수\s*없습니다/.test((html||'').replace(/\u00A0/g,' '))
  const publicLawURL=name=>'https://www.law.go.kr/법령/'+enc(name)
  const buildLawFullHTMLURL=id=>buildURL('/lawService.do',{OC,target:'law',type:'HTML',ID:id})
  const joTo6=(jo,joi)=>{const h=pad(jo,4);return joi?h+pad(joi,2):h+'00'}
  const buildLawArticleURL=(id,{jo,joi,hang,ho,mok})=>{
    const JO=joTo6(jo,joi);
    const HANG=(hang?pad(hang,6):(ho?'000000':''));
    const HO=(ho?pad(ho,6):'');
    const MOK=(mok?String(mok).trim().slice(0,1).replace(/[^가-하]/g,''):'');
    const p={OC,target:'lawjosub',type:'HTML',ID:id,JO};
    if(HANG)p.HANG=HANG;if(HO)p.HO=HO;if(MOK)p.MOK=MOK;
    return buildURL('/lawService.do',p)
  }
  const buildLawArticleXMLURL=(id,{jo,joi,hang,ho,mok})=>{
    const JO=joTo6(jo,joi);
    const HANG=(hang?pad(hang,6):(ho?'000000':''));
    const HO=(ho?pad(ho,6):'');
    const MOK=(mok?String(mok).trim().slice(0,1).replace(/[^가-하]/g,''):'');
    const p={OC,target:'lawjosub',type:'XML',ID=id,JO};
    if(HANG)p.HANG=HANG;if(HO)p.HO=HO;if(MOK)p.MOK=MOK;
    return buildURL('/lawService.do',p)
  }

  /* ===== Normalize & Search ===== */
  const canonName=s=>(s||'').replace(/[\s"“”'‘’\[\]\(\)「」]/g,'').replace(/[·ㆍ]/g,'')
  const displayName=s=>(s||'').replace(/["“”'‘’\[\]\(\)「」]/g,'').trim()
  function refineLawName(name){let s=(name||'').trim();if(!s)return s;s=s.replace(/^(?:까지|및|또는|등|관련|관한|따른|에\s*따른|에\s*의한|의)\s+/, '');const m=s.match(/^(.*?법(?:률)?)(?:\s*)?(시행령|시행규칙)$/);if(m)return (m[1]+' '+m[2]).trim();const toks=s.split(/\s+/);let i=-1;for(let k=toks.length-1;k>=0;k--){if(/[법]$/.test(toks[k])){i=k;break}}if(i>=0){if(toks[i+1]&&/^(시행령|시행규칙)$/.test(toks[i+1]))return (toks[i]+' '+toks[i+1]).trim();return toks[i]}return s}
  function generateAlternatives(q){const s=displayName(q||'').replace(/\s+/g,'').trim();const alts=new Set();if(/^영유아교육법$/.test(s)){alts.add('유아교육법');alts.add('영유아보육법')}if(s)alts.add(s.replace(/[^가-힣A-Za-z0-9]/g,''));if(s.includes('교육'))alts.add(s.replace(/교육/g,'보육'));if(s.includes('보육'))alts.add(s.replace(/보육/g,'교육'));const refined=refineLawName(q);if(refined)alts.add(refined);if(q)alts.add(q);return [...alts].filter(Boolean)}

  async function searchLawRow(lawQuery){const refinedQ=refineLawName(lawQuery||'');if(!refinedQ)return null;if(lawIdCache.has(refinedQ))return lawIdCache.get(refinedQ);const variants=generateAlternatives(lawQuery);const clean=s=>canonName(refineLawName(s||''));const wantsEO=/(시행령|시행규칙)$/.test(refinedQ)?refinedQ.match(/(시행령|시행규칙)$/)[1]:'';const pickBest=(rows,wantCanon)=>{if(!rows||!rows.length)return null;if(wantsEO){const eoExact=rows.find(x=>/시행령|시행규칙/.test(x.법령명한글)&&clean(x.법령명한글)===wantCanon);if(eoExact)return eoExact;const eoSuffix=rows.find(x=>(x.법령명한글||'').trim().endsWith(wantsEO));if(eoSuffix)return eoSuffix}const exact=rows.find(x=>clean(x.법령명한글)===wantCanon);if(exact)return exact;const partial=rows.find(x=>{const cx=clean(x.법령명한글);return cx.includes(wantCanon)||wantCanon.includes(cx)});return partial||rows[0]};const tryJson=async(qCanon,qRaw)=>{const url=buildURL('/lawSearch.do',{OC,target:'law',type:'JSON',query:qRaw,display:10});const text=await fetchTextDirectOrProxy(url);try{const data=JSON.parse(text);const root=data&&(data.LawSearch||data);let rows=[];if(root&&root.law){rows=Array.isArray(root.law)?root.law:[root.law]}return pickBest(rows,qCanon)}catch{return null}};const tryXml=async(qCanon,qRaw)=>{const url=buildURL('/lawSearch.do',{OC,target:'law',type:'XML',query:qRaw,display:10});const text=await fetchTextDirectOrProxy(url);try{const dom=new DOMParser().parseFromString(text,'text/xml');const rows=[...dom.getElementsByTagName('law')].map(n=>({법령명한글:(n.getElementsByTagName('법령명한글')[0]?.textContent||'').trim(),법령ID:(n.getElementsByTagName('법령ID')[0]?.textContent||'').trim(),법령일련번호:(n.getElementsByTagName('법령일련번호')[0]?.textContent||'').trim(),법령상세링크:(n.getElementsByTagName('법령상세링크')[0]?.textContent||'').trim()}));return pickBest(rows,qCanon)}catch{return null}};const tryHtml=async(qCanon,qRaw)=>{const url=buildURL('/lawSearch.do',{OC,target:'law',type:'HTML',query:qRaw,display:10});const text=await fetchTextDirectOrProxy(url);try{const dom=new DOMParser().parseFromString(text,'text/html');const rows=[...dom.querySelectorAll('a[href*="ID="]')].map(a=>{const href=a.getAttribute('href')||'';const idMatch=href.match(/ID=([^&]+)/);const name=(a.textContent||'').trim();return {법령명한글:name,법령ID:idMatch?decodeURIComponent(idMatch[1]):''}}).filter(x=>x.법령ID);return pickBest(rows,qCanon)}catch{return null}};for(const q of variants){const canon=clean(q);let row=await tryJson(canon,q);if(!row)row=await tryXml(canon,q);if(!row)row=await tryHtml(canon,q);if(row){lawIdCache.set(refinedQ,row);return row}}if(wantsEO){const base=refinedQ.replace(/\s*(시행령|시행규칙)$/,'');const forced=(base+' '+wantsEO).trim();const canon2=clean(forced);let row=await tryJson(canon2,forced);if(!row)row=await tryXml(canon2,forced);if(!row)row=await tryHtml(canon2,forced);if(row){lawIdCache.set(refinedQ,row);return row}}return null}

  /* ===== Extraction (robust) ===== */
  function normalizeText(s){
    return (s||'')
      .replace(/[\u200B-\u200D\uFEFF]/g,'')
      .replace(/[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g,' ')
      .replace(/[“”]/g,'"').replace(/[‘’]/g,"'")
      .replace(/[『「]/g,'«').replace(/[』」]/g,'»')
      .replace(/\s+/g,' ')
      .trim();
  }
  const LAW_BASE='[가-힣A-Za-z0-9·ㆍ\\s]+?(?:법|법률)';
  const LAW_EO='(?:시행령|시행규칙)';
  const NAME_GROUP=`(${LAW_BASE}(?:\\s*${LAW_EO})?)`;
  const D='\\d+';
  const JO=`제\\s*(${D})\\s*조(?:\\s*의\\s*(${D}))?`;
  const HANG=`(?:\\s*제?\\s*(${D})\\s*항)?`;
  const HO=`(?:\\s*제?\\s*(${D})\\s*호)?`;
  const MOK=`(?:\\s*([가-하])\\s*목)?`;
  const QUOTED_ANY=new RegExp(`[«\"']\\s*${NAME_GROUP}\\s*[»\"']\\s*${JO}${HANG}${HO}${MOK}`,'g');
  const EXPL_RE=new RegExp(`${NAME_GROUP}\\s*${JO}${HANG}${HO}${MOK}`,'g');
  const skipCtx=n=>{const s=(n||'').replace(/\s+/g,'');return s==='같은법'||s==='동법'||s==='같은법시행령'||s==='동법시행령'||s==='같은법시행규칙'||s==='동법시행규칙'}

  function extract(text){
    const src=normalizeText(text);
    const list=[]; const seen=new Set();
    const display=s=>(s||'').replace(/[\"“”'‘’\[\]\(\)「」«»]/g,'').trim();

    const push=(nm,jo,joi,hang,ho,mok)=>{
      const name=refineLawName(display(nm));
      if(!name||skipCtx(name)) return;
      const key=[name,jo||'',joi||'',hang||'',ho||'',mok||''].join('|');
      if(seen.has(key)) return; seen.add(key);
      list.push({name,jo,joi,hang,ho,mok});
    };

    let m;
    while((m=QUOTED_ANY.exec(src))){ const [,nm,jo,joi,hang,ho,mok]=m; push(nm,jo,joi,hang,ho,mok); }
    while((m=EXPL_RE.exec(src))){ const [,nm,jo,joi,hang,ho,mok]=m; push(nm,jo,joi,hang,ho,mok); }
    return list;
  }

  /* ===== UI helpers ===== */
  const toast=(msg,ms=2000)=>{const el=$('#toast'); $('#toastMsg').textContent=msg; el.classList.add('on'); setTimeout(()=>el.classList.remove('on'),ms)}
  const skeleton=(n=2)=>{const arr=[]; for(let i=0;i<n;i++){arr.push(`<li class="item"><div class="sk-line skeleton" style="width:58%"></div><div class="sk-gap"></div><div class="sk-line skeleton" style="width:32%"></div></li>`);} return arr.join('')}
  const sanitize=(html)=> (html||'').replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,'');

  /* ===== Article preview (click modal) ===== */
  async function fetchArticleXML(urlXML){
    const xmlText = await fetchTextDirectOrProxy(urlXML);
    if(!xmlText) return null;
    let dom;
    try{ dom = new DOMParser().parseFromString(xmlText,'text/xml'); }
    catch{ return null; }
    const get = (tag, node=dom)=> node.getElementsByTagName(tag)[0]?.textContent?.trim() || '';
    const title = get('조문제목') || '';
    const articleBodyRaw = get('조문내용') || '';
    const hangs = [...dom.getElementsByTagName('항')].map(h=>{
      const hTitle = h.getElementsByTagName('항내용')[0]?.textContent?.trim() || '';
      const hos = [...h.getElementsByTagName('호')].map(ho=>{
        const hoText = ho.getElementsByTagName('호내용')[0]?.textContent?.trim() || '';
        const moks = [...ho.getElementsByTagName('목')].map(m=> (m.textContent||'').trim());
        return {hoText, moks};
      });
      return {hTitle, hos};
    });
    return {title, articleBodyRaw, hangs};
  }

  function renderArticlePreview({lawName, joLabel, data}){
    const modal = $('#modal'), body = $('#modalBody'), titleEl = $('#modalTitle');
    titleEl.textContent = `${lawName} ${joLabel} (전문)`;
    let html = '';
    if(data.articleBodyRaw){ html += `<div>${sanitize(data.articleBodyRaw)}</div>`; }
    if(data.hangs?.length){
      const parts = [];
      data.hangs.forEach((h,i)=>{
        if(h.hTitle) parts.push(`<div class="hang"><b>(${i+1})</b> ${sanitize(h.hTitle)}</div>`);
        if(h.hos?.length){
          h.hos.forEach((ho,j)=>{
            if(ho.hoText) parts.push(`<div class="ho"><b>${j+1}.</b> ${sanitize(ho.hoText)}</div>`);
            if(ho.moks?.length){
              ho.moks.forEach((mk,k)=>{
                parts.push(`<div class="mok"><b>(${String.fromCharCode(0x3131+k)})</b> ${sanitize(mk)}</div>`);
              });
            }
          });
        }
      });
      html += parts.join('');
    }
    if(!html) html = '<div class="mini">조문 본문을 불러오지 못했습니다.</div>';
    body.innerHTML = html;
    modal.classList.add('on');
  }

  function bindModal(){
    $('#modalClose')?.addEventListener('click', ()=> $('#modal').classList.remove('on'));
    $('#modal')?.addEventListener('click', (e)=>{ if(e.target.id==='modal') $('#modal').classList.remove('on'); });
  }

  /* ===== Tooltip helpers ===== */
  function buildArticleHTML(data){
    let html = '';
    if(data?.articleBodyRaw){ html += `<div>${sanitize(data.articleBodyRaw)}</div>`; }
    if(data?.hangs?.length){
      const parts=[];
      data.hangs.forEach((h,i)=>{
        if(h.hTitle) parts.push(`<div class="hang"><b>(${i+1})</b> ${sanitize(h.hTitle)}</div>`);
        if(h.hos?.length){
          h.hos.forEach((ho,j)=>{
            if(ho.hoText) parts.push(`<div class="ho"><b>${j+1}.</b> ${sanitize(ho.hoText)}</div>`);
            if(ho.moks?.length){
              ho.moks.forEach((mk,k)=>{
                parts.push(`<div class="mok"><b>(${String.fromCharCode(0x3131+k)})</b> ${sanitize(mk)}</div>`);
              });
            }
          });
        }
      });
      html += parts.join('');
    }
    return html || '<div class="mini">조문 본문을 불러오지 못했습니다.</div>';
  }

  function showTipNear(btnEl, titleText, html){
    const tip = $('#lawTip');
    const title = tip.querySelector('.title');
    const body = tip.querySelector('.article-body');
    title.textContent = titleText;
    body.innerHTML = html;

    const rect = btnEl.getBoundingClientRect();
    const PADDING = 8;
    tip.style.display = 'block';
    // 크기 먼저 측정
    const tw = tip.offsetWidth;
    const th = tip.offsetHeight;

    const preferTop = rect.top > window.innerHeight/2;
    let top = preferTop ? Math.max(PADDING, rect.top - th - 10)
                        : Math.min(window.innerHeight - th - PADDING, rect.bottom + 10);
    let left = Math.min(
      Math.max(PADDING, rect.left + (rect.width/2) - (tw/2)),
      window.innerWidth - tw - PADDING
    );

    tip.style.top = `${top}px`;
    tip.style.left = `${left}px`;
  }

  function hideTip(){
    const tip = $('#lawTip');
    tip.style.display = 'none';
  }

  /* ===== Result list ===== */
  function appendResult(listEl,{title,lawId,lsiSeq,articleURL,fullURL, lawName, joText}){
    const li=document.createElement('li'); li.className='item';
    li.innerHTML=`
      <div><b>${title}</b></div>
      <div class="meta">법령ID: ${lawId}${lsiSeq?` · 일련번호: ${lsiSeq}`:''}</div>
      <div class="links">
        ① <a class="go-article" href="${articleURL}" target="_blank" rel="noopener">조문 바로가기</a>
        · ② <a href="${fullURL}" target="_blank" rel="noopener">전체 본문</a>
        · ③ <button type="button" class="preview-btn" aria-label="조문 전문 미리보기(호버)">조문 전문 미리보기</button>
      </div>`;
    const a=li.querySelector('.go-article');
    a.addEventListener('click', async (e)=>{
      e.preventDefault();
      const url=a.getAttribute('href');
      const html=await fetchTextDirectOrProxy(url);
      if(html && !isFailPage(html)) window.open(url,'_blank','noopener');
      else window.open(publicLawURL(title.split(' 제')[0]),'_blank','noopener');
    });

    // 클릭하면 기존 모달 그대로 유지
    const btn = li.querySelector('.preview-btn');
    btn.addEventListener('click', async ()=>{
      btn.disabled = true;
      btn.textContent = '불러오는 중…';
      try{
        const xmlURL = buildLawArticleXMLURL(lawId, joText);
        const data = await fetchArticleXML(xmlURL);
        if(!data){ toast('조문 전문을 불러오지 못했습니다.'); }
        else{
          renderArticlePreview({lawName, joLabel: title.replace(lawName,'').trim(), data});
        }
      } finally{
        btn.disabled = false;
        btn.textContent = '조문 전문 미리보기';
      }
    });

    // 호버 툴팁: 최초 한 번만 로드 후 캐시
    const tipKey = `${lawId}|${joTo6(joText.jo, joText.joi)}|${joText.hang||''}|${joText.ho||''}|${joText.mok||''}`;
    let enterTimer=null, leaveTimer=null;

    const onEnter = async () => {
      clearTimeout(leaveTimer);
      enterTimer = setTimeout(async () => {
        let html = previewCache.get(tipKey);
        if(!html){
          const xmlURL = buildLawArticleXMLURL(lawId, joText);
          const data = await fetchArticleXML(xmlURL);
          html = buildArticleHTML(data||{});
          previewCache.set(tipKey, html);
        }
        showTipNear(btn, `${lawName} ${title.replace(lawName,'').trim()} (전문)`, html);
      }, 150); // 짧은 지연으로 오동작 방지
    };
    const onLeave = () => {
      clearTimeout(enterTimer);
      leaveTimer = setTimeout(hideTip, 120);
    };
    btn.addEventListener('mouseenter', onEnter);
    btn.addEventListener('mouseleave', onLeave);

    // 버튼이 화면에서 이동할 때도 숨김
    btn.addEventListener('blur', hideTip);

    listEl.appendChild(li);
  }

  /* ===== Run flow ===== */
  async function run(){
    const text=$('#input').value||''; const resUl=$('#resList'); resUl.innerHTML='';
    if(!text.trim()){ toast('본문을 입력해 주세요'); return; }
    resUl.innerHTML=skeleton(2);

    const cites=extract(text);
    if(!cites.length){ resUl.innerHTML='<li class="item meta">인식 가능한 명시적 법령·조문을 찾지 못했습니다. (같은법/동법 제외) · 예: 「사립학교법」 제43조</li>'; return; }

    const rows=await Promise.allSettled(cites.map(it=>searchLawRow(it.name)));
    resUl.innerHTML='';

    cites.forEach((it,i)=>{
      const st=rows[i]; const row=(st.status==='fulfilled')?st.value:null;
      if(!row){
        const li=document.createElement('li'); li.className='item meta';
        li.innerHTML=`법령ID 검색 실패: <a href="${publicLawURL(it.name)}" target="_blank" rel="noopener">${it.name}</a>`;
        resUl.appendChild(li); return;
      }
      const lawId=row.법령ID||''; const lsiSeq=row.법령일련번호||'';
      const lawName = it.name;
      const title=`${lawName} 제${parseInt(it.jo,10)}${it.joi?`의${parseInt(it.joi,10)}`:''}조`;
      const articleURL=buildLawArticleURL(lawId,it);
      const fullURL=buildLawFullHTMLURL(lawId);
      appendResult(resUl,{
        title,lawId,lsiSeq,articleURL,fullURL,
        lawName,
        joText: it
      });
    });
  }

  function bind(){
    $('#run')?.addEventListener('click', run);
    $('#clear')?.addEventListener('click', ()=>{ $('#resList').innerHTML=''; });
    $('#input')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.altKey && !e.shiftKey && !e.ctrlKey){ e.preventDefault(); run(); } });
    bindModal();
    // 휠 스크롤/리사이즈 시 툴팁 숨김(위치 어긋남 방지)
    window.addEventListener('scroll', hideTip, {passive:true});
    window.addEventListener('resize', hideTip);
  }
  document.addEventListener('DOMContentLoaded', bind);
})();
</script>
</body>
</html>
