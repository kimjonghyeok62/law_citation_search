<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>법조문 자동 추출·검색 · 고급버전 (OC=bro3362)</title>
<style>
  :root{--bg:#0b1020;--panel:#11172c;--muted:#8492b5;--line:#1f2a49;--accent:#5b8cff;--txt:#e6ecff}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  h1{font-size:1.35rem;margin:0 0 8px}
  .hint{color:var(--muted);font-size:.95rem;margin-bottom:16px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  textarea{width:100%;min-height:210px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1731;color:#e6ecff}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1731;color:#e6ecff;min-width:260px}
  button{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
  button.secondary{background:#445b9c}
  button:disabled{opacity:.6;cursor:not-allowed}
  .tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border:1px solid var(--line);background:#0f1731;border-radius:999px;color:#c9d6ff;font-size:.8rem}
  .result h2{margin:0 0 8px}
  ol{margin:0;padding-left:20px}
  .k{color:#9fb4ff}
  .small{font-size:.9rem;color:#9aa8ce}
  .item{padding:10px;border-top:1px dashed var(--line)}
  .monos{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0f1731;border-radius:6px;padding:0 6px}
  .render{margin-top:8px;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .render .hdr{display:flex;justify-content:space-between;align-items:center;background:#0f1731;padding:8px 10px;border-bottom:1px solid var(--line)}
  .render .body{padding:10px;max-height:360px;overflow:auto;background:#0c1330}
  a{color:#9ec1ff}
  .tests{margin-top:18px}
  .pass{color:#22c55e}
  .fail{color:#ef4444}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1731;border:1px solid var(--line);color:#c9d6ff;font-size:.8rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>법조문 자동 추출·검색 · <span class="k">고급버전</span> <span class="small">(OC=bro3362 고정)</span></h1>
  <div class="hint">본문의 법령 인용을 인식하고, <b>같은 법/동법 시행령/이 법·이 영·이 규칙</b> 같은 맥락 참조까지 해석합니다. <b>제○조의○</b>·<b>부칙</b>·<b>별표</b> 인용도 처리하며, <b>프록시</b>를 제공하면 조문 본문을 화면에 바로 렌더링합니다.</div>

  <div class="grid">
    <div>
      <div class="card">
        <label for="input"><b>본문 입력</b></label>
        <textarea id="input" placeholder="예) 유아교육법 제8조의2 제4항, 같은 법 시행령 제9조 제3항 및 별표 1에 따라 ..."></textarea>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="row"><span class="badge">OC: bro3362 (고정)</span></div>
        <div class="row"><label>프록시(선택, CORS 우회)</label><input id="proxy" type="text" placeholder="예: https://your-worker.example.com/?url=" /></div>
        <div class="row"><button id="run">추출·검색</button><button class="secondary" id="clear">지우기</button><button class="secondary" id="runTests">테스트 실행</button></div>
        <div class="small">• 브라우저 CORS 때문에 응답을 읽지 못할 수 있습니다. 이때도 링크는 생성됩니다. 프록시를 지정하면 본문 렌더링이 활성화됩니다.</div>
      </div>
    </div>
  </div>

  <div class="card" id="foundBox">
    <h2>추출된 인용</h2>
    <ol id="foundList"></ol>
  </div>

  <div class="card result" id="resBox">
    <h2>검색 결과 (위에서부터 순서대로 표시)</h2>
    <ol id="resList"></ol>
  </div>

  <div class="card tests">
    <h2>내장 테스트</h2>
    <div id="testOutput" class="small">[테스트 대기 중]</div>
  </div>
</div>

<script>
(function(){
  'use strict';

  /** ===================== 상수/도우미 ===================== **/
  const DRF = 'https://www.law.go.kr/DRF';
  const OC  = 'bro3362'; // OC 고정값
  let lastAuthFail = false; // 직전 DRF 호출에서 인증오류 감지 여부

  const enc = s => encodeURIComponent(s);
  const byId = id => document.getElementById(id);

  function buildURL(path, params){
    const u = new URL(DRF + path);
    Object.entries(params).forEach(([k,v])=>{ if(v!=null && v!=='') u.searchParams.set(k,v); });
    return u.toString();
  }
  function withProxy(url){
    const p = byId('proxy')?.value?.trim();
    if(!p) return url;
    let base = p;
    // 사용자가 ?url= 형태로 끝내지 않아도 동작하도록 보정
    if(!base.includes('?')) base += (base.endsWith('/') ? '' : '/') + '?';
    if(!/\burl=/.test(base)) base += 'url=';
    return base + enc(url);
  }
  function isAuthFailText(txt){ return /사용자인증에 실패하였습니다/.test(txt||''); }
  function publicSearchURL(name){ return 'https://www.law.go.kr/LSW/lsSc.do?menuId=1&query=' + enc(name); }
  function publicLawURL(name){ return 'https://www.law.go.kr/법령/' + enc(name); }

  async function fetchText(url){
    const r = await fetch(withProxy(url));
    const text = await r.text();
    return { ok: r.ok, status: r.status, text, ct: (r.headers.get('content-type')||'') };
  }

  // 이름 정규화(검색용) & 표시용 가공
  function canonName(s){
    return (s||'')
      .replace(/[\s"“”'‘’\[\]\(\)「」]/g,'')
      .replace(/[·ㆍ]/g,'');
  }
  function displayName(s){
    return (s||'').replace(/["“”'‘’\[\]\(\)「」]/g,'').trim();
  }

  /** ===================== 고급 인용 추출 ===================== **/
  const LAW_BASE = `[가-힣A-Za-z0-9·ㆍ\\s]+?법`;
  const LAW_EO   = `(?:시행령|시행규칙)`;
  const LAW_FULL = `(${LAW_BASE}(?: ${LAW_EO})?)`;
  const D   = `\\d+`;
  const MOK = `([가-하])목`;
  const JO  = `제\\s*(${D})(?:\\s*조(?:의\\s*(${D}))?)?`;
  const HANG= `(?:\\s*제?\\s*(${D})\\s*항)?`;
  const HO  = `(?:\\s*제?\\s*(${D})\\s*호)?`;
  const MOKRE = `(?:\\s*(${MOK}))?`;
  const EXPL_RE = new RegExp(`${LAW_FULL}\\s*${JO}${HANG}${HO}${MOKRE}`, 'g');
  const QUOTED_RE = /「\s*([가-힣A-Za-z0-9·ㆍ\s]+?법(?:\s*(?:시행령|시행규칙))?)\s*」\s*제\s*(\d+)\s*조(?:\s*의\s*(\d+))?(?:\s*제?\s*(\d+)\s*항)?(?:\s*제?\s*(\d+)\s*호)?(?:\s*([가-하])\s*목)?/g;
  const CTX_KEY = {
    BASE: /(같은 법|이 법)/g,
    SL: /(동법 시행령|같은 법 시행령|이 영|동 시행령)/g,
    SK: /(동법 시행규칙|같은 법 시행규칙|이 규칙|동 규칙)/g
  };
  const BYEOLPYO_RE = /(?:별표|[별附]표)\s*(\d+)?/g;
  const BUCHIK_RE   = /부칙\s*(\d+)?/g;

  function tokenizeForContext(text){
    return text.replace(/[\u00A0\t\r\n]+/g,' ').split(/(?:[.!?。]|[)\]\}])\s+/);
  }
  function pad6(n){ return String(parseInt(n,10)).padStart(6,'0'); }

  function resolveContextualName(token, lastBase){
    if(CTX_KEY.BASE.test(token)) return lastBase?.법 || null;
    if(CTX_KEY.SL.test(token))   return lastBase?.영 || (lastBase?.법 ? lastBase.법 + '시행령' : null);
    if(CTX_KEY.SK.test(token))   return lastBase?.규 || (lastBase?.법 ? lastBase.법 + '시행규칙' : null);
    return null;
  }
  function pushUnique(seen, arr, obj){
    const key = [obj.lawName, obj.jo||'', obj.joi||'', obj.hang||'', obj.ho||'', obj.mok||'', obj.kind||''].join('|');
    if(seen.has(key)) return; seen.add(key); arr.push(obj);
  }
  function extractCitationsAdvanced(text){
    const tokens = tokenizeForContext(text);
    const cites = [];
    const seen = new Set();
    let ctx = { 법:null, 영:null, 규:null };
    for(const t of tokens){
      // (0) 법령명 단독 → 컨텍스트만 업데이트(표시는 제외)
      let m0; const LAW_NAME_ONLY_RE = new RegExp(LAW_FULL, 'g');
      while((m0 = LAW_NAME_ONLY_RE.exec(t))){
        const rawName = m0[1];
        const disp = displayName(rawName);
        ctx.법 = disp; ctx.영 = disp + '시행령'; ctx.규 = disp + '시행규칙';
      }
      // (1) 따옴표형 인용
      let q; while((q = QUOTED_RE.exec(t))){
        const [raw, rawName, joNum, joUi, hang, ho, mokChar] = q;
        const disp = displayName(rawName);
        pushUnique(seen, cites, { raw, lawName: canonName(disp), disp, jo: pad6(joNum), joi: joUi?pad6(joUi):null, hang: hang?pad6(hang):null, ho: ho?pad6(ho):null, mok: mokChar||null, kind:'article' });
        if(/시행령$/.test(disp)){ ctx.영 = disp; ctx.법 = disp.replace(/시행령$/, ''); }
        else if(/시행규칙$/.test(disp)){ ctx.규 = disp; ctx.법 = disp.replace(/시행규칙$/, ''); }
        else { ctx.법 = disp; ctx.영 = disp + '시행령'; ctx.규 = disp + '시행규칙'; }
      }
      // (2) 명시적 인용
      let m; while((m = EXPL_RE.exec(t))){
        const [raw, rawName, joNum, joUi, hang, ho, mokAll] = m;
        const disp = displayName(rawName);
        pushUnique(seen, cites, { raw, lawName: canonName(disp), disp, jo: joNum?pad6(joNum):null, joi: joUi?pad6(joUi):null, hang: hang?pad6(hang):null, ho: ho?pad6(ho):null, mok: mokAll?mokAll.match(/[가-하]/)?.[0]||null:null, kind:'article' });
        if(/시행령$/.test(disp)){ ctx.영 = disp; ctx.법 = disp.replace(/시행령$/, ''); }
        else if(/시행규칙$/.test(disp)){ ctx.규 = disp; ctx.법 = disp.replace(/시행규칙$/, ''); }
        else { ctx.법 = disp; ctx.영 = disp + '시행령'; ctx.규 = disp + '시행규칙'; }
      }
      // (3) 맥락 참조
      const CTX_RE = new RegExp(`((?:같은 법|이 법|동법 시행령|같은 법 시행령|이 영|동 시행령|동법 시행규칙|같은 법 시행규칙|이 규칙|동 규칙))\\s*${JO}${HANG}${HO}${MOKRE}`, 'g');
      while((m = CTX_RE.exec(t))){
        const [raw, ctxWord, joNum, joUi, hang, ho, mokAll] = m;
        const resolved = resolveContextualName(ctxWord, ctx);
        if(!resolved) continue;
        const disp = displayName(resolved);
        pushUnique(seen, cites, { raw, lawName: canonName(disp), disp, jo: joNum?pad6(joNum):null, joi: joUi?pad6(joUi):null, hang: hang?pad6(hang):null, ho: ho?pad6(ho):null, mok: mokAll?mokAll.match(/[가-하]/)?.[0]||null:null, kind:'article' });
      }
      // (4) 별표/부칙
      let bp; while((bp = BYEOLPYO_RE.exec(t))){
        const target = ctx.법 || ctx.영 || ctx.규; if(!target) continue;
        pushUnique(seen, cites, { raw: bp[0], lawName: canonName(target), disp: displayName(target), kind:'annex', annexNo: bp[1]||null });
      }
      let bc; while((bc = BUCHIK_RE.exec(t))){
        const target = ctx.법 || ctx.영 || ctx.규; if(!target) continue;
        pushUnique(seen, cites, { raw: bc[0], lawName: canonName(target), disp: displayName(target), kind:'supplement', suppNo: bc[1]||null });
      }
    }
    return cites;
  }

  /** ===================== DRF API ===================== **/
  async function searchLawRow(oc, lawNameCanon){
    lastAuthFail = false;
    const url = buildURL('/lawSearch.do', { OC:oc, target:'law', type:'JSON', query:lawNameCanon, display:10 });
    try{
      const { status, text } = await fetchText(url);
      if(isAuthFailText(text) || status===401 || status===403){ lastAuthFail = true; return null; }

      let data = null; try{ data = JSON.parse(text); }catch(e){ /* 일부 환경은 text/html로 내려와도 JSON 문자열 */ }
      const root = (data && data.LawSearch) ? data.LawSearch : data;

      let rows = [];
      if(root && root.law){
        if(Array.isArray(root.law)) rows = root.law;
        else if(typeof root.law === 'object') rows = [root.law];
      }
      if(!rows.length) return null;

      const clean = s => canonName(s||'');
      const exact = rows.find(x => clean(x.법령명한글) === clean(lawNameCanon));
      return (exact || rows[0]);
    }catch(e){
      console.warn('searchLawRow error', e);
    }
    return null;
  }

  function buildLawJoSubURLs(oc,id,item){
    // 다양한 조합을 모두 생성하여 호환성 확보
    const baseParams = { OC: oc, target: 'lawjosub', type: 'HTML', ID: id };
    const makeUrl = (extra) => {
      const u = new URL(DRF + '/lawService.do');
      Object.entries(baseParams).forEach(([k,v])=>u.searchParams.set(k,v));
      Object.entries(extra||{})
        .forEach(([k,v])=>{ if(v!=null && v!=='') u.searchParams.set(k,v); });
      return u.toString();
    };
    const pad = v => v ? String(parseInt(v,10)).padStart(6,'0') : null;
    const raw = v => v ? String(parseInt(v,10)) : null;

    const hasHang = !!item.hang;
    const hasHo   = !!item.ho;

    // 1) 조만 (가장 보수적, 거의 항상 지원)
    const joOnly = {
      pad: makeUrl({ JO: pad(item.jo) }),
      raw: makeUrl({ JO: raw(item.jo) })
    };

    // 2) 조+호 (항이 없는 조문 구조에서 사용)
    const joHo = hasHo ? {
      pad: makeUrl({ JO: pad(item.jo), HO: pad(item.ho) }),
      raw: makeUrl({ JO: raw(item.jo), HO: raw(item.ho) })
    } : null;

    // 3) 조+호 + HANG=000000 (일부 백엔드에서 무항 표현을 요구하는 케이스)
    const joHoHangZero = hasHo ? {
      pad: makeUrl({ JO: pad(item.jo), HANG: '000000', HO: pad(item.ho) })
    } : null;

    // 4) 조+항(+호) — 표준 케이스
    const joHangHo = hasHang ? {
      pad: makeUrl({ JO: pad(item.jo), HANG: pad(item.hang), ...(hasHo?{HO:pad(item.ho)}:{}) }),
      raw: makeUrl({ JO: raw(item.jo), HANG: raw(item.hang), ...(hasHo?{HO:raw(item.ho)}:{}) })
    } : null;

    return { joOnly, joHo, joHoHangZero, joHangHo };
  }

  function buildLawFullHTMLURL(oc,id){
    return buildURL('/lawService.do', { OC:oc, target:'law', type:'HTML', ID:id });
  }

  /** ===================== 렌더링 ===================== **/
  function addFoundItem(el, it){
    const li = document.createElement('li');
    li.innerHTML = `<span class="tag">${it.disp||it.lawName}</span> <span class="monos">${(it.raw||'').trim()}</span>`;
    el.appendChild(li);
  }
  function wrapRender(title, inner){
    return `<div class="render"><div class="hdr"><div>${title}</div></div><div class="body">${inner}</div></div>`;
  }

  async function handleRun(){
    const text    = byId('input').value;
    const foundUl = byId('foundList');
    const resUl   = byId('resList');
    foundUl.innerHTML = ''; resUl.innerHTML = '';

    if(!text.trim()){ alert('본문을 입력해 주세요.'); return; }

    const items = extractCitationsAdvanced(text);
    const filtered = items.filter(it => it.kind==='article' || it.kind==='annex' || it.kind==='supplement');
    if(!filtered.length){
      foundUl.innerHTML = '<li>특정 가능한 법조문 인용을 찾지 못했습니다. (예: "○○법 제3조의2 제1항" 또는 "「○○법」 제2조제1항" 또는 "별표 1")</li>';
      return;
    }
    filtered.forEach(it=> addFoundItem(foundUl, it));

    for(const it of filtered){
      const li = document.createElement('li'); li.className='item';
      li.innerHTML = `<div><b>${it.raw||it.disp||it.lawName}</b> <span class="small">(${it.disp||it.lawName})</span><div class="small">검색 중...</div></div>`;
      resUl.appendChild(li);

      const row = await searchLawRow(OC, it.lawName);
      if(!row){
        const publicSearch = publicSearchURL(it.disp||it.lawName);
        const publicDirect = publicLawURL(it.disp||it.lawName);
        const drfList = buildURL('/lawSearch.do', { OC:OC, target:'law', type:'HTML', query:it.disp||it.lawName, display:10 });
        li.innerHTML = `<div><b>${it.raw||it.disp||it.lawName}</b> <span class="small">(${it.disp||it.lawName})</span></div>
          <div class="small">${ lastAuthFail ? 'API 인증 실패(OC 만료/오입력 가능). 퍼블릭 링크를 제공합니다.' : '법령ID 검색 실패(CORS/무일치). 퍼블릭 링크를 제공합니다.' }</div>
          <div>• 퍼블릭 검색: <a target="_blank" rel="noopener" href="${publicSearch}">국가법령정보(사이트) 검색</a></div>
          <div>• 법령 페이지(추정): <a target="_blank" rel="noopener" href="${publicDirect}">${it.disp||it.lawName}</a></div>
          <div class="small">(참고) DRF 목록: <a target="_blank" rel="noopener" href="${drfList}">lawSearch</a></div>`;
        continue;
      }

      const lawId = row.법령ID || row.id || '';
      const lsiSeq = row.법령일련번호 || '';
      const serviceLink = row.법령상세링크 ? ('https://www.law.go.kr' + row.법령상세링크) : '';
      const humanSite = publicLawURL(it.disp||it.lawName);

      if(it.kind==='article'){
        const urls = buildLawJoSubURLs(OC, lawId, it);
        const tryUrlsArr = [];
        if(urls.joHangHo){ if(urls.joHangHo.pad) tryUrlsArr.push(urls.joHangHo.pad); if(urls.joHangHo.raw) tryUrlsArr.push(urls.joHangHo.raw); }
        if(urls.joHoHangZero){ if(urls.joHoHangZero.pad) tryUrlsArr.push(urls.joHoHangZero.pad); }
        if(urls.joHo){ if(urls.joHo.pad) tryUrlsArr.push(urls.joHo.pad); if(urls.joHo.raw) tryUrlsArr.push(urls.joHo.raw); }
        if(urls.joOnly){ if(urls.joOnly.pad) tryUrlsArr.push(urls.joOnly.pad); if(urls.joOnly.raw) tryUrlsArr.push(urls.joOnly.raw); }
        let rendered = '';
        try{
          if(byId('proxy').value.trim()){
            const tryList = [];
            const noHangHasHo = (!it.hang && !!it.ho);
            // 우선순위: (항 없음 & 호 있음) => HANG=000000 먼저 시도
            if(urls.joHangHo){ tryList.push(urls.joHangHo.pad, urls.joHangHo.raw); }
            if(noHangHasHo && urls.joHoHangZero){ tryList.push(urls.joHoHangZero.pad); }
            if(urls.joHo){ tryList.push(urls.joHo.pad, urls.joHo.raw); }
            if(urls.joOnly){ tryList.push(urls.joOnly.pad, urls.joOnly.raw); }
            for(const u of tryList.filter(Boolean)){
              const html = (await fetchText(u)).text;
              if(html && html.length>60){ rendered = wrapRender(`${it.disp||it.lawName} · ${it.raw}`, html); break; }
            }
          }
        }catch(e){ console.warn('render fail', e); }

        // 링크 세트 출력
        const links = [];
        const noHangHasHo = (!it.hang && !!it.ho);
        if(noHangHasHo && urls.joHoHangZero){ links.push(`• API(권장·조+호+HANG=000000): <a title=\"항이 없는 조문에서 호만 있는 경우 권장\" target=\"_blank\" rel=\"noopener\" href=\"${urls.joHoHangZero.pad}\">HTML</a>`); }
        if(urls.joHo){ links.push(`• API(조+호, 0패딩/RAW): <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joHo.pad}\">HTML</a> | <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joHo.raw}\">RAW</a>`); }
        if(urls.joHangHo){ links.push(`• API(조+항${it.ho?'+호':''}, 0패딩): <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joHangHo.pad}\">lawjosub(HTML)</a>${urls.joHangHo.raw?` | <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joHangHo.raw}\">RAW</a>`:''}`); }
        if(urls.joOnly){ links.push(`• API(조만, 0패딩/RAW): <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joOnly.pad}\">HTML</a> | <a target=\"_blank\" rel=\"noopener\" href=\"${urls.joOnly.raw}\">RAW</a>`); }

        li.innerHTML = `<div><b>${it.raw}</b> <span class=\"small\">(${it.disp||it.lawName})</span></div>
          <div class=\"small\">법령ID: ${lawId}${lsiSeq ? ` · 일련번호(lsiSeq): ${lsiSeq}`:''}</div>
          ${links.map(l=>`<div>${l}</div>`).join('')}
          <div>• 로컬: <a href="#" onclick="openLocalFullWithScroll({lawId: '${lawId}', title: '${(it.disp||it.lawName)}', tryUrls: ${JSON.stringify(tryUrlsArr)}, jo:'${it.jo||''}', joi:'${it.joi||''}', hang:'${it.hang||''}', ho:'${it.ho||''}'}); return false;">전체(스크롤/하이라이트)</a> <span class="small">(프록시 필요)</span></div>
          <div>• 원문: <a target=\"_blank\" rel=\"noopener\" href=\"${humanSite}\">사이트 상세(현행)</a>${serviceLink?` · <a target=\"_blank\" rel=\"noopener\" href=\"${serviceLink}\">DRF 상세링크</a>`:''}</div>
          ${rendered||''}`;
      } else {
        const fullURL = buildLawFullHTMLURL(OC, lawId);
        const label = it.kind==='annex' ? `별표 ${it.annexNo||''}` : (it.kind==='supplement' ? `부칙 ${it.suppNo||''}` : '전체 본문');
        let rendered = '';
        try{
          if(byId('proxy').value.trim()){
            const html = (await fetchText(fullURL)).text;
            if(html && html.length>120){
              if(it.kind==='annex'){
                const idx = html.indexOf('별표'); if(idx>=0){ rendered = wrapRender(`${it.disp||it.lawName} · ${label}`, html.substring(Math.max(0,idx-400), Math.min(html.length, idx+1200))); }
              }else if(it.kind==='supplement'){
                const idx2 = html.indexOf('부칙'); if(idx2>=0){ rendered = wrapRender(`${it.disp||it.lawName} · ${label}`, html.substring(Math.max(0,idx2-400), Math.min(html.length, idx2+1200))); }
              }else{
                rendered = wrapRender(`${it.disp||it.lawName} · 전체 본문`, html.substring(0,2000));
              }
            }
          }
        }catch(e){ console.warn('render2 fail', e); }

        li.innerHTML = `<div><b>${label||it.disp||it.lawName}</b> <span class="small">(${it.disp||it.lawName})</span></div>
          <div class="small">법령ID: ${lawId}${lsiSeq ? ` · 일련번호(lsiSeq): ${lsiSeq}`:''}</div>
          <div>• 전체 본문: <a target="_blank" rel="noopener" href="${fullURL}">law(HTML)</a> | 원문: <a target="_blank" rel="noopener" href="${humanSite}">사이트 상세(현행)</a>${serviceLink?` · <a target="_blank" rel="noopener" href="${serviceLink}">DRF 상세링크</a>`:''}</div>
          ${rendered||''}`;
      }
    }
  }

  /** ===================== 바인딩 ===================== **/
  document.addEventListener('DOMContentLoaded', function(){
    const runBtn   = byId('run');
    const clearBtn = byId('clear');
    const testsBtn = byId('runTests');
    if(runBtn)   runBtn.addEventListener('click', handleRun);
    if(clearBtn) clearBtn.addEventListener('click', ()=>{ byId('foundList').innerHTML=''; byId('resList').innerHTML=''; });
    if(testsBtn) testsBtn.addEventListener('click', runBuiltInTests);
  });

  /** ===================== 내장 테스트 ===================== **/
  function expect(name, cond){ return (cond?`✅ <span class="pass">PASS</span>`:`❌ <span class="fail">FAIL</span>`) + ` — ${name}`; }
  function runBuiltInTests(){
    const out = byId('testOutput');

    // 기본 샘플 (기존 테스트 유지)
    const sample = [
      '사립학교법',
      '「유아교육법」 제2조제2호, 「초·중등교육법」 제2조 및 「고등교육법」 제2조를 따른다.',
      '같은 법 시행령 제9조의2 제1항을 적용한다.',
      '또한 별표 1과 부칙 1을 참고한다.'
    ].join(' ');
    const citesAll = extractCitationsAdvanced(sample);
    const cites = citesAll.filter(it=> it.kind==='article' || it.kind==='annex' || it.kind==='supplement');

    const nm = s => canonName(s);
    const noLawOnly = cites.every(c=> c.kind!=='lawOnly');
    const hasU = cites.some(c=> nm(c.lawName)==='유아교육법' && c.ho==='000002');
    const hasC = cites.some(c=> nm(c.lawName)==='초중등교육법' && c.jo==='000002');
    const hasH = cites.some(c=> nm(c.lawName)==='고등교육법' && c.jo==='000002');
    const hasAnnex = cites.some(c=> c.kind==='annex');
    const hasSupp = cites.some(c=> c.kind==='supplement');

    const first3 = cites.slice(0,3).map(x=> nm(x.lawName)).join(',');
    const orderOk = first3 === '유아교육법,초중등교육법,고등교육법';

    const noise = '학교법인, 공공단체 외의 법, 일반적 의미의 사립학교법 등의 용어가 쓰였으나 특정 조항 없음.';
    const noiseOut = extractCitationsAdvanced(noise).filter(it=> it.kind==='article' || it.kind==='annex' || it.kind==='supplement');

    // 추가 샘플 1: 항 없이 호만 있는 구조(조+호)
    const s2 = '「전기공사업법」 제2조제1호에 따른다.';
    const c2 = extractCitationsAdvanced(s2).find(x=> x.kind==='article');
    const t2_1 = !!c2 && nm(c2.lawName)==='전기공사업법';
    const t2_2 = !!c2 && c2.jo==='000002' && !c2.hang && c2.ho==='000001';

    // 추가 샘플 2: 같은 법 시행령 맥락, 조의/항 표시
    const s3 = '「초·중등교육법」 제2조. 같은 법 시행령 제9조의2 제1항.';
    const c3 = extractCitationsAdvanced(s3).filter(x=> x.kind==='article');
    const hasSL = c3.some(x=> nm(x.lawName)==='초중등교육법시행령' && x.jo==='000009' && x.joi==='000002' && x.hang==='000001');

    // 추가 샘플 3: 별표 인식(컨텍스트)
    const s4 = '초·중등교육법 별표 1';
    const c4 = extractCitationsAdvanced(s4).find(x=> x.kind==='annex');
    const t4_1 = !!c4 && nm(c4.lawName)==='초중등교육법';

    out.innerHTML = [
      '<b>기본 테스트</b>',
      expect('법령명 단독은 제외(no lawOnly)', noLawOnly),
      expect('유아교육법 제2조제2호 포함', hasU),
      expect('초·중등교육법 제2조 포함', hasC),
      expect('고등교육법 제2조 포함', hasH),
      expect('별표 인식', hasAnnex),
      expect('부칙 인식', hasSupp),
      expect('등장 순서 유지(유아→초중등→고등)', orderOk),
      expect('노이즈 텍스트에서 아무 것도 추출하지 않음', noiseOut.length===0),
      `<div class=\"small\">총 추출 수(필터 후): ${cites.length}</div>`,
      '',
      '<b>추가 테스트</b>',
      expect('전기공사업법 — 법령명 매칭', t2_1),
      expect('전기공사업법 — 조만/호 파싱(항 없음)', t2_2),
      expect('같은 법 시행령 — 조의/항 파싱', hasSL),
      expect('별표 컨텍스트 인식', t4_1)
    ].join('<br/>');

    byId('input').value = sample;
  }
})();

// ===== 로컬 전체(스크롤/하이라이트) 지원 함수 =====
function collapseSpaces(s){
  if(!s) return '';
  var out='', sp=false;
  for(var i=0;i<s.length;i++){
    var c=s[i];
    if(c===' ' || c==='\r' || c==='\n' || c==='\t'){
      if(!sp){ out+=' '; sp=true; }
    }else{
      out+=c;
      sp=false;
    }
  }
  return out.trim();
}
function stripHtmlToText(html){ var d=document.createElement('div'); d.innerHTML=html||''; return collapseSpaces(d.textContent||''); }
function findAndMark(container, key){ key = collapseSpaces(key||''); if(!key) return null; if(key.length>80) key=key.slice(0,80); var walker=document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null); var node; while(node=walker.nextNode()){ var t=collapseSpaces(node.nodeValue||''); if(!t) continue; var i=t.indexOf(key); if(i>=0){ var span=document.createElement('mark'); span.className='hl'; span.id='__HIT'; var before=document.createTextNode(t.slice(0,i)); var mid=document.createTextNode(t.slice(i,i+key.length)); var after=document.createTextNode(t.slice(i+key.length)); var p=node.parentNode; if(!p) return null; p.replaceChild(after,node); p.insertBefore(span,after); span.appendChild(mid); p.insertBefore(before,span); return span; } } return null; }
async function openLocalFullWithScroll(opts){ try{ var proxySet=!!(document.getElementById('proxy')&&document.getElementById('proxy').value.trim()); if(!proxySet){ alert('프록시를 입력해야 전체본문을 불러올 수 있습니다.'); return; } var lawId=opts.lawId; var title=opts.title||''; var tryUrls=opts.tryUrls||[]; var snippetHtml=''; for(var i=0;i<tryUrls.length;i++){ try{ var t=(await fetchText(tryUrls[i])).text; if(t&&t.length>60){ snippetHtml=t; break; } }catch(e){} } var keyText=stripHtmlToText(snippetHtml); var fullURL=buildLawFullHTMLURL(OC, lawId); var fullHtml=(await fetchText(fullURL)).text||''; var modal=document.getElementById('viewer'); var body=document.getElementById('viewerBody'); var titleEl=document.getElementById('viewerTitle'); titleEl.textContent=(title||'')+' · 로컬 전체(스크롤)'; body.innerHTML=fullHtml; modal.classList.add('on'); modal.setAttribute('aria-hidden','false'); setTimeout(function(){ var hit=findAndMark(body,keyText); if(!hit){ var mk=function(n){ return String(parseInt(n||'0',10)); }; var jb=(opts.jo?('제'+mk(opts.jo)+'조'):'') + (opts.joi?('의'+mk(opts.joi)):''); hit=findAndMark(body,jb); } if(hit){ hit.scrollIntoView({behavior:'smooth',block:'center'}); } },100); }catch(e){ alert('로컬 뷰어 오류: '+e); } }
</script>
</body>
</html>
