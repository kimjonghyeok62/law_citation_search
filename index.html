<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>법조문 자동 추출·검색 · 단일파일(경량)</title>
<style>
  :root{--bg:#0b1020;--panel:#11172c;--muted:#8492b5;--line:#1f2a49;--accent:#5b8cff;--txt:#e6ecff}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--txt)}
  .wrap{max-width:960px;margin:0 auto;padding:24px}
  h1{font-size:1.35rem;margin:0 0 8px}
  .hint{color:var(--muted);font-size:.95rem;margin-bottom:16px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  textarea{width:100%;min-height:180px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1731;color:#e6ecff}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1731;color:#e6ecff;min-width:260px}
  button{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
  button.secondary{background:#445b9c}
  button:disabled{opacity:.6;cursor:not-allowed}
  .result h2{margin:0 0 8px}
  ol{margin:0;padding-left:20px}
  .k{color:#9fb4ff}
  .small{font-size:.9rem;color:#9aa8ce}
  .item{padding:12px;border-top:1px dashed var(--line)}
  a{color:#9ec1ff}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1731;border:1px solid var(--line);color:#c9d6ff;font-size:.8rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>법조문 자동 추출·검색 · <span class="k">간단 버전</span> <span class="small">(OC=bro3362 · DRF 우선 · 퍼블릭 폴백)</span></h1>
  <div class="hint">본문에서 법령·조문을 찾아 <b>조문 바로가기</b>와 <b>전체 본문</b> 링크만 제공합니다. (같은법/동법 류는 검색하지 않음)</div>

  <div class="grid">
    <div>
      <div class="card">
        <label for="input"><b>본문 입력</b></label>
        <textarea id="input" placeholder="예) 건축법 제22조, 동법시행령 제9조의2 제3항 …"></textarea>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="row"><span class="badge">OC: bro3362 (고정)</span></div>
        <div class="row"><label>프록시</label><input id="proxy" type="text" value="https://law-proxy.hyok96.workers.dev/?url=" /></div>
        <div class="row"><button id="run">추출·검색</button><button class="secondary" id="clear">지우기</button></div>
        <div class="small">• CORS로 본문을 못 읽을 때 프록시가 자동 사용됩니다.</div>
      </div>
    </div>
  </div>

  <div class="card result" id="resBox">
    <h2>검색 결과</h2>
    <ol id="resList"></ol>
  </div>
</div>

<script>
(() => {
  'use strict';

  // ===== DRF 기본 =====
  const DRF = 'https://www.law.go.kr/DRF';
  const OC  = 'bro3362';
  const enc = s => encodeURIComponent(s);
  const pad = (n,w) => String(parseInt(n,10)).padStart(w,'0');
  const getProxyBase = () => (document.getElementById('proxy')?.value?.trim() || 'https://law-proxy.hyok96.workers.dev/?url=');

  const lawIdCache = new Map();      // refinedName → row
  const fullHtmlCache = new Map();   // lawId → HTML

  function buildURL(path, params){
    const u = new URL(DRF + path);
    Object.entries(params).forEach(([k,v])=>{ if(v!=null && v!=='') u.searchParams.set(k,v); });
    return u.toString();
  }
  function withProxy(url, base){
    let b = (base || 'https://law-proxy.hyok96.workers.dev/?url=').trim();
    if(!b.includes('?')) b += (b.endsWith('/') ? '' : '/') + '?';
    if(!/\burl=/.test(b)) b += 'url=';
    return b + encodeURIComponent(url);
  }
  async function fetchTextDirectOrProxy(url, proxyBase, {timeoutMs=5000} = {}){
    const fetchWithTimeout = (u) => {
      const ac = new AbortController();
      const id = setTimeout(()=>ac.abort(), timeoutMs);
      return fetch(u, { signal: ac.signal }).finally(()=>clearTimeout(id));
    };
    try{
      const r = await fetchWithTimeout(url);
      if (r.ok){
        const t = await r.text();
        const ct = r.headers.get('content-type')||'';
        if (ct.includes('json') || t.length>30) return t;
      }
    }catch(_){}
    try{
      const r2 = await fetchWithTimeout(withProxy(url, proxyBase));
      if (r2.ok){
        const t2 = await r2.text();
        const ct2 = r2.headers.get('content-type')||'';
        if (ct2.includes('json') || t2.length>30) return t2;
      }
    }catch(_){}
    return '';
  }
  function isFailPage(html){
    const t = (html||'').replace(/\u00A0/g,' ');
    return /페이지\s*접속에\s*실패하였습니다|사용자인증에\s*실패하였습니다|페이지를\s*찾을\s*수\s*없습니다/.test(t);
  }
  function publicLawURL(name){ return 'https://www.law.go.kr/법령/' + enc(name); }
  function buildLawFullHTMLURL(id){ return buildURL('/lawService.do', { OC, target:'law', type:'HTML', ID:id }); }
  function joTo6(jo, joi){ const head = pad(jo,4); return joi ? head + pad(joi,2) : head + '00'; }
  function buildLawArticleURL(id,{jo,joi,hang,ho,mok}){
    const JO = joTo6(jo, joi);
    const HANG = (hang ? pad(hang,6) : (ho ? '000000' : ''));
    const HO   = (ho ? pad(ho,6) : '');
    const MOK  = (mok ? String(mok).trim().slice(0,1).replace(/[^가-하]/g,'') : '');
    const p = { OC, target:'lawjosub', type:'HTML', ID:id, JO };
    if(HANG) p.HANG = HANG;
    if(HO)   p.HO   = HO;
    if(MOK)  p.MOK  = MOK;
    return buildURL('/lawService.do', p);
  }

  // ===== 이름 정리 =====
  function canonName(s){ return (s||'').replace(/[\s"“”'‘’\[\]\(\)「」]/g,'').replace(/[·ㆍ]/g,''); }
  function displayName(s){ return (s||'').replace(/[\"“”'‘’\[\]\(\)「」]/g,'').trim(); }
  function refineLawName(name){
    let s = (name||'').trim();
    if(!s) return s;
    s = s.replace(/^(?:까지|및|또는|등|관련|관한|따른|에\s*따른|에\s*의한|의)\s+/, '');
    const m = s.match(/^(.*?법(?:률)?)(?:\s*)?(시행령|시행규칙)$/);
    if (m) return (m[1] + ' ' + m[2]).trim(); // 붙여쓴 시행령/규칙 → 분리
    const toks = s.split(/\s+/); let i=-1;
    for(let k=toks.length-1;k>=0;k--){ if(/[법]$/.test(toks[k])){ i=k; break; } }
    if(i>=0){ if(toks[i+1] && /^(시행령|시행규칙)$/.test(toks[i+1])) return (toks[i]+' '+toks[i+1]).trim(); return toks[i]; }
    return s;
  }
  function generateAlternatives(q){
    const s = displayName(q||'').replace(/\s+/g,'').trim();
    const alts = new Set();
    if(/^영유아교육법$/.test(s)) { alts.add('유아교육법'); alts.add('영유아보육법'); }
    if(s) alts.add(s.replace(/[^가-힣A-Za-z0-9]/g,''));
    if(s.includes('교육')) alts.add(s.replace(/교육/g,'보육'));
    if(s.includes('보육')) alts.add(s.replace(/보육/g,'교육'));
    const refined = refineLawName(q); if(refined) alts.add(refined);
    if(q) alts.add(q);
    return [...alts].filter(Boolean);
  }

  // ===== DRF lawSearch (시행령/규칙 우선) =====
  async function searchLawRow(lawQuery, proxyBase){
    const refinedQ = refineLawName(lawQuery||'');
    if(!refinedQ) return null;
    if(lawIdCache.has(refinedQ)) return lawIdCache.get(refinedQ);

    const variants = generateAlternatives(lawQuery);
    const clean = s => canonName(refineLawName(s||''));
    const wantsEO = /(시행령|시행규칙)$/.test(refinedQ) ? refinedQ.match(/(시행령|시행규칙)$/)[1] : '';

    const pickBest = (rows, wantCanon)=>{
      if(!rows||!rows.length) return null;
      if (wantsEO){
        const eoExact = rows.find(x => /시행령|시행규칙/.test(x.법령명한글) && clean(x.법령명한글) === wantCanon);
        if (eoExact) return eoExact;
        const eoSuffix = rows.find(x => (x.법령명한글||'').trim().endsWith(wantsEO));
        if (eoSuffix) return eoSuffix;
      }
      const exact = rows.find(x => clean(x.법령명한글) === wantCanon);
      if(exact) return exact;
      const partial = rows.find(x => {
        const cx = clean(x.법령명한글);
        return cx.includes(wantCanon) || wantCanon.includes(cx);
      });
      return partial || rows[0];
    };

    const tryJson = async (qCanon,qRaw)=>{
      const url = buildURL('/lawSearch.do', { OC, target:'law', type:'JSON', query:qRaw, display:10 });
      const text = await fetchTextDirectOrProxy(url, proxyBase);
      try{
        const data = JSON.parse(text);
        const root = (data && data.LawSearch) ? data.LawSearch : data;
        let rows = [];
        if(root && root.law){ rows = Array.isArray(root.law) ? root.law : [root.law]; }
        return pickBest(rows, qCanon);
      }catch{ return null; }
    };
    const tryXml = async (qCanon,qRaw)=>{
      const url = buildURL('/lawSearch.do', { OC, target:'law', type:'XML', query:qRaw, display:10 });
      const text = await fetchTextDirectOrProxy(url, proxyBase);
      try{
        const dom = new DOMParser().parseFromString(text, 'text/xml');
        const nodes = Array.from(dom.getElementsByTagName('law'));
        const rows = nodes.map(n=>({
          법령명한글: (n.getElementsByTagName('법령명한글')[0]?.textContent||'').trim(),
          법령ID: (n.getElementsByTagName('법령ID')[0]?.textContent||'').trim(),
          법령일련번호: (n.getElementsByTagName('법령일련번호')[0]?.textContent||'').trim(),
          법령상세링크: (n.getElementsByTagName('법령상세링크')[0]?.textContent||'').trim()
        }));
        return pickBest(rows, qCanon);
      }catch{ return null; }
    };
    const tryHtml = async (qCanon,qRaw)=>{
      const url = buildURL('/lawSearch.do', { OC, target:'law', type:'HTML', query:qRaw, display:10 });
      const text = await fetchTextDirectOrProxy(url, proxyBase);
      try{
        const dom = new DOMParser().parseFromString(text, 'text/html');
        const links = Array.from(dom.querySelectorAll('a[href*="ID="]'));
        const rows = links.map(a=>{
          const href=a.getAttribute('href')||'';
          const idMatch=href.match(/ID=([^&]+)/);
          const name=(a.textContent||'').trim();
          return { 법령명한글:name, 법령ID:idMatch?decodeURIComponent(idMatch[1]):'' };
        }).filter(x=>x.법령ID);
        return pickBest(rows, qCanon);
      }catch{ return null; }
    };

    for(const q of variants){
      const canon = clean(q);
      let row = await tryJson(canon,q);
      if(!row) row = await tryXml(canon,q);
      if(!row) row = await tryHtml(canon,q);
      if(row){ lawIdCache.set(refinedQ, row); return row; }
    }
    if (wantsEO){
      const base = refinedQ.replace(/\s*(시행령|시행규칙)$/,'');
      const forced = (base + ' ' + wantsEO).trim();
      const canon2 = clean(forced);
      let row = await tryJson(canon2,forced);
      if(!row) row = await tryXml(canon2,forced);
      if(!row) row = await tryHtml(canon2,forced);
      if(row){ lawIdCache.set(refinedQ, row); return row; }
    }
    return null;
  }

  // ===== 인용 추출 (컨텍스트 토큰 자체는 제외) =====
  const LAW_BASE = `[가-힣A-Za-z0-9·ㆍ\\s]+?(?:법|법률)`;
  const LAW_EO   = `(?:시행령|시행규칙)`;
  const LAW_FULL = `(${LAW_BASE}(?:\\s*${LAW_EO})?)`;
  const D   = `\\d+`;
  const MOK = `([가-하])목`;
  const JO  = `제\\s*(${D})(?:\\s*조(?:의\\s*(${D}))?)?`;
  const HANG= `(?:\\s*제?\\s*(${D})\\s*항)?`;
  const HO  = `(?:\\s*제?\\s*(${D})\\s*호)?`;
  const MOKRE = `(?:\\s*(${MOK}))?`;

  const EXPL_RE = new RegExp(`${LAW_FULL}\\s*${JO}${HANG}${HO}${MOKRE}`, 'g');
  const QUOTED_RE = /「\s*([가-힣A-Za-z0-9·ㆍ\s]+?(?:법|법률)(?:\s*(?:시행령|시행규칙))?)\s*」\s*제\s*(\d+)\s*조(?:\s*의\s*(\d+))?(?:\s*제?\s*(\d+)\s*항)?(?:\s*제?\s*(\d+)\s*호)?(?:\s*([가-하])\s*목)?/g;

  function shouldSkipTokenName(name){
    const n = (name||'').replace(/\s+/g,'');
    return n==='같은법'||n==='동법'||n==='같은법시행령'||n==='동법시행령'||n==='같은법시행규칙'||n==='동법시행규칙';
  }

  function extract(text){
    const list = []; const seen=new Set();
    const tokens = text.replace(/[\u00A0\t\r\n]+/g,' ').split(/(?<=[.!?。]|[)\]}])\s+|\s{2,}/);
    const display = s => (s||'').replace(/[\"“”'‘’\[\]\(\)「」]/g,'').trim();

    for(const t of tokens){
      let m;
      while((m = QUOTED_RE.exec(t))){
        const [raw, nm, jo, joi, hang, ho, mok] = m;
        const name = refineLawName(display(nm));
        if(!name || shouldSkipTokenName(name)) continue;
        const key = [name,jo||'',joi||'',hang||'',ho||'',mok||''].join('|');
        if(seen.has(key)) continue; seen.add(key);
        list.push({ name, jo, joi, hang, ho, mok });
      }
      while((m = EXPL_RE.exec(t))){
        const [raw, nm, jo, joi, hang, ho, mokWrap] = m;
        const name = refineLawName(display(nm));
        if(!name || shouldSkipTokenName(name)) continue;
        const mok = mokWrap ? (mokWrap.match(/[가-하]/)||[])[0] : null;
        const key = [name,jo||'',joi||'',hang||'',ho||'',mok||''].join('|');
        if(seen.has(key)) continue; seen.add(key);
        list.push({ name, jo, joi, hang, ho, mok });
      }
    }
    return list;
  }

  // ===== 렌더 =====
  function appendResult(listEl, {title, lawId, lsiSeq, articleURL, fullURL}){
    const li = document.createElement('li'); li.className='item';
    li.innerHTML = `
      <div><b>${title}</b></div>
      <div class="small">법령ID: ${lawId}${lsiSeq?` · 일련번호: ${lsiSeq}`:''}</div>
      <div>① <a class="go-article" href="${articleURL}" target="_blank" rel="noopener">조문 바로가기</a> · ② <a href="${fullURL}" target="_blank" rel="noopener">전체 본문</a></div>
    `;
    const a = li.querySelector('.go-article');
    a.addEventListener('click', async (e)=>{
      e.preventDefault();
      const url = a.getAttribute('href');
      const html = await fetchTextDirectOrProxy(url, getProxyBase());
      if(html && !isFailPage(html)) window.open(url, '_blank','noopener');
      else window.open(publicLawURL(title.split(' 제')[0]), '_blank','noopener');
    });
    listEl.appendChild(li);
  }

  async function handleRun(){
    const text = document.getElementById('input').value||'';
    const resUl = document.getElementById('resList');
    resUl.innerHTML='';
    if(!text.trim()){ alert('본문을 입력해 주세요.'); return; }

    const cites = extract(text);
    if(!cites.length){ resUl.innerHTML = '<li class="item small">인식 가능한 명시적 법령·조문을 찾지 못했습니다. (같은법/동법은 제외됩니다)</li>'; return; }

    // ID 조회 병렬
    const rows = await Promise.all(cites.map(it => searchLawRow(it.name, getProxyBase())));

    cites.forEach((it, i)=>{
      const row = rows[i];
      if(!row){
        const li = document.createElement('li'); li.className='item small';
        li.innerHTML = `법령ID 검색 실패: <a href="${publicLawURL(it.name)}" target="_blank" rel="noopener">${it.name}</a>`;
        resUl.appendChild(li);
        return;
      }
      const lawId = row.법령ID || '';
      const lsiSeq = row.법령일련번호 || '';
      const title  = `${it.name} 제${parseInt(it.jo,10)}${it.joi?`의${parseInt(it.joi,10)}`:''}조`; // 표시: 조까지만
      const articleURL = buildLawArticleURL(lawId, it);
      const fullURL = buildLawFullHTMLURL(lawId);
      appendResult(resUl, {title, lawId, lsiSeq, articleURL, fullURL});
    });
  }

  function bind(){
    document.getElementById('run')?.addEventListener('click', handleRun);
    document.getElementById('clear')?.addEventListener('click', ()=>{ document.getElementById('resList').innerHTML=''; });
  }

  document.addEventListener('DOMContentLoaded', bind);
})();
</script>
</body>
</html>
